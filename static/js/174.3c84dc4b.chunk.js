"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[174],{558:(t,e,n)=>{n.d(e,{F:()=>m});var s=n(5072),r=n(4913),i=n(6791),a=n(5692),o=n(7880),l=n(4430),c=n(6845),u=n(8722),d=n(9200),h=n(8398),p=n(864);const m=t=>{var e,n;let{runner:m,tst:[g,f,b],cmp:[v,x],out:[y],disabled:k=!1,onLoadTest:w,onSpeedChange:S}=t;const{fs:C,setStatus:j}=(0,c.useContext)(a.r),{filePicker:A,tracking:T}=(0,c.useContext)(u.Il),[I,O]=(0,c.useState)("tst"),M=(0,c.useCallback)((t=>{O(t),T.trackEvent("tab","change",t)}),[T]),P=(0,c.useCallback)((async()=>{try{const e=await A.select(),n=await C.readFile(e);let s;try{s=await C.readFile(e.replace(/\.tst$/,".cmp"))}catch(t){}null===w||void 0===w||w(n,s)}catch(t){console.error(t),j("Failed to load test")}}),[A,j,C]),[L,R]=(0,c.useState)();return(0,c.useEffect)((()=>{R((0,r.B)(v,y))}),[y,v]),(0,p.jsx)(h.s,{className:"_test_panel",header:(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{className:"flex-0",children:(0,p.jsx)(s.cC,{id:"Test"})}),(0,p.jsx)("div",{className:"flex-1",children:m.current&&(0,p.jsx)(i.D,{runner:m.current,onSpeedChange:S})}),(0,p.jsx)("div",{children:(0,p.jsx)("fieldset",{role:"group",children:(0,p.jsx)("button",{onClick:P,children:"\ud83d\udcc2"})})})]}),children:(0,p.jsxs)("div",{role:"tablist",style:{"--tab-count":"3"},children:[(0,p.jsx)("div",{role:"tab",id:"test-tab-tst","aria-controls":"test-tabpanel-tst","aria-selected":"tst"===I,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-tst",value:"tst",checked:"tst"===I,onChange:()=>M("tst")}),"Test Script"]})}),(0,p.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-tst",id:"test-tabpanel-tst",children:(0,p.jsx)(d.M,{value:g,onChange:f,grammar:l.qH.parser,language:"tst",highlight:b,disabled:k})}),(0,p.jsx)("div",{role:"tab",id:"test-tab-cmp","aria-controls":"test-tablpanel-cmp","aria-selected":"cmp"===I,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-cmp",value:"cmp",checked:"cmp"===I,onChange:()=>M("cmp")}),"Compare File"]})}),(0,p.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-cmp",id:"test-tabpanel-cmp",style:{position:"relative"},children:(0,p.jsx)(d.M,{value:v,onChange:x,grammar:o.lA.parser,language:"cmp",disabled:k,lineNumberTransform:t=>""})}),(0,p.jsx)("div",{role:"tab",id:"test-tab-out","aria-controls":"test-tabpanel-out","aria-selected":"out"===I,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-out",value:"out",checked:"out"===I,onChange:()=>M("out")}),"Output File"]})}),(0,p.jsxs)("div",{role:"tabpanel",id:"test-tabpanel-out","aria-labelledby":"test-tab-out",children:[""==y&&(0,p.jsx)("p",{children:"Execute test script to compare output."}),(null!==(e=null===L||void 0===L?void 0:L.failureNum)&&void 0!==e?e:0)>0&&(0,p.jsxs)("p",{children:[null===L||void 0===L?void 0:L.failureNum," failure",1===(null===L||void 0===L?void 0:L.failureNum)?"":"s"]}),(0,p.jsx)(d.M,{value:null!==(n=null===L||void 0===L?void 0:L.text)&&void 0!==n?n:"",onChange:()=>{},language:"",disabled:!0,lineNumberTransform:t=>"",customDecorations:null===L||void 0===L?void 0:L.correctCellSpans.map((t=>({span:t,cssClass:"green"}))).concat(null===L||void 0===L?void 0:L.incorrectCellSpans.map((t=>({span:t,cssClass:"red"}))))})]})]})})}},3478:(t,e,n)=>{n.d(e,{N:()=>l});var s=n(864),r=n(6845),i=n(2869);const a={Enter:128,Backspace:129,ArrowLeft:130,ArrowUp:131,ArrowRight:132,ArrowDown:133,Home:134,End:135,PageUp:136,PageDown:137,Insert:138,Delete:139,Escape:140,F1:141,F2:142,F3:143,F4:144,F5:145,F6:146,F7:147,F8:148,F9:149,F10:150,F11:151,F12:152},o={ArrowLeft:"L-arrow",ArrowUp:"U-arrow",ArrowRight:"R-arrow",ArrowDown:"D-arrow"};const l=t=>{let{keyboard:e,update:n}=t;const[l,c]=(0,r.useState)(!1),[u,d]=(0,r.useState)(""),[h,p]=(0,r.useState)(e.getKey());let m=0;const g=t=>{if(!l)return;d(function(t){return o[t]??t}(t.key));const e=function(t){const e=a[t.key];if(void 0!==e)return e;if(1===t.key.length){const e=t.key.charCodeAt(0);if(e>=32&&e<=126)return e}return 0}(t);e!==m&&(b(e),n?.())},f=t=>{l&&(m=0,e.clearKey(),n?.(),p(e.getKey()),d(""))},b=t=>{0!==t&&(e.setKey(t),p(e.getKey()),m=t)};return(0,r.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",f),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",f)}))),(0,s.jsxs)("div",{className:"flex row align-baseline",children:[(0,s.jsx)("div",{className:"flex-2",children:(0,s.jsx)(i.y,{name:"Key",bits:h})}),(0,s.jsxs)("div",{className:"flex-2",children:["Char: ",u]}),(0,s.jsx)("div",{className:"flex-3",children:(0,s.jsx)("button",{onClick:()=>{c(!l)},children:(l?"Disable":"Enable")+" Keyboard"})})]})}},1062:(t,e,n)=>{n.d(e,{zp:()=>k,ZP:()=>w});var s=n(864),r=n(4089),i=n(6845),a=n(2201),o=n(6699),l=n(6871),c=n(5150),u=n(5554),d=n(5251);var h=n(6604);const p=0,m=1,g=t=>{const[e,n]=(0,i.useState)(t.mode??p),[r,a]=(0,h.i)(t.value),o=()=>{return(0,s.jsx)("span",{style:{cursor:"text",...(t="full",e="inline",void 0===t&&void 0!==d.BM[e]&&(t=e),{..."inline"===e?{display:"inline-block"}:{},width:d.BM[t]??"0"})},onClick:()=>{n(m)},children:r});var t,e},l=(0,i.useCallback)((t=>t?.select()),[]),c=(0,i.useCallback)((e=>{n(p),a(e.value??""),t.onChange(e.value??"")}),[t,n,a]),u=()=>(0,s.jsx)("span",{style:{display:"block",position:"relative"},children:(0,s.jsx)("input",{ref:l,style:{zIndex:"10",position:"absolute",left:"0",marginTop:"-0.375rem",color:"var(--text-color)"},onFocus:t.onFocus,onBlur:t=>{let{target:e}=t;return c(e)},onKeyPress:t=>{let{key:e,target:n}=t;"Enter"===e&&c(n)},type:"text",defaultValue:r})});return(()=>{switch(e){case m:return u();case p:return o();default:return(0,s.jsx)("span",{})}})()};var f=n(5692);function b(t,e,n){const{totalHeight:s,toleranceHeight:r,bufferedItems:i,settings:{itemHeight:a,minIndex:o,maxIndex:l}}=e,c=o+Math.floor((t-r)/a),u=function(t,e,n,s,r){const i=Math.max(0,t,n);return[...r(i,Math.min(e,n+s-1)-i)]}(o,l,c,i,n),d=Math.max((c-o)*a,0);return{scrollTop:t,topPaddingHeight:d,bottomPaddingHeight:Math.max(s-(d+u.length*a),0),data:u}}const v=t=>{const e=(0,i.useRef)(null),{settings:n,startState:r,reducer:a}=(0,i.useMemo)((()=>{const e=function(t){const{minIndex:e=0,maxIndex:n=Number.MAX_SAFE_INTEGER,startIndex:s=0,itemHeight:r=20,count:i=Math.max(n-e,1),tolerance:a=i}=t;return{minIndex:e,maxIndex:n,startIndex:s,itemHeight:r,count:i,tolerance:a}}(t.settings??{}),n=function(t,e){const{minIndex:n,maxIndex:s,startIndex:r,itemHeight:i,count:a,tolerance:o}=t,l=a+2*o,c=Math.max(0,r-o-n),u=a*i,d=Math.max(s-n,1)*i,h=o*i,p=c*i,m={scrollTop:0,settings:t,viewportHeight:u,totalHeight:d,toleranceHeight:h,bufferedItems:l,topPaddingHeight:p,bottomPaddingHeight:d-(p+(u+2*h)),data:[]};return{...m,...b(p+h,m,e)}}(e,t.get),s=(r=t.get,(t,e)=>({...t,...b(e,t,r)}));var r;return{settings:e,reducer:s,startState:n}}),[t.settings,t.get]),[o,l]=(0,i.useReducer)(a,r);(0,i.useEffect)((()=>{null!==e.current&&l(e.current.scrollTop)}),[n,t.row]);const c=(0,i.useCallback)((t=>{t&&(t.scrollTop=e.current?e.current.scrollTop:n.startIndex*n.itemHeight),e.current=t}),[e,n.startIndex,n.itemHeight]),u=o.data.map((e=>(0,s.jsx)("div",{style:{height:`${n.itemHeight}px`},children:t.row(e)},t.rowKey(e))));return(0,s.jsxs)("div",{ref:c,style:{height:`${o.viewportHeight}px`,overflowY:"scroll",overflowAnchor:"none"},className:t.className??"",onScroll:t=>l(t.target.scrollTop),children:[(0,s.jsx)("div",{style:{height:`${o.topPaddingHeight}px`}}),u,(0,s.jsx)("div",{style:{height:`${o.bottomPaddingHeight}px`}})]})},x=t=>{let{memory:e,jmp:n={value:0},highlight:r=-1,editable:a=!1,justifyLeft:o=!1,format:l=c.E_,onChange:u=(()=>{}),onFocus:d=(()=>{})}=t;const h=(0,i.useMemo)((()=>({count:Math.min(e.size,25),maxIndex:e.size,itemHeight:34,startIndex:n.value})),[e.size,n]),p=(0,i.useCallback)(((t,n)=>e.range(t,t+n).map(((e,n)=>[n+t,e]))),[e]),m=(0,i.useCallback)((t=>{let[n,i]=t;return(0,s.jsx)(y,{index:n,value:l(i),size:e.size,editable:a,justifyLeft:o,highlight:n===r,onChange:u,onFocus:d})}),[l,a,r,u]);return(0,s.jsx)(v,{settings:h,get:p,row:m,rowKey:t=>{let[e]=t;return e}})},y=t=>{let{index:e,value:n,size:i,highlight:a=!1,editable:o=!1,justifyLeft:l=!1,onChange:u=(()=>{}),onFocus:d=(()=>{})}=t;return(0,s.jsxs)("div",{style:{display:"flex",height:"100%"},children:[(0,s.jsx)("code",{style:{...(0,r.eP)("none"),...a?{background:"var(--mark-background-color)"}:{},whiteSpace:"pre"},children:i?(0,c.E_)(e).padStart(Math.ceil(Math.log10(i))," "):(0,c.E_)(e)}),(0,s.jsx)("code",{style:{flex:"1",textAlign:l?"left":"right",color:"var(--text-color)",...(0,r.eP)("none"),...a?{background:"var(--mark-background-color)"}:{}},children:o?(0,s.jsx)(g,{value:n,highlight:a,onChange:t=>u(e,t,Number(n)),onFocus:()=>d(e)}):(0,s.jsx)("span",{style:{color:"var(--text-color)"},children:n})})]})},k=t=>{let{name:e="Memory",displayEnabled:n=!0,highlight:r=-1,editable:d=!0,memory:p,format:m="dec",onUpload:g,onChange:b}=t;const[v,y]=(0,h.i)(m),[k,w]=(0,i.useState)(""),[S,C]=(0,i.useState)({value:0}),[j,A]=(0,h.i)(r),[T,I]=(0,i.useState)(0),O=()=>{const t=!isNaN(parseInt(k))&&isFinite(parseInt(k))?Number(k):0;A(t),C({value:t})},M=(0,i.useRef)(null),P=(0,i.useCallback)((()=>{b?.(),M.current?.click()}),[M]),{setStatus:L}=(0,i.useContext)(f.r),R=(0,i.useCallback)((async t=>{if(!t.target.files?.length)return void L("No file selected");const e=t.target.files[0];g?.(e.name);const n=await e.text(),s=e.name.endsWith("hack")?o.$W:e.name.endsWith("asm")?o.eC:o.uC,r=await s(n);p.loadBytes(r),t.target.value="",y(e.name.endsWith("hack")?"bin":e.name.endsWith("asm")?"asm":v),O()}),[]),F=()=>{I(T+1)};return(0,u._W)((()=>{w(""),C({value:0})})),(0,s.jsxs)("article",{className:`panel memory ${e}`,children:[(0,s.jsxs)("header",{children:[(0,s.jsx)("div",{children:e}),(0,s.jsxs)("fieldset",{role:"group",children:[(0,s.jsx)("input",{type:"file",style:{display:"none"},ref:M,onChange:R}),(0,s.jsx)("button",{onClick:P,className:"flex-0","data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"}),(0,s.jsx)("button",{onClick:()=>{p.reset(),b?.(),F()},className:"flex-0","data-tooltip":"Clear","data-placement":"bottom",children:"\ud83c\udd91"}),(0,s.jsx)("input",{style:{width:"4em",height:"100%"},placeholder:"Addr",value:k,onKeyDown:t=>{let{key:e}=t;return"Enter"===e&&O()},onChange:t=>{let{target:{value:e}}=t;return w(e)}}),(0,s.jsx)("button",{onClick:O,className:"flex-0","data-tooltip":"Scroll to address","data-placement":"bottom",children:"\u2935\ufe0f"}),(0,s.jsx)("select",{value:v,onChange:t=>y(t.target.value),children:a.I2.map((t=>(0,s.jsx)("option",{children:t},t)))})]})]}),n?(0,s.jsx)(x,{jmp:S,memory:p,highlight:j,editable:d,justifyLeft:"asm"==v,format:t=>function(t,e){switch(t){case"bin":return(0,c.Ly)(e);case"hex":return(0,c.$v)(e);case"asm":return(0,l.a)(e);default:return(0,c.E_)(e)}}(v,t),onChange:(t,e)=>{p.update(t,e,v??"dec"),b?.(),F()},onFocus:t=>A(t)},T):"Memory display is disabled"]})},w=k},2869:(t,e,n)=>{n.d(e,{y:()=>i});var s=n(864),r=n(5150);const i=t=>{let{name:e,bits:n}=t;return(0,s.jsxs)("div",{children:[e,": ",(0,r.E_)(n)]})}},8963:(t,e,n)=>{n.d(e,{l:()=>c});var s=n(864),r=n(7239),i=n(6845),a=n(5554);const o="white";function l(t,e,n,s){const r=4*(512*n+e),i=s===o?255:0;t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=255}const c=t=>{let{memory:e}=t;const n=(0,i.useRef)(),c=(0,i.useCallback)((()=>{const t=n.current?.getContext("2d")??void 0;t&&function(t,e){const n=(0,r.kP)(t.getImageData(0,0,512,256),"Failed to create Context2d");for(let r=0;r<512;r++)for(let t=0;t<256;t++){const a=(s=r,i=t,0===(e.get(32*i+(s/16|0))&1<<s%16)?o:"black");l(n.data,r,t,a)}var s,i;t.putImageData(n,0,0)}(t,e)}),[e]),u=(0,i.useCallback)((t=>{n.current=t??void 0,c()}),[n,c]);return(0,a.RC)(c),(0,a._W)((()=>{n.current?.getContext("2d")?.clearRect(0,0,n.current.width,n.current.height)})),(0,s.jsxs)("article",{className:"panel",children:[(0,s.jsx)("header",{children:"Screen"}),(0,s.jsx)("main",{style:{backgroundColor:"var(--code-background-color)"},children:(0,s.jsx)("figure",{style:{width:"100%",maxWidth:"512px",boxSizing:"content-box",marginInline:"auto",margin:"auto",borderTop:"2px solid gray",borderLeft:"2px solid gray",borderBottom:"2px solid lightgray",borderRight:"2px solid lightgray"},children:(0,s.jsx)("canvas",{ref:u,width:512,height:256})})})]})}},5554:(t,e,n)=>{n.d(e,{RC:()=>o,_W:()=>l,uY:()=>u});var s=n(864),r=n(6845),i=n(554),a=n(5424);function o(t){(0,r.useEffect)((()=>{const e=a.S.get().frame$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function l(t){(0,r.useEffect)((()=>{const e=a.S.get().reset$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function c(){return(0,i.j)(a.S.get())}const u=()=>{const t=function(){const[t,e]=(0,r.useState)(c());return(0,r.useEffect)((()=>{const t=a.S.get().$.subscribe((()=>{e(c())}));return()=>t.unsubscribe()}),[]),t}();return(0,s.jsx)("span",{style:{whiteSpace:"nowrap"},children:t})}},4913:(t,e,n)=>{n.d(e,{B:()=>o,q:()=>a});var s=n(7054),r=n(7880);function i(t,e){const n=[];for(let s=0;s<Math.min(t.length,e.length);s++){const r=t[s]??[],i=e[s]??[];for(let t=0;t<Math.max(r.length,i.length);t++){const e=r[t]??"",a=i[t]??"";null===e?.trim().match(/^\*+$/)&&a?.trim()!==e?.trim()&&n.push({row:s,col:t,expected:e,given:a})}}return n}function a(t,e){const n=r.lA.parse(t),a=r.lA.parse(e);if((0,s.dZ)(n)||(0,s.dZ)(a))return!1;return 0==i((0,s.Ok)(n),(0,s.Ok)(a)).length}function o(t,e){const n=r.lA.parse(t),a=r.lA.parse(e);if((0,s.dZ)(n)||(0,s.dZ)(a))return{text:"",failureNum:0,correctCellSpans:[],incorrectCellSpans:[]};const o=i((0,s.Ok)(n),(0,s.Ok)(a)),c=new Map;for(const s of o){const t=c.get(s.row);t?t.push(s):c.set(s.row,[s])}const u=e.split("\n"),d=new Map;for(const[s,r]of c)d.set(s,l(u[s],r));const h=[];let p=0;const m=[],g=[];for(let s=0;s<u.length;s++){const t=d.get(s);t?(h.push(t.expectedLine),m.push(...t.correctCellSpans.map((t=>({start:t.start+p,end:t.end+p,line:t.line})))),p+=t.expectedLine.length+1,h.push(t.givenLine),g.push(...t.correctCellSpans.map((t=>({start:t.start+p,end:t.end+p,line:t.line})))),p+=t.givenLine.length+1):(h.push(u[s]),p+=u[s].length+1)}return{text:h.join("\n"),failureNum:o.length,correctCellSpans:m,incorrectCellSpans:g}}function l(t,e){const n=t.split("|").filter((t=>""!=t)),s=n.map((t=>" ".repeat(t.length))),r=[];let i=0;for(let l=0;l<n.length;l++)r.push(i+1),i+=n[l].length+1;const a=[],o=[];for(const l of e){n[l.col]=l.expected,s[l.col]=l.given;const t={start:r[l.col],end:r[l.col]+l.expected.length,line:0};a.push(t),o.push(t)}return{expectedLine:`|${n.join("|")}|`,givenLine:`|${s.join("|")}|`,correctCellSpans:a,incorrectCellSpans:o}}},554:(t,e,n)=>{n.d(e,{j:()=>s});const s=t=>{if((t=>"function"===typeof t?.toString||"string"===typeof t)(t)){const e=t.toString();return"[object Object]"===e?JSON.stringify(t):e}return JSON.stringify(t)}},2369:(t,e,n)=>{n.d(e,{Ff:()=>x,Jx:()=>b,Z9:()=>y,Zu:()=>i,aL:()=>v});var s=n(137),r=n(2201);function i(){return{A:0,D:0,PC:0,ALU:0,flag:s.vU.Zero}}const a=32768,o=36864,l=36864,c=36864,u=4032,d=32800,h=32784,p=32776,m=32769,g=32770,f=32772;function b(t){function e(e){return(t&e)===e}return{c:e(a),x1:e(o),x2:e(l),am:e(c),op:(t&u)>>6,d1:e(d),d2:e(h),d3:e(p),j1:e(m),j2:e(g),j3:e(f)}}function v(t,e){let{inM:n,instruction:r}=t,{A:i,D:a,PC:o}=e;const l=b(r),c=l.am?n:i,[u,d]=(0,s.Bb)(l.op,a,c);return[{A:i,D:a,PC:o+1,ALU:u,flag:d},l.d3]}function x(t,e){let{inM:n,instruction:r,reset:i}=t,{A:a,D:o,PC:l,ALU:c,flag:u}=e;const d=b(r),h=d.j1&&u===s.vU.Positive,p=d.j2&&u===s.vU.Zero,m=d.j3&&u===s.vU.Negative;l=i?0:h||p||m?a:l,d.d2&&(o=c);const g=a;d.c?d.d1&&(a=c):a=32767&r;const f=d.am?n:a,v=(0,s.Bb)(d.op,o,f);c=v[0],u=v[1];return[{addressM:d.d3?g:a,outM:c,writeM:d.d3},{A:a,D:o,ALU:c,flag:u,PC:l}]}class y{RAM;ROM;Screen;Keyboard;#t=0;#e=0;#n=0;#s={A:0,D:0,PC:0,ALU:0,flag:s.vU.Zero};get state(){return this.#s}get PC(){return this.#t}get A(){return this.#e}get D(){return this.#n}setA(t){this.#e=t}setD(t){this.#n=t}setPC(t){this.#t=t}constructor(t){let{RAM:e=new r.FH,ROM:n}=t;this.RAM=e,this.ROM=n,this.Screen=new r.kG(this.RAM,r.yJ,r.GD),this.Keyboard=new r.qT(this.RAM)}reset(){this.#t=0,this.#e=0,this.#n=0}tick(){const[{addressM:t,outM:e,writeM:n},{A:r,D:i,PC:a}]=function(t,e){const[n,s]=v(t,e);return x(t,n)}({inM:this.RAM.get(this.#e),instruction:this.ROM.get(this.#t),reset:!1},{A:this.#e,D:this.#n,PC:this.#t,ALU:this.#n,flag:s.vU.Zero});this.#e=r,this.#n=i,this.#t=a,n&&this.RAM.set(t,e)}}},7880:(t,e,n)=>{n.d(e,{lA:()=>l});var s=n(9814),r=n(3484);const i="\nCmp <: Base {\n  Root := line*\n  line = bar cell+ newline?\n  cell = cellvalue bar\n  cellvalue = (~(bar|newline) any)*\n}",a=s.Z.grammar(i,r.y1),o=a.extendSemantics(r.rJ);o.addAttribute("cell",{cell:(t,e)=>t.sourceString}),o.addAttribute("line",{line:(t,e,n)=>e.children.map((t=>t.cell))}),o.addAttribute("root",{Root:t=>t.children.map((t=>t.line))});const l={grammar:i,semantics:o,parser:a,parse:(0,r.Pz)(a,o)}},4430:(t,e,n)=>{n.d(e,{qH:()=>l});var s=n(9814),r=n(3484);const i='\nTst <: Base {\n  Root := Tst\n  Tst = (TstStatement | TstRepeat | TstWhile)+\n\n  TstRepeat = Repeat Number? OpenBrace TstStatement+ CloseBrace\n  TstWhile = While Condition OpenBrace TstStatement+ CloseBrace\n  TstStatement = List<TstOperation, ","> (Semi | Bang)\n\n  TstOperation =\n    | TstFileOperation\n    | TstOutputListOperation\n    | TstEvalOperation\n    | TstSetOperation\n    | TstOutputOperation\n    | TstEchoOperation\n    | TstClearEchoOperation\n    | TstLoadROMOperation\n\n  TstLoadROMOperation = ROM32K Load FileName\n  TstFileOperation = FileOperation FileName?\n  TstOutputListOperation = "output-list" OutputFormat+\n  OutputFormat = Name Index? FormatSpec?\n  FormatSpec = percent FormatStyle wholeDec dot wholeDec dot wholeDec\n  TstSetOperation = Set Name Index? Number\n  Index = OpenSquare wholeDec? CloseSquare\n  Condition = Value CompareOp Value\n  TstEvalOperation = Eval | TickTock | Tick | Tock | VmStep\n  TstOutputOperation = Output\n  TstEchoOperation = Echo String\n  TstClearEchoOperation = ClearEcho\n\n  FileName = Name\n  FileOperation = "load" | "output-file" | "compare-to"\n\n  Set = "set"\n  Eval = "eval"\n  Tick = "tick"\n  Tock = "tock"\n  TickTock = "ticktock"\n  VmStep = "vmstep"\n  Echo = "echo"\n  Repeat = "repeat"\n  ClearEcho = "clear-echo"\n  Output = "output"\n  OutputList = "output-list"\n  FormatStyle = "B"|"D"|"S"|"X"\n  ROM32K = "ROM32K"\n  Load = "load"\n  While = "while"\n\n  CompareOp = "<>" | "<=" | ">=" | "=" | "<" | ">"\n}',a=s.Z.grammar(i,r.y1),o=a.extendSemantics(r.rJ);o.extendAttribute("value",{Index:(t,e,n)=>e?.child(0)?.value??-1}),o.extendAttribute("name",{FileName(t){let{name:e}=t;return e}}),o.addAttribute("index",{Index:(t,e,n)=>e.child(0)?.value??0}),o.addAttribute("formatSpec",{FormatSpec(t,e,n,s,r,i,a){let{sourceString:o}=e,{value:l}=n,{value:c}=r,{value:u}=a;return{style:o,width:c,lpad:l,rpad:u}}}),o.addAttribute("format",{OutputFormat(t,e,n){let{name:s}=t;return{id:s,builtin:void 0!==e?.child(0),address:e?.child(0)?.value??-1,format:n?.child(0)?.formatSpec}}}),o.addAttribute("operation",{TstEvalOperation:t=>({op:t.sourceString}),TstOutputOperation:t=>({op:"output"}),TstOutputListOperation:(t,e)=>({op:"output-list",spec:e.children.map((t=>t.format))}),TstSetOperation(t,e,n,s){let{name:r}=e,{value:i}=s;const a={op:"set",id:r,value:i},o=n.child(0)?.child(1)?.child(0);return o&&(a.index=o.value),a},TstEchoOperation:(t,e)=>({op:"echo",message:e.String}),TstClearEchoOperation:t=>({op:"clear-echo"}),TstLoadROMOperation(t,e,n){let{name:s}=n;return{op:"loadRom",file:s}},TstFileOperation:(t,e)=>({op:t.sourceString,file:e?.sourceString})}),o.addAttribute("condition",{Condition(t,e,n){let{value:s}=t,{sourceString:r}=e,{value:i}=n;return{left:s,right:i,op:r}}}),o.addAttribute("statement",{TstWhile(t,e,n,s,i){return{statements:s.children.map((t=>{let{statement:e}=t;return e})),condition:e.condition,span:(0,r.yP)(this.source)}},TstRepeat(t,e,n,s,i){return{statements:s.children.map((t=>{let{statement:e}=t;return e})),count:e.sourceString?Number(e.sourceString):-1,span:(0,r.yP)(this.source)}},TstStatement(t,e){const n={ops:t.asIteration().children.map((t=>t.operation)),span:(0,r.yP)(this.source)};return"!"===e.sourceString&&(n.break=!0),n}}),o.addAttribute("tst",{Tst:t=>({lines:t.children.map((t=>t.statement))})}),o.addAttribute("root",{Root(t){let{tst:e}=t;return e}});const l={grammar:i,semantics:o,parser:a,parse:(0,r.Pz)(a,o)}},7353:(t,e,n)=>{n.d(e,{h:()=>A});var s=n(7239),r=n(2836);class i{variable;value;index;constructor(t,e,n){this.variable=t,this.value=e,this.index=n}do(t){t.setVar(this.variable,this.value,this.index)}*steps(){yield this}}class a{do(t){t.output()}*steps(){yield this}}class o{outputs=[];constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const e of t)this.addOutput(e)}addOutput(t){this.outputs.push({id:t.id,style:t.format?.style??"B",len:t.format?.width??-1,lpad:t.format?.lpad??1,rpad:t.format?.rpad??1,builtin:t.builtin,address:t.address})}do(t){t.outputList(this.outputs),t.header()}*steps(){yield this}}class l{instructions=[];span;addInstruction(t){this.instructions.push(t)}do(t){for(const e of this.instructions)e.do(t)}*steps(t){yield this}}class c extends l{repeat;constructor(t){super(),this.repeat=t}do(){}*innerSteps(t){for(const e of this.instructions)yield*e.steps(t)}*steps(t){if(-1===this.repeat)for(yield this;;)yield*this.innerSteps(t);else for(let e=0;e<this.repeat;e++)yield this,yield*this.innerSteps(t)}}class u{x;y;op;constructor(t,e,n){this.x=t,this.y=e,this.op=n}check(t){const e=t.hasVar(this.x)?t.getVar(this.x):this.x,n=t.hasVar(this.y)?t.getVar(this.y):this.y;if("string"===typeof e||"string"===typeof n)switch(this.op){case"=":return`${e}`===`${n}`;case"<>":return`${e}`!==`${n}`}else switch(this.op){case"<":return e<n;case"<=":return e<=n;case">":return e>n;case">=":return e>=n;case"=":return e===n;case"<>":return e!==n}return!1}}class d extends l{condition;constructor(t){super(),this.condition=t}*steps(t){for(;this.condition.check(t);){yield this;for(const e of this.instructions)yield*e.steps(t)}}}class h{content;constructor(t){this.content=t}do(t){t.echo(this.content)}*steps(){yield this}}class p{do(t){t.clearEcho()}*steps(){yield this}}class m{file;constructor(t){this.file=t}async do(t){t.fs.pushd("/samples"),await t.load(this.file),t.fs.popd()}*steps(){yield this}}n(2201);var g=n(9814),f=n(3484);const b='\nVm <: Base {\n  Root := Vm\n\n  Vm = VmInstruction*\n\n  VmInstruction =\n    | StackInstruction\n    | OpInstruction\n    | FunctionInstruction\n    | CallInstruction\n    | ReturnInstruction\n    | GotoInstruction\n    | LabelInstruction\n  \n  StackInstruction = (Push | Pop) MemorySegment Number\n  OpInstruction = Add | Sub | Neg | Lt | Gt | Eq | And | Or | Not\n  FunctionInstruction = Function Name Number \n  CallInstruction =  Call Name Number\n  ReturnInstruction = Return\n  LabelInstruction = Label Name\n  GotoInstruction = (Goto | IfGoto) Name\n\n  MemorySegment = Argument | Local | Static | Constant | This | That | Pointer | Temp\n\n  Push = "push"\n  Pop = "pop"\n  Function = "function"\n  Call = "call"\n  Return = "return"\n  Goto = "goto"\n  IfGoto = "if-goto"\n  Label = "label"\n\n  Argument = "argument"\n  Local = "local"\n  Static = "static"\n  Constant = "constant"\n  This = "this"\n  That = "that"\n  Pointer = "pointer"\n  Temp = "temp"\n\n  Add = "add" \n  Sub = "sub" \n  Neg = "neg" \n  Eq = "eq"\n  Lt = "lt" \n  Gt = "gt" \n  And = "and" \n  Or = "or" \n  Not = "not"\n}',v=g.Z.grammar(b,f.y1),x=v.extendSemantics(f.rJ);x.addAttribute("op",{Push:t=>"push",Pop:t=>"pop",Function:t=>"function",Call:t=>"call",Return:t=>"return",Goto:t=>"goto",IfGoto:t=>"if-goto",Label:t=>"label",Add:t=>"add",Sub:t=>"sub",Neg:t=>"neg",Eq:t=>"eq",Lt:t=>"lt",Gt:t=>"gt",And:t=>"and",Or:t=>"or",Not:t=>"not"}),x.addAttribute("segment",{Argument:t=>"argument",Local:t=>"local",Static:t=>"static",Constant:t=>"constant",This:t=>"this",That:t=>"that",Pointer:t=>"pointer",Temp:t=>"temp"}),x.addAttribute("instruction",{StackInstruction(t,e,n){let{op:s}=t,{segment:r}=e,{value:i}=n;return{op:s,segment:r,offset:i}},OpInstruction(t){let{op:e}=t;return{op:e}},FunctionInstruction(t,e,n){let{name:s}=e,{value:r}=n;return{op:"function",name:s,nVars:r}},CallInstruction(t,e,n){let{name:s}=e,{value:r}=n;return{op:"call",name:s,nArgs:r}},ReturnInstruction:t=>({op:"return"}),LabelInstruction(t,e){let{name:n}=e;return{op:"label",label:n}},GotoInstruction(t,e){let{op:n}=t,{name:s}=e;return{op:n,label:s}}}),x.addAttribute("vm",{Vm:t=>({instructions:t.children.map((t=>t.instruction))})}),x.addAttribute("root",{Root(t){let{vm:e}=t;return e}});(0,f.Pz)(v,x);class y{_vmTestInstruction_=!0;do(t){t.vmstep()}*steps(){yield this}}var k=n(1003);function w(t){return void 0!==t.ops}function S(t){return void 0!==t.condition}function C(t){const e=new l;e.span=t.span;for(const n of t.ops){const t=j(n);void 0!==t&&e.addInstruction(t)}return e}function j(t){const{op:e}=t;switch(e){case"tick":return new r.oK;case"tock":return new r.mL;case"ticktock":return new k.r;case"eval":return new r.Mb;case"vmstep":return new y;case"output":return new a;case"set":return new i(t.id,t.value,t.index);case"output-list":return new o(t.spec);case"echo":return new h(t.message);case"clear-echo":return new p;case"loadRom":return new m(t.file);case"load":case"output-file":case"compare-to":return;default:(0,s.qV)(e,`Unknown tst operation ${e}`)}}function A(t,e){for(const n of e.lines)if(w(n))t.addInstruction(C(n));else{const e=S(n)?new d(new u(n.condition.left,n.condition.right,n.condition.op)):new c(n.count);e.span=n.span,t.addInstruction(e);for(const t of n.statements)e.addInstruction(C(t))}return t.reset(),t}},2836:(t,e,n)=>{n.d(e,{Mb:()=>l,l1:()=>o,mL:()=>u,oK:()=>c});var s=n(5524),r=n(5424),i=n(7353),a=n(8186);class o extends a.e{chip=new s.P9;get chipId(){return this.chip.id}clock=r.S.get();static from(t){const e=new o;return(0,i.h)(e,t)}with(t){return this.chip=t,this}hasVar(t){return"time"===t||(t=`${t}`,this.chip.hasIn(t)||this.chip.hasOut(t))}getVar(t,e){if("time"===(t=`${t}`))return this.clock.toString();const n=this.chip.get(t,e);return n?n instanceof s.Gc?n.busVoltage:n.voltage():0}getWidth(t,e){const n=this.chip.get(t,e);return n?n.width:0}setVar(t,e,n){const r=this.chip.get(t,n);r instanceof s.Gc?r.busVoltage=e:r?.pull(0===e?s.yE:s.lj)}eval(){this.chip.eval()}tick(){this.chip.eval(),this.clock.tick()}tock(){this.chip.eval(),this.clock.tock()}async load(t){await this.chip.load(this.fs,t)}async run(){this.clock.reset(),await super.run()}}class l{_chipTestInstruction_=!0;do(t){t.eval()}*steps(){yield this}}class c{_chipTestInstruction_=!0;do(t){t.tick()}*steps(){yield this}}class u{_chipTestInstruction_=!0;do(t){t.tock()}*steps(){yield this}}},1003:(t,e,n)=>{n.d(e,{o:()=>o,r:()=>l});var s=n(2201),r=n(2369),i=n(8186),a=n(7353);class o extends i.e{cpu;ticks=0;static from(t,e){const n=new o(e);return(0,a.h)(n,t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new s.eD(new Int16Array);super(),this.cpu=new r.Z9({ROM:t}),this.reset()}reset(){return super.reset(),this.cpu.reset(),this.ticks=0,this}hasVar(t){return"number"!==typeof t&&!("A"!==t&&"D"!==t&&"PC"!==t&&"time"!==t&&!t.startsWith("RAM"))}getVar(t,e){switch(t){case"A":return this.cpu.A;case"D":return this.cpu.D;case"PC":return this.cpu.PC;case"time":return this.ticks;case"RAM":return void 0===e?0:this.cpu.RAM.get(e)}if("number"===typeof t)return 0;if(t.startsWith("RAM")){const e=Number(t.substring(4,t.length-1));return this.cpu.RAM.get(e)}return 0}getWidth(t,e){return 16}setVar(t,e,n){switch(t){case"A":this.cpu.setA(e);break;case"D":this.cpu.setD(e);break;case"PC":this.cpu.setPC(e);break;case"RAM":this.cpu.RAM.set(n??0,e)}}ticktock(){this.ticks+=1,this.cpu.tick()}async load(t){await this.cpu.ROM.load(this.fs,t)}}class l{_cpuTestInstruction_=!0;do(t){t.ticktock()}*steps(){yield this}}},8186:(t,e,n)=>{n.d(e,{e:()=>o});var s=n(7239),r=n(2608),i=n(5150);class a{variable;fmt;lPad;rPad;len;index;builtin;constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"%B1.1.1",n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;if(this.variable=t,e.startsWith("%")&&void 0===n&&void 0===r&&void 0===i){const{fmt:t,lPad:n,rPad:s,len:r}=e.match(/^%(?<fmt>[BDXS])(?<lPad>\d+)\.(?<len>\d+)\.(?<rPad>\d+)$/)?.groups;this.fmt=t,this.lPad=parseInt(n),this.rPad=parseInt(s),this.len=parseInt(r),this.builtin=!1,this.index=-1}else(0,s.hu)(["B","X","D","S"].includes(e[0])),this.fmt=e[0],this.len=n??3,this.lPad=r??1,this.rPad=i??1,this.builtin=a??!1,this.index=o??-1}header(t){let e=`${this.variable}`;if(this.builtin){e=`${e}[${this.index>=0?this.index:""}]`}return e.length>this.len+this.lPad+this.rPad?e.substring(0,this.len+this.lPad+this.rPad):this.padCenter(e)}print(t){const e=t.getVar(this.variable,this.index);if("S"===this.fmt)return this.padLeft(e);const n=(0,{B:i.Ly,D:i.E_,X:i.$v}[this.fmt])(e);return"D"===this.fmt?this.padRight(n):this.padCenter(n.slice(n.length-this.len))}padCenter(t){const e=this.lPad+this.len+this.rPad,n=Math.floor((e-t.length)/2),s=e-n-t.length,r=n+t.length,i=r+s;return t=(t=t.padStart(r)).padEnd(i)}padLeft(t){t=t.substring(0,this.len);const e=this.rPad+this.len,n=this.lPad+e;return t=(t=t.padEnd(e)).padStart(n)}padRight(t){t=t.substring(0,this.len);const e=this.lPad+this.len,n=this.rPad+e;return t=(t=t.padStart(e)).padEnd(n)}}class o{instructions=[];_outputList=[];_log="";fs=new r.Wd;setFileSystem(t){return this.fs=t,this}echo(t){}clearEcho(){}async load(t){}async compareTo(t){}outputFile(t){}createOutputs(t){return t.map((t=>{if(-1===t.len)if("time"===t.id)t.len=7,t.style="S";else{const e=this.getWidth(t.id,t.address);"B"===t.style?t.len=e:"D"===t.style?t.len=Math.ceil(Math.log(e)):"X"===t.style&&(t.len=Math.ceil(e/4))}return new a(t.id,t.style,t.len,t.lpad,t.rpad,t.builtin,t.address)}))}outputList(t){this._outputList=this.createOutputs(t)}addInstruction(t){this.instructions.push(t)}reset(){return this._steps=function*(t){for(const e of t.instructions)yield*e.steps(t)}(this),this._step=this._steps.next(),this._log="",this}_steps;_step;get steps(){return void 0===this._steps&&(this.reset(),this._steps=(0,s.kP)(this._steps,"Reset did not initialize steps"),this._step=(0,s.kP)(this._step,"Reset did not find first step")),this._steps}get currentStep(){return this._step?.value}get done(){return this._step?.done??!1}step(){return!!this._step.done||(this._step.value.do(this),this._step=this.steps.next(),!1)}async run(){for(this.reset();!await this.step(););}breakpoints=new Map;addBreakpoint(t,e){this.breakpoints.set(t,e)}clearBreakpoints(){this.breakpoints.clear()}output(){const t=this._outputList.map((t=>t.print(this)));this._log+=`|${t.join("|")}|\n`}header(){const t=this._outputList.map((t=>t.header(this)));this._log+=`|${t.join("|")}|\n`}log(){return this._log}}}}]);
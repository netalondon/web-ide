"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[547],{8815:(e,t,n)=>{n.r(t),n.d(t,{VMInstructionRow:()=>N,VMStackFrame:()=>A,default:()=>L});var s=n(5072),i=n(1058),r=n(3478),a=n(3577),o=n(8963),c=n(6604),l=n(5692),d=n(7054);var u=n(2201),h=n(4430),g=n(8637),m=n(4388),p=n(5920),f=n(6845),x=n(4913),j=n(5969);function v(e,t){const n=new j.j(e.vm.RAM,t),s=new j.j(e.vm.Screen,t),i=new u.qT(new j.j(e.vm.RAM,t)),r=e.vm.derivedLine();return{Keyboard:i,RAM:n,Screen:s,Stack:e.vm.vmStack().reverse(),Prog:e.vm.program,highlight:r}}function _(){const{fs:e,setStatus:t,storage:n}=(0,f.useContext)(l.r),s=(0,f.useRef)((()=>{})),{initialState:i,reducers:r,actions:a}=(0,f.useMemo)((()=>function(e,t,n,s){const i=(0,d.Wg)(g.VM.parse("\nfunction Main.fibonacci 0\npush argument 0\npush constant 2\nlt                     // checks if n<2\nif-goto IF_TRUE\ngoto IF_FALSE\nlabel IF_TRUE          // if n<2, return n\npush argument 0        \nreturn\nlabel IF_FALSE         // if n>=2, returns fib(n-2)+fib(n-1)\npush argument 0\npush constant 2\nsub\ncall Main.fibonacci 1  // computes fib(n-2)\npush argument 0\npush constant 1\nsub\ncall Main.fibonacci 1  // computes fib(n-1)\nadd                    // returns fib(n-1) + fib(n-2)\nreturn\n\nfunction Sys.init 0\npush constant 4\ncall Main.fibonacci 1   // computes the 4'th fibonacci element\nlabel WHILE\ngoto WHILE              // loops infinitely\n"));let r=(0,d.Wg)(p.Vm.build(i.instructions)),a=(new m.w).with(r),o=!1,c=!0;const l={setTst(e,t){let{tst:n,cmp:s}=t;e.files.tst=n,e.files.cmp=s??""},setExitCode(e,t){e.controls.exitCode=t,console.log("exit code",t)},setValid(e,t){e.controls.valid=t},update(e){e.vm=v(a,s),e.test.useTest=o,e.test.highlight=a.currentStep?.span},setAnimate(e,t){e.controls.animate=t},testStep(e){e.files.out=a.log()},testFinished(e){const n=(0,x.q)(e.files.cmp.trim(),e.files.out);t(n?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}},u={loadVm(e){const n=[];for(const s of e){const e=g.VM.parse(s.content);if((0,d.dZ)(e))return t(`Parse error: ${e.err.message}`),!1;n.push({name:s.name,instructions:(0,d.Wg)(e).instructions})}const i=p.Vm.buildFromFiles(n);return(0,d.dZ)(i)?(t(`Build Error: ${i.err.message}`),!1):(r=(0,d.Wg)(i),a.vm=r,a.reset(),s.current({action:"update"}),!0)},loadTest(e,n){s.current({action:"setTst",payload:{tst:e,cmp:n}});const i=h.qH.parse(e);return(0,d.dZ)(i)?(s.current({action:"setValid",payload:!1}),t("Failed to parse test"),!1):(s.current({action:"setValid",payload:!0}),t("Parsed tst"),r.reset(),a=m.w.from((0,d.Wg)(i)),a.vm=r,s.current({action:"update"}),!0)},setAnimate(e){c=e,s.current({action:"setAnimate",payload:e})},step(){try{let e=!1;if(o)e=a.step(),s.current({action:"testStep"}),e&&s.current({action:"testFinished"});else{const t=r.step();void 0!==t&&(e=!0,s.current({action:"setExitCode",payload:t}))}return c&&s.current({action:"update"}),e}catch(e){return t(`Runtime error: ${e.message}`),!0}},reset(){a.reset(),r.reset(),s.current({action:"update"}),s.current({action:"setExitCode",payload:void 0})},toggleUseTest(){o=!o,s.current({action:"update"})}};return{initialState:{vm:v(a,s),controls:{exitCode:void 0,runningTest:!1,animate:!0,valid:!0},test:{useTest:o,highlight:void 0},files:{tst:"repeat {\n\tvmstep;\n}",cmp:"",out:""}},reducers:l,actions:u}}(0,t,0,s)),[e,t,n,s]),[o,u]=(0,c.C)(r,i);return s.current=u,{state:o,dispatch:s,actions:a}}var S=n(4619),b=n(9882),I=n(8722),y=n(8398),C=n(558),E=n(864);const T={[b.b.SYS_WAIT_DURATION_NOT_POSITIVE]:i.ag._("Duration must be positive (Sys.wait)"),[b.b.ARRAY_SIZE_NOT_POSITIVE]:i.ag._("Array size must be positive (Array.new)"),[b.b.DIVIDE_BY_ZERO]:i.ag._("Division by zero (Math.divide)"),[b.b.SQRT_NEG]:i.ag._("Cannot compute square root of a negative number (Math.sqrt)"),[b.b.ALLOC_SIZE_NOT_POSITIVE]:i.ag._("Allocated memory size must be positive (Memory.alloc)"),[b.b.HEAP_OVERFLOW]:i.ag._("Heap overflow (Memory.alloc)"),[b.b.ILLEGAL_PIXEL_COORD]:i.ag._("Illegal pixel coordinates (Screen.drawPixel)"),[b.b.ILLEGAL_LINE_COORD]:i.ag._("Illegal line coordinates (Screen.drawLine)"),[b.b.ILLEGAL_RECT_COORD]:i.ag._("Illegal rectangle coordinates (Screen.drawRectangle)"),[b.b.ILLEGAL_CENTER_COORD]:i.ag._("Illegal center coordinates (Screen.drawCircle)"),[b.b.ILLEGAL_RADIUS]:i.ag._("Illegal radius (Screen.drawCircle)"),[b.b.STRING_LENGTH_NEG]:i.ag._("Maximum length must be non-negative (String.new)"),[b.b.GET_CHAR_INDEX_OUT_OF_BOUNDS]:i.ag._("String index out of bounds (String.charAt)"),[b.b.SET_CHAR_INDEX_OUT_OF_BOUNDS]:i.ag._("String index out of bounds (String.setCharAt)"),[b.b.STRING_FULL]:i.ag._("String is full (String.appendChar)"),[b.b.STRING_EMPTY]:i.ag._("String is empty (String.eraseLastChar)"),[b.b.STRING_INSUFFICIENT_CAPACITY]:i.ag._("Insufficient string capacity (String.setInt)"),[b.b.ILLEGAL_CURSOR_LOCATION]:i.ag._("Illegal cursor location (Output.moveCursor)")},L=()=>{const{state:e,actions:t,dispatch:n}=_(),{toolStates:i}=(0,f.useContext)(I.Il),{setStatus:d}=(0,f.useContext)(l.r),[u,h]=(0,c.i)(e.files.tst),[g,m]=(0,c.i)(e.files.out),[p,x]=(0,c.i)(e.files.cmp);(0,f.useEffect)((()=>{i.setTool("vm")}),[]),(0,f.useEffect)((()=>{t.loadTest(u,p),t.reset()}),[u,p]),(0,f.useEffect)((()=>{console.log("use effect exit code",e.controls.exitCode),void 0!==e.controls.exitCode&&d(0==e.controls.exitCode?"Program halted":`Program exited with error code ${e.controls.exitCode}${(0,b.q)(e.controls.exitCode)?`: ${T[e.controls.exitCode]}`:""}`)}),[e.controls.exitCode]);const j=(0,f.useRef)(),[v,L]=(0,f.useState)(!1);(0,f.useEffect)((()=>(j.current=new class extends S.B{async tick(){return t.step()}finishFrame(){n.current({action:"update"})}reset(){d("Reset"),t.reset()}toggle(){n.current({action:"update"})}},L(!0),()=>{var e;null===(e=j.current)||void 0===e||e.stop()})),[t,n]);const R=(0,f.useRef)(null);return(0,E.jsxs)("div",{className:"Page VmPage grid",children:[(0,E.jsx)(y.s,{className:"program",header:(0,E.jsxs)(E.Fragment,{children:[(0,E.jsx)(s.cC,{id:"Program"}),(0,E.jsx)("input",{type:"file",multiple:!0,style:{display:"none"},ref:R,onChange:async e=>{var n;if(null===(n=e.target.files)||void 0===n||!n.length)return void d("No file selected");d("Loading");const s=[];for(const t of e.target.files)t.name.endsWith(".vm")&&s.push({name:t.name.replace(".vm",""),content:await t.text()});if(0==s.length)return void d("No .vm file was selected");t.loadVm(s)&&d("Loaded vm file")}}),(0,E.jsx)("button",{className:"flex-0",onClick:()=>{var e;null===(e=R.current)||void 0===e||e.click()},"data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"})]}),children:(0,E.jsx)("main",{children:(0,E.jsxs)("table",{children:[(0,E.jsx)("thead",{children:(0,E.jsxs)("tr",{children:[(0,E.jsx)("td",{children:"Inst"}),(0,E.jsx)("td",{children:"Target"}),(0,E.jsx)("td",{children:"Val"})]})}),(0,E.jsx)("tbody",{children:e.vm.Prog.map(((t,n)=>N({inst:t,key:n,highlighted:n===e.vm.highlight})))})]})})}),(0,E.jsx)(y.s,{className:"stack",header:(0,E.jsx)(s.cC,{id:"VM"}),children:e.vm.Stack.map(((e,t)=>(0,E.jsx)(A,{frame:e},t)))}),(0,E.jsxs)(y.s,{className:"display",style:{gridArea:"display"},children:[(0,E.jsx)("div",{children:(0,E.jsxs)("label",{children:[(0,E.jsx)("input",{type:"checkbox",onChange:t.toggleUseTest,checked:e.test.useTest,role:"switch"}),"Use Test Script"]})}),(0,E.jsx)(o.l,{memory:e.vm.Screen}),(0,E.jsx)(r.N,{keyboard:e.vm.Keyboard}),e.controls.animate?(0,E.jsxs)("div",{style:{display:"flex",flexDirection:"row"},children:[(0,E.jsx)(a.ZP,{memory:e.vm.RAM,format:"hex"}),(0,E.jsx)(a.ZP,{memory:e.vm.RAM,format:"hex"})]}):(0,E.jsx)("p",{children:"Hiding display for high speeds"})]}),v&&(0,E.jsx)(C.F,{runner:j,tst:[u,h,e.test.highlight],out:[g,m],cmp:[p,x],onSpeedChange:e=>{t.setAnimate(e<=2)},disabled:!e.controls.valid})]})};function A(e){var t,n;let{frame:s}=e;return(0,E.jsxs)("section",{children:[(0,E.jsx)("header",{children:(0,E.jsxs)("h3",{children:["Function",(0,E.jsx)("code",{children:null!==(t=null===(n=s.fn)||void 0===n?void 0:n.name)&&void 0!==t?t:"Unknown Function"})]})}),(0,E.jsxs)("main",{children:[(0,E.jsxs)("p",{children:[(0,E.jsx)("em",{children:"Args:"}),(0,E.jsxs)("code",{children:["[",s.args.values.join(", "),"]"]})]}),(0,E.jsxs)("p",{children:[(0,E.jsx)("em",{children:"Locals:"}),(0,E.jsxs)("code",{children:["[",s.locals.values.join(", "),"]"]})]}),(0,E.jsxs)("p",{children:[(0,E.jsx)("em",{children:"Stack:"}),(0,E.jsxs)("code",{children:["[",s.stack.values.join(", "),"]"]})]})]})]})}function N(e){let{inst:t,key:n,highlighted:s}=e;switch(t.op){case"add":case"and":case"eq":case"gt":case"lt":case"neg":case"not":case"or":case"sub":case"return":return(0,E.jsxs)("tr",{className:s?"highlight":"",children:[(0,E.jsx)("td",{children:t.op}),(0,E.jsx)("td",{colSpan:2})]},n);case"if-goto":case"label":case"goto":return(0,E.jsxs)("tr",{className:s?"highlight":"",children:[(0,E.jsx)("td",{children:t.op}),(0,E.jsx)("td",{colSpan:2,children:t.label})]},n);case"function":case"call":return(0,E.jsxs)("tr",{className:s?"highlight":"",children:[(0,E.jsx)("td",{children:t.op}),(0,E.jsx)("td",{children:t.name}),(0,E.jsx)("td",{children:"call"===t.op?t.nArgs:t.nVars})]},n);case"pop":case"push":return(0,E.jsxs)("tr",{className:s?"highlight":"",children:[(0,E.jsx)("td",{children:t.op}),(0,E.jsx)("td",{children:t.segment}),(0,E.jsx)("td",{children:t.offset.toString()})]},n);default:return(0,E.jsx)("tr",{className:s?"highlight":"",children:(0,E.jsx)("td",{colSpan:3,children:"Unknown"})},n)}}},5969:(e,t,n)=>{n.d(t,{j:()=>i});var s=n(2201);class i extends s.kG{dispatch;constructor(e,t){super(e,e.size,0),this.dispatch=t}async load(e,t){await super.load(e,t),this.dispatch.current({action:"update"})}}},554:(e,t,n)=>{n.d(t,{j:()=>s});const s=e=>{if((e=>"function"===typeof e?.toString||"string"===typeof e)(e)){const t=e.toString();return"[object Object]"===t?JSON.stringify(e):t}return JSON.stringify(e)}},2936:(e,t,n)=>{n.d(t,{b:()=>i});var s=n(5251);function i(e,t){return void 0===e&&void 0!==s.BM[t]&&(e=t),{..."inline"===t?{display:"inline-block"}:{},width:s.BM[e]??"0"}}}}]);
"use strict";(globalThis.webpackChunk_nand2tetris_web=globalThis.webpackChunk_nand2tetris_web||[]).push([[447],{6049:(t,e,n)=>{n.r(e),n.d(e,{default:()=>k});var s=n(6458),i=n(8256),r=n(8878),o=n(7437),a=n(64),c=n(4668),l=n(8177),u=n(7022),d=n(910),m=n(5874),p=n(8463),h=n(7076),f=n(6554),g=n(9563),v=n(3977);const S='Vm <: Base {\n  Root := Vm\n\n  Vm = newline* VmInstructionLine* VmInstruction?\n\n  space := comment | " " | "\t"\n  whitespace = lineComment | comment | space\n\n  VmInstructionLine = VmInstruction newline+\n  VmInstruction =\n    | StackInstruction\n    | OpInstruction\n    | FunctionInstruction\n    | CallInstruction\n    | ReturnInstruction\n    | GotoInstruction\n    | LabelInstruction\n  \n  StackInstruction = (push | pop) MemorySegment Number\n  OpInstruction = Add | Sub | Neg | Lt | Gt | Eq | And | Or | Not\n  FunctionInstruction = function Name Number \n  CallInstruction =  call Name Number\n  ReturnInstruction = return\n  LabelInstruction = label Name\n  GotoInstruction = (goto | ifGoto) Name\n\n  MemorySegment = argument | local | static | constant | this | that | pointer | temp\n\n  push = "push" whitespace+\n  pop = "pop" whitespace+\n  function = "function" whitespace+\n  call = "call" whitespace+\n  return = "return"\n  goto = "goto" whitespace+\n  ifGoto = "if-goto" whitespace+\n  label = "label" whitespace+\n\n  argument = "argument" whitespace+\n  local = "local" whitespace+\n  static = "static" whitespace+\n  constant = "constant" whitespace+\n  this = "this" whitespace+\n  that = "that" whitespace+\n  pointer = "pointer" whitespace+\n  temp = "temp" whitespace+\n\n  Add = "add" \n  Sub = "sub" \n  Neg = "neg" \n  Eq = "eq"\n  Lt = "lt" \n  Gt = "gt" \n  And = "and" \n  Or = "or" \n  Not = "not"\n}',R=(0,g.qN)(S,v.lN),I=R.extendSemantics(v.JE);I.addAttribute("op",{push:(t,e)=>"push",pop:(t,e)=>"pop",function:(t,e)=>"function",call:(t,e)=>"call",return:t=>"return",goto:(t,e)=>"goto",ifGoto:(t,e)=>"if-goto",label:(t,e)=>"label",Add:t=>"add",Sub:t=>"sub",Neg:t=>"neg",Eq:t=>"eq",Lt:t=>"lt",Gt:t=>"gt",And:t=>"and",Or:t=>"or",Not:t=>"not"}),I.addAttribute("segment",{argument:(t,e)=>"argument",local:(t,e)=>"local",static:(t,e)=>"static",constant:(t,e)=>"constant",this:(t,e)=>"this",that:(t,e)=>"that",pointer:(t,e)=>"pointer",temp:(t,e)=>"temp"}),I.addAttribute("instruction",{StackInstruction({op:t},{segment:e},n){return{op:t,segment:e,offset:Number(n.sourceString),span:(0,v.Ln)(this.source)}},OpInstruction({op:t}){return{op:t,span:(0,v.Ln)(this.source)}},FunctionInstruction(t,{name:e},n){return{op:"function",name:e,nVars:Number(n.sourceString),span:(0,v.Ln)(this.source)}},CallInstruction(t,{name:e},n){return{op:"call",name:e,nArgs:Number(n.sourceString),span:(0,v.Ln)(this.source)}},ReturnInstruction(t){return{op:"return",span:(0,v.Ln)(this.source)}},LabelInstruction(t,{name:e}){return{op:"label",label:e,span:(0,v.Ln)(this.source)}},GotoInstruction({op:t},{name:e}){return{op:t,label:e,span:(0,v.Ln)(this.source)}},VmInstructionLine:(t,e)=>t.instruction}),I.addAttribute("vm",{Vm(t,e,n){const s=e.children.map((t=>t.instruction))??[];return{instructions:n.child(0)?[...s,n.child(0).instruction]:s}}}),I.addAttribute("root",{Root:({vm:t})=>t});const A={grammar:S,semantics:I,parser:R,parse:(0,v.Q5)(R,I)};var x=n(8783),b=n(5087),_=n(7365),y=n(4256);const E="repeat {\n\tvmstep;\n}";function C(t,e,n,s){const i=new y.X(t.vm.RAM,e),r=new y.X(t.vm.Screen,e),o=new h.PC(new y.X(t.vm.RAM,e)),a=t.vm.derivedLine();let c=[];try{c=t.vm.vmStack().reverse()}catch(l){n("Runtime error: Invalid stack")}return{Keyboard:o,RAM:i,Screen:r,Stack:c,Prog:t.vm.program,Statics:[...t.vm.memory.map(((t,e)=>e),16,16+t.vm.getStaticCount())],Temp:[...t.vm.memory.map(((t,e)=>e),5,13)],AddedSysInit:t.vm.addedSysInit,highlight:a,showHighlight:s}}function L(){const{fs:t,setStatus:e,storage:n}=(0,r.useContext)(d.L),s=(0,r.useRef)((()=>{})),{initialState:i,reducers:o,actions:a}=(0,r.useMemo)((()=>function(t,e,n,s){const i=(0,m.oA)(A.parse(p.J5));let r=(0,m.oA)(b.Vm.build(i.instructions)),o=new x.Y(e).with(r),a=!1,c=!0,l="",u=!0;const d={setVm(t,e){t.files.vm=e},setTst(t,{tst:e,cmp:n}){t.files.tst=e,t.files.cmp=n??""},setExitCode(t,e){t.controls.exitCode=e},setValid(t,e){t.controls.valid=e},setShowHighlight(t,e){t.vm.showHighlight=e},setError(t,n){n?(t.controls.valid=!1,e(n?.message)):t.controls.valid=!0,t.controls.error=n},setPath(t,e){t.test.path=e},update(t){t.vm=C(o,s,e,u),t.test.highlight=o.currentStep?.span},setAnimate(t,e){t.controls.animate=e},testStep(t){t.files.out=o.log()},testFinished(t){const n=(0,_.U)(t.files.cmp.trim(),t.files.out);e(n?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}},h={vm:C(o,s,e,!0),controls:{exitCode:void 0,runningTest:!1,animate:!0,valid:!0},test:{highlight:void 0,path:"/"},files:{vm:"",tst:E,cmp:"",out:""}},g={setVm(t){if(u=!1,s.current({action:"setVm",payload:t}),l==t)return;l=t;const e=A.parse(t);if((0,m.ys)(e))return s.current({action:"setError",payload:(0,m._)(e)}),!1;const n=(0,m.oA)(e).instructions,i=b.Vm.build(n);return this.replaceVm(i)},loadVm(t){u=!1;for(const s of t)s.content.endsWith("\n")&&(s.content=s.content.slice(0,-1));const e=t.map((t=>t.content)).join("\n");if(s.current({action:"setVm",payload:e}),l==e)return;l=e;const n=[];let i=0;for(const o of t){const t=A.parse(o.content);if((0,m.ys)(t))return s.current({action:"setError",payload:(0,m._)(t)}),!1;const e=(0,m.oA)(t).instructions;for(const n of e)void 0!=n.span?.line&&(n.span.line+=i);i+=o.content.split("\n").length,n.push({name:o.name,instructions:e})}const r=b.Vm.buildFromFiles(n);return this.replaceVm(r)},replaceVm:t=>(0,m.ys)(t)?(s.current({action:"setError",payload:(0,m._)(t)}),!1):(s.current({action:"setError"}),e("Compiled VM code successfully"),r=(0,m.oA)(t),o.vm=r,s.current({action:"update"}),!0),loadTest(n,i,a){s.current({action:"setTst",payload:{tst:i,cmp:a}});const c=f.uG.parse(i);return(0,m.ys)(c)?(s.current({action:"setValid",payload:!1}),e("Failed to parse test"),!1):(s.current({action:"setValid",payload:!0}),e("Parsed tst"),r.reset(),o=x.Y.from((0,m.oA)(c),n,(t=>{this.loadVm(t)}),e).using(t),o.vm=r,s.current({action:"update"}),!0)},setAnimate(t){c=t,s.current({action:"setAnimate",payload:t})},async testStep(){u=!0;let t=!1;try{return t=await o.step(),s.current({action:"testStep"}),t&&s.current({action:"testFinished"}),c&&s.current({action:"update"}),t}catch(n){return e(`Runtime error: ${n.message}`),s.current({action:"setValid",payload:!1}),!0}},setPaused(t=!0){r.setPaused(t)},step(){u=!0;try{let t=!1;const e=r.step();return void 0!==e&&(t=!0,s.current({action:"setExitCode",payload:e})),c&&s.current({action:"update"}),t}catch(t){return e(`Runtime error: ${t.message}`),s.current({action:"setValid",payload:!1}),!0}},reset(){u=!0,o.reset(),r.reset(),s.current({action:"update"}),s.current({action:"setExitCode",payload:void 0}),s.current({action:"setValid",payload:!0})},toggleUseTest(){a=!a,s.current({action:"update"})},initialize(){this.setVm(p.J5)}};return{initialState:h,reducers:d,actions:g}}(t,e,0,s)),[t,e,n,s]),[c,u]=(0,l.A)(o,i);return s.current=u,{state:c,dispatch:s,actions:a}}var T=n(1091),j=n(270),N=n(8029),w=n(2675),M=n(4280),O=n(9267),V=n(782);const P={[j.X.SYS_WAIT_DURATION_NOT_POSITIVE]:i.Ru._({id:"9dwWEz"}),[j.X.ARRAY_SIZE_NOT_POSITIVE]:i.Ru._({id:"zh5lcC"}),[j.X.DIVIDE_BY_ZERO]:i.Ru._({id:"iGq+of"}),[j.X.SQRT_NEG]:i.Ru._({id:"RsyXWz"}),[j.X.ALLOC_SIZE_NOT_POSITIVE]:i.Ru._({id:"Pza0F/"}),[j.X.HEAP_OVERFLOW]:i.Ru._({id:"EqbNAN"}),[j.X.ILLEGAL_PIXEL_COORD]:i.Ru._({id:"Lo+J/U"}),[j.X.ILLEGAL_LINE_COORD]:i.Ru._({id:"y4CC1u"}),[j.X.ILLEGAL_RECT_COORD]:i.Ru._({id:"5tI3XX"}),[j.X.ILLEGAL_CENTER_COORD]:i.Ru._({id:"SLzG45"}),[j.X.ILLEGAL_RADIUS]:i.Ru._({id:"ijwovO"}),[j.X.STRING_LENGTH_NEG]:i.Ru._({id:"etZuY4"}),[j.X.GET_CHAR_INDEX_OUT_OF_BOUNDS]:i.Ru._({id:"GbPVvk"}),[j.X.SET_CHAR_INDEX_OUT_OF_BOUNDS]:i.Ru._({id:"IgLZZI"}),[j.X.STRING_FULL]:i.Ru._({id:"CACwfm"}),[j.X.STRING_EMPTY]:i.Ru._({id:"RE1zuN"}),[j.X.STRING_INSUFFICIENT_CAPACITY]:i.Ru._({id:"fkP0ib"}),[j.X.ILLEGAL_CURSOR_LOCATION]:i.Ru._({id:"EQU4AC"})},k=()=>{const{state:t,actions:e,dispatch:n}=L(),{setStatus:i}=(0,r.useContext)(d.L),{toolStates:m,setTitle:p}=(0,r.useContext)(N.BR),[h,f]=(0,l.b)(t.files.tst),[g,v]=(0,l.b)(t.files.out),[S,R]=(0,l.b)(t.files.cmp),[I,A]=(0,r.useState)("/");(0,r.useEffect)((()=>{e.initialize()}),[e]),(0,r.useEffect)((()=>{p(m.vm.title)})),(0,r.useEffect)((()=>{m.vm.files&&e.loadVm(m.vm.files)}),[m.vm.files]),(0,r.useEffect)((()=>{e.loadTest(I,h,S),e.reset()}),[h,S]),(0,r.useEffect)((()=>{void 0!==t.controls.exitCode&&i(0==t.controls.exitCode?"Program halted":`Program exited with error code ${t.controls.exitCode}${(0,j.U)(t.controls.exitCode)?`: ${P[t.controls.exitCode]}`:""}`)}),[t.controls.exitCode]);const x=(0,r.useRef)(),b=(0,r.useRef)(),[_,y]=(0,r.useState)(!1);(0,r.useEffect)((()=>(x.current=new class extends T.M{async tick(){return e.step()}finishFrame(){n.current({action:"update"})}reset(){i("Reset"),e.reset()}toggle(){e.setPaused(!this.running),n.current({action:"update"})}},b.current=new class extends T.M{async tick(){return e.testStep()}finishFrame(){n.current({action:"update"})}reset(){i("Reset"),e.reset()}toggle(){e.setPaused(!this.running),n.current({action:"update"})}},y(!0),()=>{var t,e;null===(t=x.current)||void 0===t||t.stop(),null===(e=b.current)||void 0===e||e.stop()})),[e,n]);const C=(0,r.useRef)(null),k=t=>{e.setAnimate(t<=2)},G=(0,r.useRef)(),[X,D]=(0,r.useState)(1);return(0,V.jsxs)("div",{className:"Page VmPage grid "+(0==X?"no-screen":2==X?"large-screen":"normal"),children:[(0,V.jsx)(M.Z,{className:"program",header:(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)("input",{style:{display:"none"},ref:C,type:"file",webkitdirectory:"",onChange:async t=>{if(!t.target.files||0==t.target.files.length)return;const n=[];for(const e of t.target.files)e.name.endsWith(".vm")&&n.push({name:e.name.replace(".vm",""),content:await e.text()});const s=t.target.files[0].webkitRelativePath.split("/")[0];m.vm.setTitle(`${s} / *.vm`),e.loadVm(n),e.reset(),i("")}}),(0,V.jsx)("div",{className:"flex-0",style:{whiteSpace:"nowrap"},children:(0,V.jsx)(s.x6,{id:"1qK+lw"})}),(0,V.jsx)("div",{className:"flex-1",children:_&&x.current&&(0,V.jsx)(u.T,{prefix:(0,V.jsx)("button",{className:"flex-0",onClick:()=>{var t;null===(t=C.current)||void 0===t||t.click()},"data-tooltip":"Load files","data-placement":"bottom",children:"\ud83d\udcc2"}),runner:x.current,disabled:!t.controls.valid,onSpeedChange:k})})]}),children:(0,V.jsx)(w.K,{value:t.files.vm,onChange:t=>{e.setVm(t)},language:"vm",highlight:t.controls.valid&&t.vm.showHighlight?t.vm.highlight:void 0,error:t.controls.error})}),(0,V.jsx)(M.Z,{className:"vm",header:(0,V.jsx)(s.x6,{id:"2BSTzk"}),children:t.controls.valid&&t.vm.Stack.length>0&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(U,{statics:t.vm.Statics,temp:t.vm.Temp,frame:t.vm.Stack[0]}),(0,V.jsx)(F,{stack:t.vm.Stack,addedSysInit:t.vm.AddedSysInit})]})}),(0,V.jsxs)(M.Z,{className:"display",style:{gridArea:"display"},children:[(0,V.jsx)(c.f,{memory:t.vm.Screen,showScaleControls:!0,scale:X,onScale:t=>{D(t)}}),(0,V.jsx)(o.s,{keyboard:t.vm.Keyboard})]}),(0,V.jsx)(a.Ay,{ref:G,name:"RAM",memory:t.vm.RAM,initialAddr:256,format:"dec",showClear:!1}),(0,V.jsx)(a.Ay,{name:"RAM",className:"Stack",memory:t.vm.RAM,format:"dec",cellLabels:["SP:","LCL:","ARG:","THIS:","THAT:","TEMP0:","TEMP1:","TEMP2:","TEMP3:","TEMP4:","TEMP5:","TEMP6:","TEMP7:","R13:","R14:","R15:"],onChange:()=>{var t;null===(t=G.current)||void 0===t||t.rerender()}}),_&&(0,V.jsx)(O.B,{runner:b,tst:[h,f,t.test.highlight],out:[g,v],cmp:[S,R],setPath:A,showClear:!0,defaultTst:E,onSpeedChange:k,disabled:!t.controls.valid})]})},G="Unknown function";function X(t,e){const n={};t=t.filter((t=>{var e;return(null===(e=t.fn)||void 0===e?void 0:e.name)!=b.IG}));for(const i of t)i.fn&&(n[i.fn.name]?n[i.fn.name]++:n[i.fn.name]=1);const s=t.slice().reverse().map((t=>{var n,s,i;return(null===(n=t.fn)||void 0===n?void 0:n.name)==b.h0.name?e?`${b.h0.name} (built-in)`:b.h0.name:null!==(s=null===(i=t.fn)||void 0===i?void 0:i.name)&&void 0!==s?s:G}));for(const i of Object.keys(n))if(1!=n[i]){n[i]=0;for(let t=0;t<s.length;t++)s[t]===i&&(s[t]=`${i}[${n[i]}]`,n[i]++)}return s}function F({stack:t,addedSysInit:e}){return(0,V.jsx)("section",{children:(0,V.jsxs)("p",{children:["Call-stack:",(0,V.jsx)("code",{children:X(t,e).join(" > ")})]})})}function U({statics:t,temp:e,frame:n}){var s,i,r,o,a,c,l;return(0,V.jsx)("section",{children:(0,V.jsxs)("main",{children:[(0,V.jsxs)("p",{children:["Stack:",(0,V.jsxs)("code",{children:["[",n.stack.values.join(", "),"]"]})]}),(null===(s=n.usedSegments)||void 0===s?void 0:s.has("local"))&&(0,V.jsxs)("p",{children:["local:",(0,V.jsxs)("code",{children:["[",n.locals.values.join(", "),"]"]})]}),(null===(i=n.usedSegments)||void 0===i?void 0:i.has("argument"))&&(0,V.jsxs)("p",{children:["argument:",(0,V.jsxs)("code",{children:["[",n.args.values.join(", "),"]"]})]}),(null===(r=n.usedSegments)||void 0===r?void 0:r.has("static"))&&(0,V.jsxs)("p",{children:["static:",(0,V.jsxs)("code",{children:["[",t.join(", "),"]"]})]}),(null===(o=n.usedSegments)||void 0===o?void 0:o.has("pointer"))&&(0,V.jsxs)("p",{children:["pointer:",(0,V.jsxs)("code",{children:["[",`${n.frame.THIS}, ${n.frame.THAT}`,"]"]})]}),(null===(a=n.usedSegments)||void 0===a?void 0:a.has("this"))&&(0,V.jsxs)("p",{children:["this:",(0,V.jsxs)("code",{children:["[",n.this.values.join(", "),"]"]})]}),(null===(c=n.usedSegments)||void 0===c?void 0:c.has("that"))&&(0,V.jsxs)("p",{children:["that:",(0,V.jsxs)("code",{children:["[",n.that.values.join(", "),"]"]})]}),(null===(l=n.usedSegments)||void 0===l?void 0:l.has("temp"))&&(0,V.jsxs)("p",{children:["temp:",(0,V.jsxs)("code",{children:["[",e.join(", "),"]"]})]})]})})}},4256:(t,e,n)=>{n.d(e,{X:()=>i});var s=n(7076);class i extends s.qN{dispatch;constructor(t,e){super(t,t.size,0),this.dispatch=e}async load(t,e){await super.load(t,e),this.dispatch.current({action:"update"})}}},8463:(t,e,n)=>{n.d(e,{Kx:()=>i,O:()=>o,a5:()=>r,J5:()=>s});const s="function Main.fibonacci 0\n    push argument 0\n    push constant 2\n    lt                     // checks if n<2\n    if-goto IF_TRUE\n    goto IF_FALSE\n    label IF_TRUE          // if n<2, return n\n    push argument 0        \n    return\n    label IF_FALSE         // if n>=2, returns fib(n-2)+fib(n-1)\n    push argument 0\n    push constant 2\n    sub\n    call Main.fibonacci 1  // computes fib(n-2)\n    push argument 0\n    push constant 1\n    sub\n    call Main.fibonacci 1  // computes fib(n-1)\n    add                    // returns fib(n-1) + fib(n-2)\n    return\nfunction Sys.init 0\n    push constant 4\n    call Main.fibonacci 1   // computes the 4'th fibonacci element\nlabel WHILE\n    goto WHILE              // loops infinitely\n",i={"01":["Nand"],"02":[],"03":["DFF"],"05":["Screen","Keyboard","DRegister","ARegister","ROM32K","RAM16K"]},r={"01":["Not","And","Or","Xor","Mux","DMux","Not16","And16","Or16","Mux16","Or8Way","Mux4Way16","Mux8Way16","DMux4Way","DMux8Way"],"02":["HalfAdder","FullAdder","Add16","Inc16","ALU"],"03":["Bit","Register","RAM8","RAM64","RAM512","RAM4K","RAM16K","PC"],"05":["Memory","CPU","Computer"]},o={"05":["Memory","CPU","Computer","Screen","Keyboard","DRegister","ARegister","ROM32K","RAM16K"]}}}]);
"use strict";(globalThis.webpackChunk_nand2tetris_web=globalThis.webpackChunk_nand2tetris_web||[]).push([[840],{2632:(t,s,e)=>{e.r(s),e.d(s,{Chip:()=>ps,default:()=>gs});var i=e(4621),n=e(4771),r=e(8878),a=e(782),o=e(7721),l=e(7076),c=e(6983),u=e(7844),h=e(9651),d=e(2469);class p extends h._b{width;_memory;_nextData=0;_address=0;get memory(){return this._memory}get address(){return this._address}constructor(t,s){super(["in[16]","load",`address[${t}]`],["out[16]"],s),this.width=t,this._memory=new l.ce(Math.pow(2,this.width))}tick(){const t=this.in("load").voltage();this._address=this.in("address").busVoltage,t&&(this._nextData=this.in().busVoltage,this._memory.set(this._address,this._nextData))}tock(){this.out().busVoltage=this._memory?.get(this._address)??0}eval(){const t=this.in("address").busVoltage;this.out().busVoltage=this._memory?.get(t)??0}at(t){return(0,d.vA)(t<this._memory.size,(()=>`Request out of bounds (${t} >= ${this._memory.size})`)),new g(`${this.name}[${t}]`,t,this._memory)}get(t,s){return t===this.name?this.at(s??0):super.get(t)}reset(){this._memory.reset(),super.reset()}}class g extends h.z7{index;ram;constructor(t,s,e){super(t),this.index=s,this.ram=e}get busVoltage(){return this.ram.get(this.index)}set busVoltage(t){this.ram.set(this.index,t)}}class m extends p{constructor(){super(3,"RAM8")}}class b extends p{constructor(){super(14,"RAM16K")}}class f extends p{constructor(){super(15,"ROM")}async load(t,s){try{(await(0,c.Hh)(t,s)).map(((t,s)=>this.at(s).busVoltage=t))}catch(e){throw new Error(`ROM32K Failed to load file ${s}`)}}}class x extends p{static SIZE=l.RL;static OFFSET=l.L7;constructor(){super(13,"Screen")}}class v extends h.vu{static OFFSET=l.ky;constructor(){super([],["out[16]"],"Keyboard")}getKey(){return this.out().busVoltage}setKey(t){this.out().busVoltage=65535&t}clearKey(){this.out().busVoltage=0}get(t){return t===this.name?new h.xo(this.name,this.getKey()):super.get(t)}}class y extends h._b{ram=new b;screen=new x;keyboard=new v;address=0;constructor(){super(["in[16]","load","address[15])"],["out[16]"],"Memory"),this.parts.add(this.keyboard),this.parts.add(this.screen),this.parts.add(this.ram)}tick(){const t=this.in("load").voltage();if(this.address=this.in("address").busVoltage,t){const t=this.in().busVoltage;this.address>=v.OFFSET||(this.address>=x.OFFSET?this.screen.at(this.address-x.OFFSET).busVoltage=t:this.ram.at(this.address).busVoltage=t)}}tock(){this.eval()}eval(){if(!this.ram)return;this.address=this.in("address").busVoltage;let t=0;t=this.address>=v.OFFSET?this.keyboard?.out().busVoltage??0:this.address>=x.OFFSET?this.screen?.at(this.address-x.OFFSET).busVoltage??0:this.ram?.at(this.address).busVoltage??0,this.out().busVoltage=t}in(t){if(t?.startsWith("RAM16K")){const s=(0,u.ZR)(t.match(/\[(?<idx>\d+)]/)?.groups?.idx??"0");return this.ram.at(s)}if(t?.startsWith("Screen")){const s=(0,u.ZR)(t.match(/\[(?<idx>\d+)]/)?.groups?.idx??"0");return this.screen.at(s)}return super.in(t)}get(t,s=0){return t.startsWith("RAM16K")?this.at(16383&s):t.startsWith("Screen")?this.at(s&8191+x.OFFSET):t.startsWith("Keyboard")?this.at(v.OFFSET):t.startsWith("Memory")?this.at(s):super.get(t,s)}at(t){return t>=v.OFFSET?this.keyboard.out():t>=x.OFFSET?this.screen.at(t-x.OFFSET):this.ram.at(t)}reset(){this.address=0,this.ram.reset(),this.screen.reset(),super.reset()}}class w extends h.z7{cpu;constructor(t,s){super(t),this.cpu=s}get busVoltage(){return this.cpu.D}set busVoltage(t){this.cpu.D=t}}class j extends h.z7{cpu;constructor(t,s){super(t),this.cpu=s}get busVoltage(){return this.cpu.A}set busVoltage(t){this.cpu.A=t}}class C extends h.z7{cpu;constructor(t,s){super(t),this.cpu=s}get busVoltage(){return this.cpu.PC}set busVoltage(t){this.cpu.PC=t}}class P extends h._b{_state=(0,o.p$)();get state(){return this._state}constructor(){super(["inM[16]","instruction[16]","reset"],["outM[16]","writeM","addressM[15]","pc[15]"])}tick(){const[t,s]=(0,o.gV)(this.cpuInput(),this._state);this._state=t,this.out("writeM").pull(s?h.RY:h.$L),this.out("outM").busVoltage=this._state.ALU??0}tock(){if(!this._state)return;const[t,s]=(0,o.I8)(this.cpuInput(),this._state);this._state=s,this.out("addressM").busVoltage=t.addressM??0,this.out("outM").busVoltage=t.outM??0,this.out("writeM").pull(t.writeM?h.RY:h.$L),this.out("pc").busVoltage=this._state?.PC??0}cpuInput(){return{inM:this.in("inM").busVoltage,instruction:this.in("instruction").busVoltage,reset:1===this.in("reset").busVoltage}}get(t,s){return t?.startsWith("ARegister")?new j("ARegister",this._state):t?.startsWith("DRegister")?new w("DRegister",this._state):t?.startsWith("PC")?new C("PC",this._state):super.get(t,s)}reset(){this._state=(0,o.p$)(),this._state.PC=-1,super.reset()}}class V extends h.vu{cpu=new P;ram=new y;rom=new f;constructor(){super(["reset"],[]),this.wire(this.cpu,[{from:{name:"reset",start:0},to:{name:"reset",start:0}},{from:{name:"instruction",start:0},to:{name:"instruction",start:0}},{from:{name:"oldOutM",start:0},to:{name:"inM",start:0}},{from:{name:"writeM",start:0},to:{name:"writeM",start:0}},{from:{name:"addressM",start:0},to:{name:"addressM",start:0}},{from:{name:"newInM",start:0},to:{name:"outM",start:0}},{from:{name:"pc",start:0},to:{name:"pc",start:0}}]),this.wire(this.rom,[{from:{name:"pc",start:0},to:{name:"address",start:0}},{from:{name:"instruction",start:0},to:{name:"out",start:0}}]),this.wire(this.ram,[{from:{name:"newInM",start:0},to:{name:"in",start:0}},{from:{name:"writeM",start:0},to:{name:"load",start:0}},{from:{name:"addressM",start:0},to:{name:"address",start:0}},{from:{name:"oldOutM",start:0},to:{name:"out",start:0}}])}eval(){super.eval()}get(t,s){return t.startsWith("PC")||t.startsWith("ARegister")||t.startsWith("DRegister")?this.cpu.get(t):t.startsWith("RAM16K")?this.ram.get(t,s):super.get(t,s)}async load(t,s){return await this.rom.load(t,s)}}var R=e(5874);class $ extends h.vu{constructor(){super(["a","b"],["out"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),[e]=function(t,s){return[1===t&&1===s?h.RY:h.$L]}(t,s);this.out().pull(e)}}class k extends h.vu{constructor(){super(["a[16]","b[16]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,[e]=function(t,s){return[t&s&65535]}(t,s);this.out().busVoltage=e}}class S extends h.vu{constructor(){super(["in","sel"],["a","b"])}eval(){const t=this.in("in").voltage(),s=this.in("sel").voltage(),[e,i]=function(t,s){return[s===h.$L&&t===h.RY?h.RY:h.$L,s===h.RY&&t===h.RY?h.RY:h.$L]}(t,s);this.out("a").pull(e),this.out("b").pull(i)}}class L extends h.vu{constructor(){super(["in","sel[2]"],["a","b","c","d"])}eval(){const t=this.in("in").voltage(),s=this.in("sel").busVoltage,[e,i,n,r]=function(t,s){return[0===s&&t===h.RY?h.RY:h.$L,1===s&&t===h.RY?h.RY:h.$L,2===s&&t===h.RY?h.RY:h.$L,3===s&&t===h.RY?h.RY:h.$L]}(t,s);this.out("a").pull(e),this.out("b").pull(i),this.out("c").pull(n),this.out("d").pull(r)}}class _ extends h.vu{constructor(){super(["in","sel[3]"],["a","b","c","d","e","f","g","h"])}eval(){const t=this.in("in").voltage(),s=this.in("sel").busVoltage,[e,i,n,r,a,o,l,c]=function(t,s){return[0===s&&t===h.RY?h.RY:h.$L,1===s&&t===h.RY?h.RY:h.$L,2===s&&t===h.RY?h.RY:h.$L,3===s&&t===h.RY?h.RY:h.$L,4===s&&t===h.RY?h.RY:h.$L,5===s&&t===h.RY?h.RY:h.$L,6===s&&t===h.RY?h.RY:h.$L,7===s&&t===h.RY?h.RY:h.$L]}(t,s);this.out("a").pull(e),this.out("b").pull(i),this.out("c").pull(n),this.out("d").pull(r),this.out("e").pull(a),this.out("f").pull(o),this.out("g").pull(l),this.out("h").pull(c)}}function M(t,s,e){return[e===h.$L?t:s]}function I(t,s,e,i,n){const r=1&n;return 0===(2&n)?M(t,s,r):M(e,i,r)}class O extends h.vu{constructor(){super(["a","b","sel"],["out"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),e=this.in("sel").voltage(),[i]=function(t,s,e){return[e===h.$L?t:s]}(t,s,e);this.out().pull(i)}}class A extends h.vu{constructor(){super(["a[16]","b[16]","sel"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,e=this.in("sel").voltage(),[i]=M(t,s,e);this.out().busVoltage=i}}class F extends h.vu{constructor(){super(["a[16]","b[16]","c[16]","d[16]","sel[2]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,e=this.in("c").busVoltage,i=this.in("d").busVoltage,n=this.in("sel").busVoltage,[r]=I(t,s,e,i,n);this.out().busVoltage=r}}class T extends h.vu{constructor(){super(["a[16]","b[16]","c[16]","d[16]","e[16]","f[16]","g[16]","h[16]","sel[3]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,e=this.in("c").busVoltage,i=this.in("d").busVoltage,n=this.in("e").busVoltage,r=this.in("f").busVoltage,a=this.in("g").busVoltage,o=this.in("h").busVoltage,l=this.in("sel").busVoltage,[c]=function(t,s,e,i,n,r,a,o,l){const c=3&l;return 0===(4&l)?I(t,s,e,i,c):I(n,r,a,o,c)}(t,s,e,i,n,r,a,o,l);this.out().busVoltage=c}}class W extends h.vu{constructor(){super(["a","b"],["out"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),[e]=function(t,s){return[1===t&&1===s?h.$L:h.RY]}(t,s);this.out().pull(e)}}class N extends h.vu{constructor(){super(["a[16]","b[16]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage;this.out().busVoltage=(0,u.xu)(t,s)}}class E extends h.vu{constructor(){super(["in"],["out"])}eval(){const t=this.in("in").voltage(),[s]=[t===h.$L?h.RY:h.$L];this.out().pull(s)}}class Y extends h.vu{constructor(){super(["in[16]"],["out[16]"])}eval(){const[t]=[65535&~this.in().busVoltage];this.out().busVoltage=t}}function D(t,s){return[1===t||1===s?h.RY:h.$L]}class B extends h.vu{constructor(){super(["a","b"],["out"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),[e]=D(t,s);this.out().pull(e)}}class z extends h.vu{constructor(){super(["a[16]","b[16]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,[e]=function(t,s){return[65535&(t|s)]}(t,s);this.out().busVoltage=e}}class U extends h.vu{constructor(){super(["in[8]"],["out"],"Or8way")}eval(){const t=this.in().busVoltage,[s]=[0===(255&t)?h.$L:h.RY];this.out().pull(s)}}class H extends h.vu{constructor(){super(["a","b"],["out"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),[e]=function(t,s){return[t===h.RY&&s===h.$L||t===h.$L&&s===h.RY?h.RY:h.$L]}(t,s);this.out().pull(e)}}class K extends h.vu{constructor(){super(["a[16]","b[16]"],["out[16]"])}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,[e]=function(t,s){return[65535&(t^s)]}(t,s);this.out().busVoltage=e}}function J(t,s){return[t+s&65535]}class Z extends h.vu{constructor(){super(["a[16]","b[16]"],["out[16]"],"Add16")}eval(){const t=this.in("a").busVoltage,s=this.in("b").busVoltage,[e]=J(t,s);this.out().busVoltage=e}}var q=e(8739);class X extends h.vu{constructor(){super(["x[16]","y[16]","zx","nx","zy","ny","f","no"],["out[16]"],"ALU")}eval(){const t=this.in("x").busVoltage,s=this.in("y").busVoltage,e=(this.in("zx").busVoltage<<5)+(this.in("nx").busVoltage<<4)+(this.in("zy").busVoltage<<3)+(this.in("ny").busVoltage<<2)+(this.in("f").busVoltage<<1)+(this.in("no").busVoltage|0),[i]=(0,q.v0)(e,t,s);this.out().busVoltage=i}}class Q extends h.vu{constructor(){super(["x[16]","y[16]","zx","nx","zy","ny","f","no"],["out[16]","zr","ng"],"ALU")}eval(){const t=this.in("x").busVoltage,s=this.in("y").busVoltage,e=(this.in("zx").busVoltage<<5)+(this.in("nx").busVoltage<<4)+(this.in("zy").busVoltage<<3)+(this.in("ny").busVoltage<<2)+(this.in("f").busVoltage<<1)+(this.in("no").busVoltage|0),[i,n]=(0,q.v0)(e,t,s),r=n===q.iI.Negative?h.RY:h.$L,a=n===q.iI.Zero?h.RY:h.$L;this.out("out").busVoltage=i,this.out("ng").pull(r),this.out("zr").pull(a)}op(){return(this.in("zx").busVoltage<<5)+(this.in("nx").busVoltage<<4)+(this.in("zy").busVoltage<<3)+(this.in("ny").busVoltage<<2)+(this.in("f").busVoltage<<1)+(this.in("no").busVoltage|0)}}h.vu;function G(t,s){return[1===t&&0===s||0===t&&1===s?h.RY:h.$L,1===t&&1===s?h.RY:h.$L]}class tt extends h.vu{constructor(){super(["a","b"],["sum","carry"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),[e,i]=G(t,s);this.out("sum").pull(e),this.out("carry").pull(i)}}class st extends h.vu{constructor(){super(["a","b","c"],["sum","carry"])}eval(){const t=this.in("a").voltage(),s=this.in("b").voltage(),e=this.in("c").voltage(),[i,n]=function(t,s,e){const[i,n]=G(t,s),[r,a]=G(i,e),[o]=D(n,a);return[r,o]}(t,s,e);this.out("sum").pull(i),this.out("carry").pull(n)}}class et extends h.vu{constructor(){super(["in[16]"],["out[16]"],"Inc16")}eval(){const t=this.in().busVoltage,[s]=J(t,1);this.out().busVoltage=s}}class it extends h._b{bit=h.$L;constructor(t){super(["in","load"],["out"],t)}tick(){this.in("load").voltage()===h.RY&&(this.bit=this.in().voltage())}tock(){this.out().pull(this.bit??0)}reset(){this.bit=h.$L,super.reset()}}class nt extends h.z7{register;constructor(t,s){super(t),this.register=s}get busVoltage(){return 65535&this.register.bits}set busVoltage(t){this.register.bits=65535&t}}class rt extends h._b{bits=0;constructor(t){super(["in[16]","load"],["out[16]"],t)}tick(){this.in("load").voltage()===h.RY&&(this.bits=65535&this.in().busVoltage)}tock(){this.out().busVoltage=65535&this.bits}get(t,s){return t===this.name?new nt(this.name,this):super.get(t,s)}reset(){this.bits=0,super.reset()}}class at extends rt{}class ot extends h._b{bits=0;constructor(t){super(["in[16]","reset","load","inc"],["out[16]"],t)}tick(){this.in("reset").voltage()===h.RY?this.bits=0:this.in("load").voltage()===h.RY?this.bits=65535&this.in().busVoltage:this.in("inc").voltage()===h.RY&&(this.bits+=1)}tock(){this.out().busVoltage=65535&this.bits}get(t,s){return t===this.name?new nt(this.name,this):super.get(t,s)}reset(){this.bits=0,super.reset()}}class lt extends h._b{constructor(t){super(["in"],["out"],t,["t"])}tick(){const t=this.in().voltage();this.pin("t").pull(t)}tock(){const t=this.pin("t").voltage();this.out().pull(t)}}const ct=new Map([["Nand",W],["Nand16",N],["Not",E],["Not16",Y],["And",$],["And16",k],["Or",B],["Or16",z],["Or8Way",U],["XOr",H],["XOr16",K],["Xor",H],["Xor16",K],["Mux",O],["Mux16",A],["Mux4Way16",F],["Mux8Way16",T],["DMux",S],["DMux4Way",L],["DMux8Way",_],["HalfAdder",tt],["FullAdder",st],["Add16",Z],["Inc16",et],["ALU",Q],["ALUNoStat",X],["DFF",lt],["Bit",it],["Register",rt],["ARegister",rt],["DRegister",rt],["PC",ot],["RAM8",m],["RAM64",class extends p{constructor(){super(6,"RAM64")}}],["RAM512",class extends p{constructor(){super(9,"RAM512")}}],["RAM4K",class extends p{constructor(){super(12,"RAM4K")}}],["RAM16K",b],["ROM32K",f],["Screen",x],["Keyboard",v],["CPU",P],["Computer",V],["Memory",y],["ARegister",at],["DRegister",at]].map((([t,s])=>[t,()=>{const e=new s;return e.name=t,e}])));function ut(t){const s=ct.get(t);return s?(0,R.Ok)(s()):(0,R._)(new Error(`Chip ${t} not in builtin registry`))}var ht=e(4641),dt=e(9433),pt=e(3977);const gt='\nHdl <: Base{\n  Root := Chip\n  Chip = "CHIP" Name OpenBrace ChipBody CloseBrace\n  ChipBody = InList? OutList? PartList ClockedList?\n  InList = "IN" PinList Semi\n  OutList = "OUT" PinList Semi\n  PartList = BuiltinPart | Parts\n  PinList = List<PinDecl, Comma>\n  PinDecl = Name PinWidth?\n  PinWidth = OpenSquare decNumber CloseSquare\n  BuiltinPart = "BUILTIN" Semi\n  Parts = "PARTS:" Part*\n  Part = Name "(" Wires ")" Semi\n  Wires = List<Wire, Comma>\n  Wire = WireSide Equal (WireSide | True | False) \n  WireSide = Name SubBus? \n  SubBus = OpenSquare decNumber subBusRest? CloseSquare\n  subBusRest = ".." decNumber\n  ClockedList = "CLOCKED" SimplePinList Semi\n  SimplePinList = List<Name, Comma>\n}',mt=e(4533).A.grammar(gt,pt.lN),bt=mt.extendSemantics(pt.JE);bt.addAttribute("SubBus",{SubBus(t,s,e,i){const n=s.value;return{start:n,end:e.child(0)?.child(1)?.value??n}}}),bt.addAttribute("WireSide",{WireSide({name:t},s){const{start:e,end:i}=s.child(0)?.SubBus??{start:void 0,end:void 0};return{pin:t,start:e,end:i,span:(0,pt.Ln)(this.source)}}}),bt.addAttribute("Wire",{Wire(t,s,e){const i=e.isTerminal()?{pin:e.sourceString}:e.WireSide;return{lhs:t.WireSide,rhs:i}}}),bt.addAttribute("Wires",{Wires:t=>t.asIteration().children.map((t=>t.Wire))}),bt.addAttribute("Part",{Part({name:t},s,{Wires:e},i,n){return{name:t,wires:e,span:(0,pt.Ln)(this.source)}}}),bt.addAttribute("Parts",{Parts:(t,s)=>s.children.map((t=>t.Part)),BuiltinPart:(t,s)=>"BUILTIN"}),bt.addAttribute("PartList",{PartList:t=>t.Parts}),bt.addAttribute("Clocked",{ClockedList:(t,s,e)=>s.asIteration().children.map((({sourceString:t})=>t))??[]}),bt.addAttribute("PinDecl",{PinDecl:({name:t},s)=>({pin:t,width:s.child(0)?.child(1)?.value??1})}),bt.addAttribute("PinList",{PinList:t=>t.asIteration().children.map((t=>t.PinDecl))}),bt.addAttribute("Chip",{Chip:(t,s,e,i,n)=>({name:{value:s.sourceString,span:(0,pt.Ln)(s.source)},ins:i.child(0).child(0)?.child(1)?.PinList??[],outs:i.child(1).child(0)?.child(1)?.PinList??[],parts:i.child(2).PartList??[],clocked:i.child(3).child(0)?.Clocked})}),bt.addAttribute("Root",{Root:t=>t.child(0)?.Chip});const ft={parser:mt,grammar:gt,semantics:bt,parse:(0,pt.Q5)(mt,bt,(t=>t.Chip))};function xt(t,s){if(void 0!==s){if(s>=t)return s-t+1;if(t>0&&0===s)return 1;throw new Error(`Bus specification has start > end (${t} > ${s})`)}}async function vt(t,s){if(function(t){return ct.has(t)}(t)||void 0===s)return ut(t);try{const e=await s.readFile(`${t}.hdl`),i=ft.parse(e);let n;if((0,R.HQ)(i)){const t=await yt((0,R.Ok)(i),s);n=(0,R.ys)(t)?(0,R._)(new Error((0,R._)(t).message)):t}else n=(0,R._)(new Error("HDL Was not parsed"));return n}catch(e){return(0,R._)(new Error(`Could not load chip ${t}.hdl`))}}async function yt(t,s,e){return await new $t(t,s,e).build()}function wt(t){return"false"===t||"true"===t||"0"===t||"1"===t}function jt(t){if(void 0!=t.start&&void 0!=t.end)return t.end-t.start+1}function Ct(t){return void 0!=t.start&&void 0!=t.end?`${t.pin}[${t.start}..${t.end}]`:t.pin}function Pt(t,s){return{to:{name:t.pin.toString(),start:t.start??0,width:xt(t.start??0,t.end)},from:{name:s.pin.toString(),start:s.start??0,width:xt(s.start??0,s.end)}}}function Vt(t){if(void 0!=t.start&&void 0!=t.end){const s=[];for(let e=t.start;e<=t.end;e++)s.push(e);return s}return[-1]}function Rt(t,s){let e;const i=s.get(t.pin);if(i)if(i.has(-1))e=t.start??-1;else if(void 0!==t.start&&void 0!==t.end)for(const n of Vt(t))i.has(n)&&(e=n),i.add(n);else i.add(-1);else s.set(t.pin,new Set(Vt(t)));return void 0!=e?(0,R._)((0,pt.$5)(`Cannot write to pin ${t.pin}${-1!=e?`[${e}]`:""} multiple times`,t.span)):(0,R.Ok)()}class $t{parts;fs;expectedName;chip;internalPins=new Map;inPins=new Map;outPins=new Map;wires=[];constructor(t,s,e){this.parts=t,this.expectedName=e,this.fs=s,this.chip=new h.vu(t.ins.map((({pin:t,width:s})=>({pin:t.toString(),width:s}))),t.outs.map((({pin:t,width:s})=>({pin:t.toString(),width:s}))),t.name.value,[],t.clocked)}async build(){if(this.expectedName&&this.parts.name.value!=this.expectedName)return(0,R._)((0,pt.$5)("Wrong chip name",this.parts.name.span));if("BUILTIN"===this.parts.parts)return ut(this.parts.name.value);const t=await this.wireParts();return(0,R.ys)(t)?t:(0,R.Ok)(this.chip)}async wireParts(){if("BUILTIN"===this.parts.parts)return(0,R.Ok)();for(const s of this.parts.parts){const t=await vt(s.name,this.fs);if((0,R.ys)(t))return(0,R._)((0,pt.$5)(`Undefined chip name: ${s.name}`,s.span));const e=(0,R.Ok)(t);if(e.name==this.chip.name)return(0,R._)((0,pt.$5)(`Cannot use chip ${e.name} to implement itself`,s.span));const i=this.wirePart(s,e);if((0,R.ys)(i))return i}let t=this.validateInternalPins();return(0,R.ys)(t)?t:(t=this.validateWireWidths(),(0,R.ys)(t)?t:(0,R.Ok)())}wirePart(t,s){const e=[];this.inPins.clear();for(const{lhs:n,rhs:r}of t.wires){const t=this.validateWire(s,n,r);if((0,R.ys)(t))return t;e.push(Pt(n,r))}try{return this.chip.wire(s,e),(0,R.Ok)()}catch(i){return(0,R._)(i)}}validateWire(t,s,e){if(t.isInPin(s.pin)){const t=this.validateInputWire(s,e);if((0,R.ys)(t))return t}else{if(!t.isOutPin(s.pin))return(0,R._)((0,pt.$5)(`Undefined input/output pin name: ${s.pin}`,s.span));{const i=this.validateOutputWire(t,s,e);if((0,R.ys)(i))return i}}return wt(e.pin)||this.wires.push({chip:t,lhs:s,rhs:e}),(0,R.Ok)()}isInternal(t){return!(this.chip.isInPin(t)||this.chip.isOutPin(t)||wt(t))}validateInputWire(t,s){let e=this.validateInputSource(s);if((0,R.ys)(e))return e;if(e=Rt(t,this.inPins),(0,R.ys)(e))return e;if(this.isInternal(s.pin)){const t=this.internalPins.get(s.pin);void 0==t?this.internalPins.set(s.pin,{isDefined:!1,firstUse:s.span}):t.firstUse=t.firstUse.start<s.span.start?t.firstUse:s.span}return(0,R.Ok)()}validateOutputWire(t,s,e){let i=this.validateWriteTarget(e);if((0,R.ys)(i))return i;if(this.chip.isOutPin(e.pin)){if(i=Rt(e,this.outPins),(0,R.ys)(i))return i}else{if(void 0!==e.start||void 0!==e.end)return(0,R._)((0,pt.$5)(`Cannot write to sub bus of internal pin ${e.pin}`,e.span));const i=this.internalPins.get(e.pin),n=jt(s)??t.get(s.pin)?.width;if(void 0==i)this.internalPins.set(e.pin,{isDefined:!0,firstUse:e.span,width:n});else{if(i.isDefined)return(0,R._)((0,pt.$5)(`Internal pin ${e.pin} already defined`,e.span));i.isDefined=!0,i.width=n}}return(0,R.Ok)()}validateWriteTarget(t){return this.chip.isInPin(t.pin)?(0,R._)((0,pt.$5)(`Cannot write to input pin ${t.pin}`,t.span)):wt(t.pin)?(0,R._)((0,pt.$5)(`Illegal internal pin name: ${t.pin}`,t.span)):(0,R.Ok)()}validateInputSource(t){return this.chip.isOutPin(t.pin)?(0,R._)((0,pt.$5)("Cannot use output pin as input",t.span)):this.chip.isInPin(t.pin)||void 0==t.start?(0,R.Ok)():(0,R._)((0,pt.$5)(wt(t.pin)?"Cannot use sub bus of constant bus":`Cannot use sub bus of internal pin ${t.pin} as input`,t.span))}validateInternalPins(){for(const[t,s]of this.internalPins)if(!s.isDefined)return(0,R._)((0,pt.$5)("true"==t.toLowerCase()||"false"==t.toLowerCase()?`The constants ${t.toLowerCase()} must be in lower-case`:`Undefined internal pin name: ${t}`,s.firstUse));return(0,R.Ok)()}validateWireWidths(){for(const t of this.wires){const s=jt(t.lhs)??t.chip.get(t.lhs.pin)?.width,e=jt(t.rhs)??this.chip.get(t.rhs.pin)?.width??this.internalPins.get(t.rhs.pin)?.width;if(s!=e)return(0,R._)((0,pt.$5)(`Different bus widths: ${Ct(t.lhs)}(${s}) and ${Ct(t.rhs)}(${e})`,t.lhs.span))}return(0,R.Ok)()}}var kt=e(1487),St=e(6554),Lt=e(1106),_t=e(742);class Mt{signBehaviors=new Map;constructor(t,s){if(ct.has(t)){const e=ut(t);if((0,R.HQ)(e)){const t=Array.from((0,R.Ok)(e).ins.entries()).concat(Array.from((0,R.Ok)(e).outs.entries()));for(const e of t)this.signBehaviors.set(e.name,!s||!s.includes(e.name))}}}isSigned(t){return this.signBehaviors.get(t)}}const It=new Map([["Mux4Way16",["sel"]],["Mux8Way16",["sel"]],["DMux4Way",["sel"]],["DMux8Way",["sel"]],["RAM8",["address"]],["RAM64",["address"]],["RAM512",["address"]],["RAM4K",["address"]],["RAM16K",["address"]],["Screen",["address"]],["Memory",["address"]],["CPU",["addressM","pc"]]]),Ot=(0,r.createContext)({});function At(t){return{pin:t,bits:(0,_t.y)(0,t.width).map((s=>[s,t.voltage(s)])).reverse()}}function Ft(t){return[...t.entries()].map(At)}const Tt=t=>{const{inPins:s,outPins:e,internalPins:i}=t.sim,n=(r=t.sim.chip[0].name??"",new Mt(r,It.get(r)));var r;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("style",{children:"\n        table.pinout th {\n          font-weight: bold;\n        }\n\n        table.pinout tbody td:first-child {\n          text-align: right;\n          --font-size: 1rem;\n          width: 0;\n          white-space: nowrap;\n          border-right: var(--border-width) solid var(--table-border-color);\n        }\n\n        table.pinout tbody button {\n          --font-size: 0.875em;\n          font-family: var(--font-family-monospace);\n          max-width: 2em;\n        }\n        "}),(0,a.jsx)("table",{className:"pinout",children:(0,a.jsxs)("tbody",{children:[(0,a.jsx)(Wt,{pins:s,header:"Input pins",toggle:t.toggle,setInputValid:t.setInputValid,displayInfo:n}),(0,a.jsx)(Wt,{pins:e,header:"Output pins",disabled:t.sim.pending,enableEdit:!1,displayInfo:n}),!t.hideInternal&&(0,a.jsx)(Wt,{pins:i,header:"Internal pins",disabled:t.sim.pending,enableEdit:!1,displayInfo:n})]})})]})},Wt=t=>(0,a.jsxs)(a.Fragment,{children:[t.pins.length>0&&(0,a.jsx)("tr",{children:(0,a.jsx)("th",{colSpan:2,children:t.header})}),[...t.pins].map((s=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{children:s.pin.name}),(0,a.jsx)("td",{children:(0,a.jsx)(Nt,{pin:s,toggle:t.toggle,disabled:t.disabled,enableEdit:t.enableEdit,signed:t.displayInfo.isSigned(s.pin.name),setInputValid:t.setInputValid,internal:"Internal pins"===t.header})})]},s.pin.name)))]}),Nt=({pin:t,toggle:s,disabled:e=!1,enableEdit:i=!0,signed:n=!0,setInputValid:o,internal:l=!1})=>{const[c,u]=(0,r.useState)(!0);let h=!0;const[d,p]=(0,r.useState)(""),g=(0,r.useContext)(Ot);g instanceof Et&&g.registerCallback((()=>{u(!0)}));const m=t=>{h=t,o?.(t)},b=e=>{for(let i=0;i<t.bits.length;i++)t.bits[t.bits.length-i-1][1]!==(e>>i&1)&&s?.(t.pin,i)};return(0,r.useEffect)((()=>{if(!c&&h){let s=0;if(n&&t.bits[0][1]){for(const[e,i]of t.bits)e<t.bits.length-1&&!i&&(s+=2**e);s=-s-1}else{const e=n?t.bits.length-1:t.bits.length;for(const[i,n]of t.bits)i<e&&n&&(s+=2**i)}p(s.toString())}}),[t,c]),(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:[(0,a.jsx)("fieldset",{role:"group",style:{width:`${t.bits.length}rem`},children:c?t.bits.map((([i,n])=>(0,a.jsx)("button",{disabled:e,style:l?{backgroundColor:"grey"}:{},onClick:()=>s?.(t.pin,i),"data-testid":`pin-${i}`,children:n},i))):(0,a.jsx)("input",{className:"colored",value:d,onChange:s=>{(s=>{const e=s.replace(/[^\d]/g,""),i=n&&"-"===s[0]?`-${e}`:e;if(p(i),isNaN(parseInt(i)))m(!1);else{const s=parseInt(i);!n&&s>=Math.pow(2,t.bits.length)||n&&(s>=Math.pow(2,t.bits.length-1)||s<-Math.pow(2,t.bits.length-1))?m(!1):(b(s),m(!0))}})(s.target.value)},disabled:!i})}),t.bits.length>1&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{style:{width:"1em"}}),(0,a.jsx)("button",{className:"pin-control",onClick:()=>{u(!c)},children:c?"dec":"bin"})]})]})};class Et{callbacks=[];registerCallback(t){this.callbacks.push(t)}reset(){for(const t of this.callbacks)t()}}var Yt=e(8177),Dt=e(7365),Bt=e(3761);const zt="noScreen",Ut=[["01","Project 1"],["02","Project 2"],["03","Project 3"],["05","Project 5"]];function Ht(t){return t in dt.CHIP_ORDER?dt.CHIP_ORDER[t]:dt.BUILTIN_CHIP_PROJECTS[t].concat(dt.CHIP_PROJECTS[t])}function Kt(t,s){return dt.BUILTIN_CHIP_PROJECTS[t].includes(s)}function Jt(t,s){const e=function(t,s){return Kt(t,s)?dt.ChipProjects[t].BUILTIN_CHIPS[s]:dt.ChipProjects[t].CHIPS[s][`${s}.hdl`]}(t,s);if(Kt(t,s))return e;const i="//// Replace this comment with your code.",n=`BUILTIN ${s};`;return e.includes(i)?e.replace(i,n):e.replace("PARTS:",`PARTS:\n    ${n}`)}function Zt(t,s=!1,e=!1){return{clocked:t.clocked,inPins:Ft(t.ins),outPins:Ft(t.outs),internalPins:Ft(t.pins),chip:[t],pending:s,invalid:e}}const qt=kt.z.get();function Xt(t,s,e,i){const n=function(t){const s=t["/chip/project"]??"01";return{project:s,chips:Ht(s),chipName:t["/chip/chip"]??dt.CHIP_PROJECTS[s][0]}}(e);let{project:r,chipName:a}=n;const{chips:o}=n;let l=new h.ti,c=[],u=new Lt.BX,p=!1,g=!1,m=!1;const b={setFiles(t,{hdl:s=t.files.hdl,tst:e=t.files.tst,cmp:i=t.files.cmp,out:n=""}){t.files.hdl=s,t.files.tst=e,t.files.cmp=i,t.files.out=n},updateChip(t,s){t.sim=Zt(l,s?.pending??t.sim.pending,s?.invalid??t.sim.invalid),t.controls.error=t.sim.invalid?s?.error??t.controls.error:void 0},setProject(t,s){const e=Ht(s),i=t.controls.chipName&&e.includes(t.controls.chipName)?t.controls.chipName:e[0];t.controls.project=s,t.controls.chips=e,this.setChip(t,i)},setChip(t,s){t.controls.chipName=s,t.controls.tests=Array.from(c),t.controls.hasBuiltin=ct.has(s),t.controls.builtinOnly=Kt(t.controls.project,s)},setTest(t,s){t.controls.testName=s},setVisualizationParams(t,s){t.controls.visualizationParameters=new Set(s)},testRunning(t){t.controls.runningTest=!0},testFinished(t){t.controls.runningTest=!1;const e=(0,Dt.U)(t.files.cmp.trim(),t.files.out.trim());s(e?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")},updateTestStep(t){if(t.files.out=u?.log()??"",u?.currentStep?.span)t.controls.span=u.currentStep.span;else if(u.done){const s=t.files.tst.length;t.controls.span={start:s-1,end:s,line:t.files.tst.split("\n").length}}this.updateChip(t,{pending:t.sim.pending,invalid:t.sim.invalid})}},f={setProject(t){r=e["/chip/project"]=t,i.current({action:"setProject",payload:r}),this.setChip(dt.CHIP_PROJECTS[r][0])},async setChip(t,s=e["/chip/project"]??"01"){a=e["/chip/chip"]=t,g=Kt(s,a),g?(i.current({action:"setFiles",payload:{hdl:"",tst:"",cmp:""}}),this.useBuiltin()):(await this.loadChip(s,a),p&&this.useBuiltin()),i.current({action:"setChip",payload:a})},setTest(t){i.current({action:"setTest",payload:t}),i.current({action:"setVisualizationParams",payload:new Set("ComputerAdd.tst"==t||"ComputerMax.tst"==t?[zt]:[])}),this.loadTest(t)},reset(){kt.z.get().reset(),l.reset(),u.reset(),i.current({action:"setFiles",payload:{}}),i.current({action:"updateChip"})},async updateFiles({hdl:t,tst:e,cmp:n}){m=!1,i.current({action:"setFiles",payload:{hdl:t,tst:e,cmp:n}});try{t&&await this.compileChip(t),e&&this.compileTest(e)}catch(r){s((0,ht.V)(r))}i.current({action:"updateChip",payload:{invalid:m}}),m||s("HDL code: No syntax errors")},async compileChip(t){l.remove();const e=await async function(t,s){const e=ft.parse(t.toString());return(0,R.ys)(e)?e:yt((0,R.Ok)(e),void 0,s)}(t,a);if((0,R.ys)(e)){const t=(0,R._)(e);return s((0,R._)(e).message),m=!0,void i.current({action:"updateChip",payload:{invalid:!0,error:t}})}this.replaceChip((0,R.Ok)(e))},replaceChip(t){const s=l.ins;for(const[e,{busVoltage:i}]of s){const s=t.ins.get(e);s&&(s.busVoltage=i)}qt.reset(),t.eval(),l=t,l.reset(),u=u.with(l).reset(),i.current({action:"updateChip",payload:{invalid:!1}}),i.current({action:"updateTestStep"})},async loadChip(s,n){e["/chip/chip"]=n;const r=await t.scandir(`/projects/${s}/${n}`);c=r.filter((t=>t.name.endsWith(".tst"))).map((t=>t.name));const a=await t.readFile((o="hdl",`/projects/${s}/${n}/${n}.${o}`)).catch((()=>function(t){return`CHIP ${t} {\n  IN in;\n  OUT out;\n  PARTS:\n}`}(n)));var o;i.current({action:"setFiles",payload:{hdl:a}}),await this.setTest(c[0]),await this.compileChip(a)},async loadTest(s){const[e,n]=await Promise.all([t.readFile(`/projects/${r}/${a}/${s}`).catch((()=>"repeat 10 {\n  tick,\n  tock;\n}")),t.readFile(`/projects/${r}/${a}/${s}`.replace(".tst",".cmp")).catch((()=>"| in|out|"))]);i.current({action:"setFiles",payload:{cmp:n,tst:e}}),this.compileTest(e)},async saveChip(e,n=r,o=a){i.current({action:"setFiles",payload:{hdl:e}});const l=`/projects/${n}/${o}/${o}.hdl`;await t.writeFile(l,e),s(`Saved ${l}`)},toggle(t,s){void 0!==s?t.busVoltage=t.busVoltage^1<<s:1===t.width?t.toggle():t.busVoltage+=1,i.current({action:"updateChip",payload:{pending:!0}})},eval(){l.eval(),i.current({action:"updateChip",payload:{pending:!1}})},clock(){qt.toggle(),qt.isLow&&qt.frame(),i.current({action:"updateChip"})},async useBuiltin(t=!0,e){if(!t)return g||(p=!1),void await this.loadChip(r,a);g||(p=!0);const n=a,o=ut(n);if((0,R.ys)(o))return void s(`Failed to load builtin ${n}: ${(0,ht.V)((0,R._)(o))}`);e&&await this.saveChip(e,r,a);const l=Jt(r,n);i.current({action:"setFiles",payload:{hdl:l}}),this.replaceChip((0,R.Ok)(o))},async initialize(){await this.setChip(a,r)},compileTest(e){i.current({action:"setFiles",payload:{tst:e}});const n=St.uG.parse(e);return(0,R.ys)(n)?(s(`Failed to parse test ${(0,R._)(n).message}`),m=!0,!1):(u=Lt.BX.from((0,R.Ok)(n),s).with(l).reset(),u.setFileSystem(t),i.current({action:"updateTestStep"}),!0)},async runTest(s){this.compileTest(s)&&(i.current({action:"testRunning"}),t.pushd("/samples"),await u.run(),t.popd(),i.current({action:"updateTestStep"}),i.current({action:"testFinished"}))},tick(){return this.stepTest()},async stepTest(){(0,d.vA)(u.chipId===l.id,"Test and chip out of sync");const t=await u.step();return i.current({action:"updateTestStep"}),t&&i.current({action:"testFinished"}),t},resetFile(){const t=dt.ChipProjects[r].CHIPS[a][`${a}.hdl`];i.current({action:"setFiles",payload:{hdl:t}})},getProjectFiles:async()=>await Promise.all(dt.CHIP_PROJECTS[r].map((s=>({name:`${s}.hdl`,content:t.readFile(`/projects/${r}/${s}/${s}.hdl`)}))))};return{initialState:(()=>{const t={project:r,chips:o,chipName:a,tests:c,testName:"",hasBuiltin:ct.has(a),builtinOnly:Kt(r,a),runningTest:!1,error:void 0,visualizationParameters:new Set},e=ut(t.chipName);(0,R.ys)(e)?(s((0,ht.V)((0,R._)(e))),l=new h.ti):l=(0,R.Ok)(e);return{controls:t,files:{hdl:"",cmp:"",tst:"",out:""},sim:Zt(l)}})(),reducers:b,actions:f}}const Qt=({A:t,op:s,D:e,out:i,flag:n})=>(0,a.jsxs)("div",{className:"alu",children:[(0,a.jsx)("span",{children:"ALU"}),(0,a.jsxs)("svg",{width:"250",height:"250",version:"1.1",children:[(0,a.jsx)("defs",{children:(0,a.jsx)("rect",{x:"34.442518",y:"54.335354",width:"0.91770717",height:"20.780869"})}),(0,a.jsxs)("g",{children:[(0,a.jsx)("polygon",{points:"70,10 180,85 180,165 70,240 70,135 90,125 70,115",stroke:"#000",fill:"#6D97AB"}),(0,a.jsx)("text",{xmlSpace:"preserve",textAnchor:"middle",y:"61",x:"35",fill:"#000000",children:t}),(0,a.jsx)("text",{xmlSpace:"preserve",textAnchor:"middle",y:"176",x:"35",fill:"#000000",children:e}),(0,a.jsx)("text",{xmlSpace:"preserve",textAnchor:"middle",y:"121",x:"207",fill:"#000000",children:i}),(0,a.jsx)("text",{xmlSpace:"preserve",y:"130.50002",x:"110.393929",fill:"#ffffff",fontSize:24,children:q._0.op[s]??"(??)"}),(0,a.jsxs)("g",{children:[(0,a.jsx)("path",{stroke:"black",d:"M 6,67.52217 H 68.675994"}),(0,a.jsx)("path",{stroke:"black",d:"M 68.479388,67.746136 60.290279,61.90711"}),(0,a.jsx)("path",{stroke:"black",d:"m 68.479388,67.40711 -8.189109,5.839026"})]}),(0,a.jsxs)("g",{transform:"translate(0,115.5)",children:[(0,a.jsx)("path",{stroke:"black",d:"M 6,67.52217 H 68.675994"}),(0,a.jsx)("path",{d:"M 68.479388,67.746136 60.290279,61.90711",stroke:"black"}),(0,a.jsx)("path",{stroke:"black",d:"m 68.479388,67.40711 -8.189109,5.839026"})]}),(0,a.jsxs)("g",{transform:"translate(176,57.5)",children:[(0,a.jsx)("path",{stroke:"black",d:"M 6,67.52217 H 68.675994"}),(0,a.jsx)("path",{stroke:"black",d:"M 68.479388,67.746136 60.290279,61.90711"}),(0,a.jsx)("path",{stroke:"black",d:"m 68.479388,67.40711 -8.189109,5.839026"})]})]})]})]});var Gt=e(7437),ts=e(64),ss=e(6537),es=e(4668);function is(t){return(0,a.jsx)(ts.ce,{name:t.name,memory:t.memory,format:t instanceof f?"asm":"dec",highlight:t.address,count:5})}function ns(t,s,e){if(t instanceof Q)return(0,a.jsx)(Qt,{A:t.in("x").busVoltage,op:t.op(),D:t.in("y").busVoltage,out:t.out().busVoltage,flag:t.out("zr").voltage()===h.RY?q.iI.Zero:t.out("ng").voltage()===h.RY?q.iI.Negative:q.iI.Positive});if(t instanceof rt)return(0,a.jsx)(ss.d,{name:t.name??`Chip ${t.id}`,bits:t.bits});if(t instanceof ot)return(0,a.jsx)(ss.d,{name:"PC",bits:t.bits});if(t instanceof v)return(0,a.jsx)(Gt.s,{keyboard:t,update:s});if(t instanceof x)return(0,a.jsx)(es.f,{memory:t.memory});if(t instanceof p)return is(t);if(t instanceof m)return(0,a.jsxs)("span",{children:["RAM ",t.width]});if(t instanceof P){const s=(0,o.D4)(t.in("instruction").busVoltage);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(ss.d,{name:"A",bits:t.state.A}),(0,a.jsx)(ss.d,{name:"D",bits:t.state.D}),(0,a.jsx)(ss.d,{name:"PC",bits:t.state.PC}),(0,a.jsx)(Qt,{A:s.am?t.in("inM").busVoltage:t.state.A,D:t.state.D,out:t.state.ALU,op:s.op,flag:t.state.flag})]})}if(t instanceof V)return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(ss.d,{name:"A",bits:t.cpu.state.A}),(0,a.jsx)(ss.d,{name:"D",bits:t.cpu.state.D}),(0,a.jsx)(ss.d,{name:"PC",bits:t.cpu.state.PC}),!e?.has(zt)&&(0,a.jsx)(es.f,{memory:t.ram.screen.memory}),is(t.rom),is(t.ram.ram)]});const i=[...t.parts].map((t=>ns(t,s))).filter((t=>void 0!==t));return i.length>0?(0,a.jsx)(a.Fragment,{children:i}):void 0}var rs=e(6513),as=e(1091),os=e(5608),ls=e.n(os),cs=e(9267),us=e(8029),hs=e(2675),ds=e(4280);const ps=()=>{const{setStatus:t}=(0,r.useContext)(Bt.L),{tracking:s}=(0,r.useContext)(us.BR),{state:e,actions:o,dispatch:l}=function(){const{fs:t,setStatus:s,storage:e}=(0,r.useContext)(Bt.L),i=(0,r.useRef)((()=>{})),{initialState:n,reducers:a,actions:o}=(0,r.useMemo)((()=>Xt(t,s,e,i)),[t,s,e,i]),[l,c]=(0,Yt.A)(a,n);return i.current=c,{state:l,dispatch:i,actions:o}}(),[c,u]=(0,Yt.b)(e.files.hdl),[h,d]=(0,Yt.b)(e.files.tst),[p,g]=(0,Yt.b)(e.files.cmp),[m,b]=(0,Yt.b)(e.files.out);(0,r.useEffect)((()=>{o.initialize()}),[o]),(0,r.useEffect)((()=>{s.trackPage("/chip")}),[s]),(0,r.useEffect)((()=>{s.trackEvent("action","setProject",e.controls.project),s.trackEvent("action","setChip",e.controls.chipName)}),[]);const f=(0,r.useCallback)((t=>{o.setProject(t),s.trackEvent("action","setProject",t)}),[o,s]),x=(0,r.useCallback)((t=>{o.setChip(t),s.trackEvent("action","setChip",t),A.reset()}),[o,s]),v=(0,r.useCallback)((()=>{o.eval(),s.trackEvent("action","eval")}),[o,s]),y=(0,r.useRef)((()=>{}));y.current=async(t={})=>{var s,i,n;const r=P||e.controls.builtinOnly?t.hdl:null!==(s=t.hdl)&&void 0!==s?s:c;await o.updateFiles({hdl:r,tst:null!==(i=t.tst)&&void 0!==i?i:h,cmp:null!==(n=t.cmp)&&void 0!==n?n:p})},(0,r.useEffect)((()=>{y.current({tst:h,cmp:p}),o.reset()}),[h,p]);const w=(0,r.useRef)();(0,r.useEffect)((()=>(w.current=new class extends as.M{async reset(){await y.current(),await o.reset()}finishFrame(){super.finishFrame(),l.current({action:"updateTestStep"})}async tick(){return await o.stepTest()}toggle(){l.current({action:"updateTestStep"})}},()=>{var t;null===(t=w.current)||void 0===t||t.stop()})),[y,o,l]);const j=(0,r.useMemo)((()=>({toggle(){o.clock(),s.trackEvent("action","toggleClock")},reset(){s.trackEvent("action","resetClock"),o.reset()}})),[o]),C=(0,r.useRef)(null),[P,V]=(0,r.useState)(!1),R=(0,a.jsx)(a.Fragment,{children:(0,a.jsxs)("fieldset",{role:"group",children:[(0,a.jsx)("select",{value:e.controls.project,onChange:({target:{value:t}})=>{f(t)},"data-testid":"project-picker",children:Ut.map((([t,s])=>(0,a.jsx)("option",{value:t,children:s},t)))}),(0,a.jsx)("select",{value:e.controls.chipName,onChange:({target:{value:t}})=>{x(t)},"data-testid":"chip-picker",children:e.controls.chips.map((t=>(0,a.jsx)("option",{value:t,style:Kt(e.controls.project,t)?{color:"var(--light-grey)"}:{},children:`${t} ${Kt(e.controls.project,t)?"(given)":""}`},t)))}),(0,a.jsx)("a",{ref:C,style:{display:"none"}}),(0,a.jsx)("button",{className:"flex-0",onClick:async()=>{if(!C.current)return;const t=await o.getProjectFiles(),s=new(ls());for(const e of t)s.file(e.name,e.content);const i=await s.generateAsync({type:"blob"}),n=URL.createObjectURL(i);C.current.href=n,C.current.download=`${e.controls.project}`,C.current.click(),URL.revokeObjectURL(n)},disabled:e.controls.builtinOnly,"data-tooltip":n.Ru._("Download .hdl files"),"data-placement":"left",children:(0,a.jsx)(i.x6,{id:"Download"})})]})}),$=(0,a.jsx)(ds.Z,{className:"_hdl_panel",header:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{tabIndex:0,children:"HDL"}),(0,a.jsx)("fieldset",{children:(0,a.jsxs)("label",{children:[(0,a.jsx)("input",{type:"checkbox",role:"switch",checked:!!e.controls.builtinOnly||P,onChange:()=>{P?(V(!1),o.useBuiltin(!1)):(V(!0),o.useBuiltin(!0,c)),A.reset()},disabled:e.controls.builtinOnly}),(0,a.jsx)(i.x6,{id:"Builtin"})]})}),R]}),children:(0,a.jsx)(hs.K,{className:"flex-1",value:c,error:e.controls.error,onChange:async t=>{u(t),P||await o.saveChip(t),y.current(P||e.controls.builtinOnly?{}:{hdl:t})},grammar:ft.parser,language:"hdl",disabled:P||e.controls.builtinOnly})}),[k,S]=(0,r.useState)(!0),L=()=>{t(n.Ru._("Cannot test a chip that has syntax errors"))},_=()=>{y.current(P||e.controls.builtinOnly?{}:{hdl:c})},M=()=>{e.sim.invalid?L():v()},I=(0,a.jsxs)("fieldset",{role:"group",children:[(0,a.jsx)("button",{onClick:M,onKeyDown:M,onBlur:_,disabled:!e.sim.pending||!k,children:(0,a.jsx)(i.x6,{id:"Eval"})}),(0,a.jsxs)("button",{onClick:()=>{e.sim.invalid?L():j.toggle()},onBlur:_,style:{maxWidth:"initial"},disabled:!e.sim.clocked,children:[(0,a.jsx)(i.x6,{id:"Clock"}),":","\xa0",(0,a.jsx)(rs.wr,{})]}),(0,a.jsx)("button",{onClick:()=>{e.sim.invalid?L():j.reset()},onBlur:_,style:{maxWidth:"initial"},disabled:!e.sim.clocked,children:(0,a.jsx)(i.x6,{id:"Reset"})})]}),O=function(t,s,e){return[...t.parts].map(((t,i)=>[`${t.id}_${i}`,ns(t,s,e)])).filter((([t,s])=>void 0!==s))}({parts:e.sim.chip},(()=>{l.current({action:"updateChip"})}),e.controls.visualizationParameters),A=new Et,F=(0,a.jsx)(ds.Z,{className:"_parts_panel",header:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{children:[(0,a.jsx)(i.x6,{id:"Chip"})," ",e.controls.chipName]}),I]}),children:e.sim.invalid?(0,a.jsx)(i.x6,{id:"Syntax errors in the HDL code or test"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Ot.Provider,{value:A,children:(0,a.jsx)(Tt,{sim:e.sim,toggle:o.toggle,setInputValid:S,hideInternal:e.controls.builtinOnly||P})}),O.length>0&&(0,a.jsx)(ds.p,{summary:(0,a.jsx)(i.x6,{id:"Visualization"}),open:!0,children:(0,a.jsx)("main",{children:O.map((([t,s])=>s))})})]})}),T=(0,a.jsx)(cs.B,{runner:w,disabled:e.sim.invalid,showLoad:!1,prefix:e.controls.tests.length>1?(0,a.jsx)("select",{value:e.controls.testName,onChange:({target:{value:t}})=>{o.setTest(t)},"data-testid":"test-picker",children:e.controls.tests.map((t=>(0,a.jsx)("option",{value:t,children:t},t)))}):(0,a.jsx)(a.Fragment,{}),tst:[h,d,e.controls.span],cmp:[p,g],out:[m,b]});return(0,a.jsxs)("div",{className:"Page ChipPage grid",children:[$,F,T]})},gs=ps}}]);
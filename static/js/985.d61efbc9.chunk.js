"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[985],{558:(t,e,s)=>{s.d(e,{F:()=>b});var n=s(5072),i=s(4913),r=s(6791),a=s(5692),o=s(7880),c=s(4430),l=s(4619),h=s(6845),u=s(8722),d=s(7457),p=s(9200),m=s(8398),g=s(864);const f="skipTestEditWarning",b=t=>{var e,s;let{runner:b,tst:[y,v,S],cmp:[A,w],out:[x],setPath:C,disabled:k=!1,defaultTst:I,defaultCmp:T,showClear:O=!1,onSpeedChange:L,compileTest:_}=t;const{fs:E,setStatus:R}=(0,h.useContext)(a.r),{filePicker:M,tracking:P}=(0,h.useContext)(u.Il),[F,N]=(0,h.useState)(!0),j=(0,h.useRef)();(0,h.useEffect)((()=>(j.current=new class extends l.B{async reset(){var t;await(null===(t=b.current)||void 0===t?void 0:t.reset()),N(!0)}finishFrame(){var t;super.finishFrame(),null===(t=b.current)||void 0===t||t.finishFrame()}async tick(){var t,e;return N(!0),null!==(t=await(null===(e=b.current)||void 0===e?void 0:e.tick()))&&void 0!==t&&t}toggle(){var t;null===(t=b.current)||void 0===t||t.toggle()}},()=>{var t;null===(t=j.current)||void 0===t||t.stop()})),[b]);const[$,G]=(0,h.useState)("tst"),D=(0,h.useCallback)((t=>{G(t),P.trackEvent("tab","change",t)}),[P]),[U,H]=(0,h.useState)(!1),[V,B]=(0,h.useState)(!1),[z,Z]=(0,h.useState)(""),[W,K]=(0,h.useState)(""),q=(0,d.R)(),Y=(0,h.useCallback)((async()=>{try{var t;const s=await M.select();null===C||void 0===C||C(s);const n=await E.readFile(s);let i;try{const t=s.replace("VME.tst",".tst").replace(".tst",".cmp");i=await E.readFile(t)}catch(e){}null===v||void 0===v||v(n),null===w||void 0===w||w(null!==(t=i)&&void 0!==t?t:"")}catch(e){console.error(e),R("Failed to load test")}}),[M,R,E]),[X,J]=(0,h.useState)();(0,h.useEffect)((()=>{J((0,i.B)(A,x))}),[x,A]);const Q=(0,g.jsx)("dialog",{open:q.isOpen,children:(0,g.jsxs)("article",{children:[(0,g.jsx)("header",{children:"Warning"}),(0,g.jsxs)("main",{children:[(0,g.jsxs)("p",{children:["The test script can be edited during this IDE session. In the next session, the original script will be restored.",(0,g.jsx)("br",{})]}),(0,g.jsxs)("div",{style:{display:"flex",flexDirection:"row"},children:[(0,g.jsx)("input",{type:"checkbox",checked:V,onChange:t=>{B(t.target.checked)}}),(0,g.jsx)("p",{children:"Do not show this again"})]}),(0,g.jsx)("p",{children:(0,g.jsx)("br",{})}),(0,g.jsx)("button",{onClick:()=>{V&&localStorage.setItem(f,"true"),q.close()},children:"Ok"})]})]})});return(0,g.jsx)(m.s,{className:"_test_panel",header:(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)("div",{className:"flex-0",children:(0,g.jsx)(n.cC,{id:"Test"})}),(0,g.jsx)("fieldset",{role:"group"}),Q,(0,g.jsx)("div",{className:"flex-1",children:j.current&&(0,g.jsx)(r.D,{prefix:(0,g.jsxs)(g.Fragment,{children:[O&&(0,g.jsx)("button",{className:"flex-0",onClick:()=>{v(null!==I&&void 0!==I?I:""),w(null!==T&&void 0!==T?T:"")},children:"Clear"}),U?(0,g.jsx)("button",{className:"flex-0",onClick:()=>{H(!1),v(z),w(W)},children:"Restore"}):(0,g.jsx)("button",{className:"flex-0",onClick:()=>{localStorage.getItem(f)||q.open(),H(!0),Z(y),K(A)},children:"Edit"}),(0,g.jsx)("button",{className:"flex-0",onClick:Y,children:"\ud83d\udcc2"})]}),runner:j.current,disabled:k,onSpeedChange:L})})]}),children:(0,g.jsxs)("div",{role:"tablist",style:{"--tab-count":"3"},children:[(0,g.jsx)("div",{role:"tab",id:"test-tab-tst","aria-controls":"test-tabpanel-tst","aria-selected":"tst"===$,children:(0,g.jsxs)("label",{children:[(0,g.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-tst",value:"tst",checked:"tst"===$,onChange:()=>D("tst")}),"Test Script"]})}),(0,g.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-tst",id:"test-tabpanel-tst",children:(0,g.jsx)(p.M,{value:y,onChange:t=>{v(t),N(!1)},grammar:c.qH.parser,language:"tst",disabled:!U,highlight:F?S:void 0})}),(0,g.jsx)("div",{role:"tab",id:"test-tab-cmp","aria-controls":"test-tablpanel-cmp","aria-selected":"cmp"===$,children:(0,g.jsxs)("label",{children:[(0,g.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-cmp",value:"cmp",checked:"cmp"===$,onChange:()=>D("cmp")}),"Compare File"]})}),(0,g.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-cmp",id:"test-tabpanel-cmp",style:{position:"relative"},children:(0,g.jsx)(p.M,{value:A,onChange:w,grammar:o.lA.parser,language:"cmp",lineNumberTransform:t=>"",disabled:!U})}),(0,g.jsx)("div",{role:"tab",id:"test-tab-out","aria-controls":"test-tabpanel-out","aria-selected":"out"===$,children:(0,g.jsxs)("label",{children:[(0,g.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-out",value:"out",checked:"out"===$,onChange:()=>D("out")}),"Output File"]})}),(0,g.jsxs)("div",{role:"tabpanel",id:"test-tabpanel-out","aria-labelledby":"test-tab-out",children:[""==x&&(0,g.jsx)("p",{children:"Execute test script to compare output."}),(null!==(e=null===X||void 0===X?void 0:X.failureNum)&&void 0!==e?e:0)>0&&(0,g.jsxs)("p",{children:[null===X||void 0===X?void 0:X.failureNum," comparison failure",1===(null===X||void 0===X?void 0:X.failureNum)?"":"s",". Scroll down for details"]}),(0,g.jsx)(p.M,{value:null!==(s=null===X||void 0===X?void 0:X.text)&&void 0!==s?s:"",onChange:()=>{},language:"",disabled:!0,lineNumberTransform:t=>"",customDecorations:null===X||void 0===X?void 0:X.correctCellSpans.map((t=>({span:t,cssClass:"green"}))).concat(null===X||void 0===X?void 0:X.incorrectCellSpans.map((t=>({span:t,cssClass:"red"}))))})]})]})})}},3478:(t,e,s)=>{s.d(e,{N:()=>c});var n=s(864),i=s(6845),r=s(2869);const a={Enter:128,Backspace:129,ArrowLeft:130,ArrowUp:131,ArrowRight:132,ArrowDown:133,Home:134,End:135,PageUp:136,PageDown:137,Insert:138,Delete:139,Escape:140,F1:141,F2:142,F3:143,F4:144,F5:145,F6:146,F7:147,F8:148,F9:149,F10:150,F11:151,F12:152},o={ArrowLeft:"L-arrow",ArrowUp:"U-arrow",ArrowRight:"R-arrow",ArrowDown:"D-arrow"};const c=t=>{let{keyboard:e,update:s}=t;const[c,l]=(0,i.useState)(!1),[h,u]=(0,i.useState)(""),[d,p]=(0,i.useState)(e.getKey());let m=0;const g=t=>{if(!c)return;u(function(t){return o[t]??t}(t.key));const e=function(t){const e=a[t.key];if(void 0!==e)return e;if(1===t.key.length){const e=t.key.charCodeAt(0);if(e>=32&&e<=126)return e}return 0}(t);e!==m&&(b(e),s?.())},f=t=>{c&&(m=0,e.clearKey(),s?.(),p(e.getKey()),u(""))},b=t=>{0!==t&&(e.setKey(t),p(e.getKey()),m=t)};return(0,i.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",f),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",f)}))),(0,n.jsxs)("div",{className:"flex row align-baseline",children:[(0,n.jsx)("div",{className:"flex-2",children:(0,n.jsx)(r.y,{name:"Key",bits:d})}),(0,n.jsxs)("div",{className:"flex-2",children:["Char: ",h]}),(0,n.jsx)("div",{className:"flex-3",children:(0,n.jsx)("button",{onClick:()=>{l(!c)},children:(c?"Disable":"Enable")+" Keyboard"})})]})}},3577:(t,e,s)=>{s.d(e,{zp:()=>A,ZP:()=>w});var n=s(864),i=s(4089),r=s(6845),a=s(2201),o=s(6699),c=s(6871),l=s(5150),h=s(5554),u=s(2936),d=s(6604);const p=0,m=1,g=t=>{const[e,s]=(0,r.useState)(t.mode??p),[i,a]=(0,d.i)(t.value),o=()=>(0,n.jsxs)("div",{style:{cursor:"text",...(0,u.b)("full","inline")},onClick:()=>{s(m)},children:[i,"\xa0"]}),c=(0,r.useCallback)((t=>t?.select()),[]),l=(0,r.useCallback)((e=>{s(p),a(e.value??""),t.onChange(e.value??"")}),[t,s,a]),h=()=>(0,n.jsx)("span",{style:{display:"block",position:"relative"},children:(0,n.jsx)("input",{ref:c,style:{zIndex:"10",position:"absolute",left:"0",marginTop:"-0.375rem",color:"var(--text-color)"},onFocus:t.onFocus,onBlur:t=>{let{target:e}=t;return l(e)},onKeyPress:t=>{let{key:e,target:s}=t;"Enter"===e&&l(s)},type:"text",defaultValue:i})});return(()=>{switch(e){case m:return h();case p:return o();default:return(0,n.jsx)("span",{})}})()};var f=s(5692);function b(t,e,s){const{totalHeight:n,toleranceHeight:i,bufferedItems:r,settings:{itemHeight:a,minIndex:o,maxIndex:c}}=e,l=o+Math.floor((t-i)/a),h=function(t,e,s,n,i){const r=Math.max(0,t,s);return[...i(r,Math.min(e,s+n-1)-r)]}(o,c,l,r,s),u=Math.max((l-o)*a,0);return{scrollTop:t,topPaddingHeight:u,bottomPaddingHeight:Math.max(n-(u+h.length*a),0),data:h}}const y=t=>{const e=(0,r.useRef)(null),{settings:s,startState:i,reducer:a}=(0,r.useMemo)((()=>{const e=function(t){const{minIndex:e=0,maxIndex:s=Number.MAX_SAFE_INTEGER,startIndex:n=0,itemHeight:i=20,count:r=Math.max(s-e,1),tolerance:a=r}=t;return{minIndex:e,maxIndex:s,startIndex:n,itemHeight:i,count:r,tolerance:a}}(t.settings??{}),s=function(t,e){const{minIndex:s,maxIndex:n,startIndex:i,itemHeight:r,count:a,tolerance:o}=t,c=a+2*o,l=Math.max(0,i-o-s),h=a*r,u=Math.max(n-s,1)*r,d=o*r,p=l*r,m={scrollTop:0,settings:t,viewportHeight:h,totalHeight:u,toleranceHeight:d,bufferedItems:c,topPaddingHeight:p,bottomPaddingHeight:u-(p+(h+2*d)),data:[]};return{...m,...b(p+d,m,e)}}(e,t.get),n=(i=t.get,(t,e)=>({...t,...b(e,t,i)}));var i;return{settings:e,reducer:n,startState:s}}),[t.settings,t.get]),[o,c]=(0,r.useReducer)(a,i);(0,r.useEffect)((()=>{null!==e.current&&c(e.current.scrollTop)}),[s,t.row]);const l=(0,r.useCallback)((t=>{t&&(t.scrollTop=e.current?e.current.scrollTop:s.startIndex*s.itemHeight),e.current=t}),[e,s.startIndex,s.itemHeight]),h=o.data.map((e=>(0,n.jsx)("div",{style:{height:`${s.itemHeight}px`},children:t.row(e)},t.rowKey(e))));return(0,n.jsxs)("div",{ref:l,style:{height:`${o.viewportHeight}px`,overflowY:"scroll",overflowAnchor:"none"},className:t.className??"",onScroll:t=>c(t.target.scrollTop),children:[(0,n.jsx)("div",{style:{height:`${o.topPaddingHeight}px`}}),h,(0,n.jsx)("div",{style:{height:`${o.bottomPaddingHeight}px`}})]})},v=t=>{let{memory:e,jmp:s={value:0},highlight:i=-1,editable:a=!1,justifyLeft:o=!1,maxSize:c,offset:h=0,cellLabels:u,format:d=l.E_,onChange:p=(()=>{}),onFocus:m=(()=>{})}=t;const g=(0,r.useMemo)((()=>({count:Math.min(e.size,25),maxIndex:c??e.size,itemHeight:34,startIndex:s.value})),[e.size,s]),f=(0,r.useCallback)(((t,s)=>e.range(t+h,t+h+s).map(((s,n)=>[n+t+h,{value:s,wasChanged:e.wasChanged(n+t+h)}]))),[e]),b=(0,r.useCallback)((t=>{let[s,r]=t;return(0,n.jsx)(S,{index:s,value:r.wasChanged?d(r.value):"",label:(u?.[s]??"").padStart(u?Math.max(...u.map((t=>t.length))):0),showLabel:void 0!=u,size:e.size,editable:a,justifyLeft:o,highlight:s===i,onChange:p,onFocus:m})}),[d,a,i,p]);return(0,n.jsx)(y,{settings:g,get:f,row:b,rowKey:t=>{let[e]=t;return e}})},S=t=>{let{index:e,value:s,label:r,showLabel:a=!1,size:o,highlight:c=!1,editable:h=!1,justifyLeft:u=!1,onChange:d=(()=>{}),onFocus:p=(()=>{})}=t;return(0,n.jsxs)("div",{style:{display:"flex",height:"100%"},children:[a&&(0,n.jsx)("code",{style:{...(0,i.eP)("none"),...c?{background:"var(--mark-background-color)"}:{},whiteSpace:"pre"},children:r??""}),(0,n.jsx)("code",{style:{...(0,i.eP)("none"),...c?{background:"var(--mark-background-color)"}:{},whiteSpace:"pre"},children:o?(0,l.E_)(e).padStart(Math.ceil(Math.log10(o))," "):(0,l.E_)(e)}),(0,n.jsx)("code",{style:{flex:"1",textAlign:u?"left":"right",color:"var(--text-color)",...(0,i.eP)("none"),...c?{background:"var(--mark-background-color)"}:{}},children:h?(0,n.jsx)(g,{value:s,highlight:c,onChange:t=>d(e,t,Number(s)),onFocus:()=>p(e)}):(0,n.jsx)("span",{style:{color:"var(--text-color)"},children:s})})]})},A=(0,r.forwardRef)(((t,e)=>{let{name:s="Memory",className:i,displayEnabled:u=!0,highlight:p=-1,editable:m=!0,memory:g,format:b="dec",maxSize:y,offset:S,initialAddr:A,cellLabels:w,showUpload:x=!0,showClear:C=!0,onUpload:k,onChange:I}=t;const[T,O]=(0,d.i)(b),[L,_]=(0,r.useState)(""),[E,R]=(0,r.useState)({value:A??0}),[M,P]=(0,d.i)(p),[F,N]=(0,r.useState)(0),j=()=>{const t=!isNaN(parseInt(L))&&isFinite(parseInt(L))?Number(L):0;P(t),R({value:t}),H()},$=(0,r.useRef)(null),G=(0,r.useCallback)((()=>{I?.(),$.current?.click()}),[$]),{setStatus:D}=(0,r.useContext)(f.r),U=(0,r.useCallback)((async t=>{if(!t.target.files?.length)return void D("No file selected");const e=t.target.files[0];k?.(e.name);const s=await e.text(),n=e.name.endsWith("hack")?o.$W:e.name.endsWith("asm")?o.eC:o.uC,i=await n(s);g.loadBytes(i),t.target.value="",O(e.name.endsWith("hack")?"bin":e.name.endsWith("asm")?"asm":T),j()}),[]),H=()=>{N(F+1)};(0,r.useImperativeHandle)(e,(()=>({rerender:H})));return(0,h._W)((()=>{_(""),R({value:0})})),(0,n.jsxs)("article",{className:`panel memory ${i??s}`,children:[(0,n.jsxs)("header",{children:[(0,n.jsx)("div",{style:{whiteSpace:"nowrap"},children:s}),(0,n.jsxs)("fieldset",{role:"group",children:[(0,n.jsx)("input",{type:"file",style:{display:"none"},ref:$,onChange:U}),x&&(0,n.jsx)("button",{onClick:G,className:"flex-0","data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"}),C&&(0,n.jsx)("button",{onClick:()=>{g.reset(),I?.(),H()},className:"flex-0","data-tooltip":"Clear","data-placement":"bottom",children:"\ud83c\udd91"}),(0,n.jsx)("input",{style:{width:"4em",height:"100%"},placeholder:"Addr",value:L,onKeyDown:t=>{let{key:e}=t;return"Enter"===e&&j()},onChange:t=>{let{target:{value:e}}=t;return _(e)}}),(0,n.jsx)("button",{onClick:j,className:"flex-0","data-tooltip":"Scroll to address","data-placement":"bottom",children:"\u2935\ufe0f"}),(0,n.jsx)("select",{value:T,onChange:t=>O(t.target.value),children:a.I2.map((t=>(0,n.jsx)("option",{children:t},t)))})]})]}),u?(0,n.jsx)(v,{jmp:E,memory:g,highlight:M,editable:m,justifyLeft:"asm"==T,format:t=>function(t,e){switch(t){case"bin":return(0,l.Ly)(e);case"hex":return(0,l.$v)(e);case"asm":return(0,c.a)(e);default:return(0,l.E_)(e)}}(T,t),cellLabels:w,maxSize:y,offset:S,onChange:(t,e)=>{g.update(t,e,T??"dec"),I?.(),H()},onFocus:t=>P(t)},F):"Memory display is disabled"]})}));A.displayName="Memory";const w=A},2869:(t,e,s)=>{s.d(e,{y:()=>r});var n=s(864),i=s(5150);const r=t=>{let{name:e,bits:s}=t;return(0,n.jsxs)("div",{children:[e,": ",(0,i.E_)(s)]})}},8963:(t,e,s)=>{s.d(e,{l:()=>l});var n=s(864),i=s(7239),r=s(6845),a=s(5554);const o="white";function c(t,e,s,n){const i=4*(512*s+e),r=n===o?255:0;t[i]=r,t[i+1]=r,t[i+2]=r,t[i+3]=255}const l=t=>{let{memory:e,scale:s=1}=t;const l=(0,r.useRef)(),h=(0,r.useCallback)((()=>{const t=l.current?.getContext("2d")??void 0;t&&function(t,e){const s=(0,i.kP)(t.getImageData(0,0,512,256),"Failed to create Context2d");for(let i=0;i<512;i++)for(let t=0;t<256;t++){const a=(n=i,r=t,0===(e.get(32*r+(n/16|0))&1<<n%16)?o:"black");c(s.data,i,t,a)}var n,r;t.putImageData(s,0,0)}(t,e)}),[e]),u=(0,r.useCallback)((t=>{l.current=t??void 0,h()}),[l,h]);return(0,a.RC)(h),(0,a._W)((()=>{l.current?.getContext("2d")?.clearRect(0,0,l.current.width,l.current.height)})),(0,n.jsxs)("article",{className:"panel",children:[(0,n.jsx)("header",{children:"Screen"}),(0,n.jsx)("main",{style:{backgroundColor:"var(--code-background-color)"},children:(0,n.jsx)("figure",{style:{width:512*s+"px",height:256*s+"px",boxSizing:"content-box",marginInline:"auto",margin:"auto",borderTop:"2px solid gray",borderLeft:"2px solid gray",borderBottom:"2px solid lightgray",borderRight:"2px solid lightgray"},children:(0,n.jsx)("canvas",{ref:u,width:512,height:256,style:{transform:`translate(-50%, -50%) scale(${s}) translate(50%, 50%)`,imageRendering:"pixelated"}})})})]})}},5554:(t,e,s)=>{s.d(e,{RC:()=>o,_W:()=>c,uY:()=>h});var n=s(864),i=s(6845),r=s(554),a=s(5424);function o(t){(0,i.useEffect)((()=>{const e=a.S.get().frame$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function c(t){(0,i.useEffect)((()=>{const e=a.S.get().reset$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function l(){return(0,r.j)(a.S.get())}const h=()=>{const t=function(){const[t,e]=(0,i.useState)(l());return(0,i.useEffect)((()=>{const t=a.S.get().$.subscribe((()=>{e(l())}));return()=>t.unsubscribe()}),[]),t}();return(0,n.jsx)("span",{style:{whiteSpace:"nowrap"},children:t})}},4913:(t,e,s)=>{s.d(e,{B:()=>o,q:()=>a});var n=s(7054),i=s(7880);function r(t,e){const s=[];for(let n=0;n<Math.min(t.length,e.length);n++){const i=t[n]??[],r=e[n]??[];for(let t=0;t<Math.max(i.length,r.length);t++){const e=i[t]??"",a=r[t]??"";null===e?.trim().match(/^\*+$/)&&a!==e&&s.push({row:n,col:t,expected:e,given:a})}}return s}function a(t,e){const s=i.lA.parse(t),a=i.lA.parse(e);if((0,n.dZ)(s)||(0,n.dZ)(a))return!1;return 0==r((0,n.Ok)(s),(0,n.Ok)(a)).length}function o(t,e){const s=i.lA.parse(t),a=i.lA.parse(e);if((0,n.dZ)(s)||(0,n.dZ)(a))return{text:"",failureNum:0,correctCellSpans:[],incorrectCellSpans:[]};const o=(0,n.Ok)(s),l=r(o,(0,n.Ok)(a)),h=new Array(o.length);for(const n of l){const t=h[n.row];t?t.push(n):h[n.row]=[n]}const u=e.split("\n"),d=new Array(o.length);for(let n=0;n<h.length;n++)h[n]&&(d[n]=c(u[n],h[n]));const p=[];let m=0;const g=[],f=[];for(let n=0;n<u.length;n++){const t=d[n];t?(p.push(t.expectedLine),g.push(...t.correctCellSpans.map((t=>({start:t.start+m,end:t.end+m,line:t.line})))),m+=t.expectedLine.length+1,p.push(t.givenLine),f.push(...t.correctCellSpans.map((t=>({start:t.start+m,end:t.end+m,line:t.line})))),m+=t.givenLine.length+1):(p.push(u[n]),m+=u[n].length+1)}return{text:p.join("\n"),failureNum:l.length,correctCellSpans:g,incorrectCellSpans:f}}function c(t,e){const s=t.split("|").filter((t=>""!=t)),n=s.map((t=>" ".repeat(t.length))),i=[];let r=0;for(let c=0;c<s.length;c++)i.push(r+1),r+=s[c].length+1;const a=[],o=[];for(const c of e){s[c.col]=c.expected,n[c.col]=c.given;const t={start:i[c.col],end:i[c.col]+c.expected.length,line:0};a.push(t),o.push(t)}return{expectedLine:`|${s.join("|")}|`,givenLine:`|${n.join("|")}|`,correctCellSpans:a,incorrectCellSpans:o}}},2369:(t,e,s)=>{s.d(e,{Ff:()=>v,Jx:()=>b,Z9:()=>S,Zu:()=>r,aL:()=>y});var n=s(137),i=s(2201);function r(){return{A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero}}const a=32768,o=36864,c=36864,l=36864,h=4032,u=32800,d=32784,p=32776,m=32769,g=32770,f=32772;function b(t){function e(e){return(t&e)===e}return{c:e(a),x1:e(o),x2:e(c),am:e(l),op:(t&h)>>6,d1:e(u),d2:e(d),d3:e(p),j1:e(m),j2:e(g),j3:e(f)}}function y(t,e){let{inM:s,instruction:i}=t,{A:r,D:a,PC:o}=e;const c=b(i),l=c.am?s:r,[h,u]=(0,n.Bb)(c.op,a,l);return c.d2&&(a=h),[{A:r,D:a,PC:o+1,ALU:h,flag:u},c.d3]}function v(t,e){let{inM:s,instruction:i,reset:r}=t,{A:a,D:o,PC:c,ALU:l,flag:h}=e;const u=b(i),d=u.j1&&h===n.vU.Positive,p=u.j2&&h===n.vU.Zero,m=u.j3&&h===n.vU.Negative;c=r?0:d||p||m?a:c,u.c?u.d1&&(a=l):a=32767&i;const g=u.am?s:a,f=(0,n.Bb)(u.op,o,g);l=f[0],h=f[1];return[{addressM:a,outM:l,writeM:u.d3},{A:a,D:o,ALU:l,flag:h,PC:c}]}class S{RAM;ROM;Screen;Keyboard;#t=0;#e=0;#s=0;#n={A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero};get state(){return this.#n}get PC(){return this.#t}get A(){return this.#e}get D(){return this.#s}setA(t){this.#e=t}setD(t){this.#s=t}setPC(t){this.#t=t}constructor(t){let{RAM:e=new i.FH,ROM:s}=t;this.RAM=e,this.ROM=s,this.Screen=new i.kG(this.RAM,i.yJ,i.GD),this.Keyboard=new i.qT(this.RAM)}reset(){this.#t=0,this.#e=0,this.#s=0}tick(){const t=this.#e,[{outM:e,writeM:s},{A:i,D:r,PC:a}]=function(t,e){const[s,n]=y(t,e);return v(t,s)}({inM:this.RAM.get(this.#e),instruction:this.ROM.get(this.#t),reset:!1},{A:this.#e,D:this.#s,PC:this.#t,ALU:this.#s,flag:n.vU.Zero});this.#e=i,this.#s=r,this.#t=a,s&&this.RAM.set(t,e)}}},7880:(t,e,s)=>{s.d(e,{lA:()=>c});var n=s(9814),i=s(3484);const r="\nCmp <: Base {\n  Root := line*\n  line = bar cell+ newline?\n  cell = cellvalue bar\n  cellvalue = (~(bar|newline) any)*\n}",a=n.Z.grammar(r,i.y1),o=a.extendSemantics(i.rJ);o.addAttribute("cell",{cell:(t,e)=>t.sourceString}),o.addAttribute("line",{line:(t,e,s)=>e.children.map((t=>t.cell))}),o.addAttribute("root",{Root:t=>t.children.map((t=>t.line))});const c={grammar:r,semantics:o,parser:a,parse:(0,i.Pz)(a,o)}},4430:(t,e,s)=>{s.d(e,{qH:()=>c});var n=s(9814),i=s(3484);const r='\nTst <: Base {\n  Root := Tst\n  Tst = (TstStatement | TstRepeat | TstWhile)+\n\n  TstRepeat = Repeat Number? OpenBrace TstCommand+ CloseBrace\n  TstWhile = While Condition OpenBrace TstCommand+ CloseBrace\n  TstStatement = TstCommand\n\n  TstCommand = TstOperation Separator\n  Separator = (Semi | Bang | Comma)\n\n  TstOperation =\n    | TstFileOperation\n    | TstOutputListOperation\n    | TstEvalOperation\n    | TstSetOperation\n    | TstOutputOperation\n    | TstEchoOperation\n    | TstClearEchoOperation\n    | TstLoadROMOperation\n\n  TstLoadROMOperation = ROM32K Load FileName\n  TstFileOperation = FileOperation FileName?\n  TstOutputListOperation = "output-list" OutputFormat+\n  OutputFormat = Name Index? FormatSpec?\n  FormatSpec = percent FormatStyle wholeDec dot wholeDec dot wholeDec\n  TstSetOperation = Set Name Index? Number\n  Index = OpenSquare wholeDec? CloseSquare\n  Condition = Value CompareOp Value\n  TstEvalOperation = Eval | TickTock | Tick | Tock | VmStep\n  TstOutputOperation = Output\n  TstEchoOperation = Echo String\n  TstClearEchoOperation = ClearEcho\n\n  FileName = Name\n  FileOperation = "load" | "output-file" | "compare-to"\n\n  Set = "set"\n  Eval = "eval"\n  Tick = "tick"\n  Tock = "tock"\n  TickTock = "ticktock"\n  VmStep = "vmstep"\n  Echo = "echo"\n  Repeat = "repeat"\n  ClearEcho = "clear-echo"\n  Output = "output"\n  OutputList = "output-list"\n  FormatStyle = "B"|"D"|"S"|"X"\n  ROM32K = "ROM32K"\n  Load = "load"\n  While = "while"\n\n  CompareOp = "<>" | "<=" | ">=" | "=" | "<" | ">"\n}',a=n.Z.grammar(r,i.y1),o=a.extendSemantics(i.rJ);o.extendAttribute("value",{Index:(t,e,s)=>e?.child(0)?.value??-1}),o.extendAttribute("name",{FileName(t){let{name:e}=t;return e}}),o.addAttribute("index",{Index:(t,e,s)=>e.child(0)?.value??0}),o.addAttribute("formatSpec",{FormatSpec(t,e,s,n,i,r,a){let{sourceString:o}=e,{value:c}=s,{value:l}=i,{value:h}=a;return{style:o,width:l,lpad:c,rpad:h}}}),o.addAttribute("format",{OutputFormat(t,e,s){let{name:n}=t;return{id:n,builtin:void 0!==e?.child(0),address:e?.child(0)?.value??-1,format:s?.child(0)?.formatSpec}}}),o.addAttribute("operation",{TstEvalOperation:t=>({op:t.sourceString}),TstOutputOperation:t=>({op:"output"}),TstOutputListOperation:(t,e)=>({op:"output-list",spec:e.children.map((t=>t.format))}),TstSetOperation(t,e,s,n){let{name:i}=e,{value:r}=n;const a={op:"set",id:i,value:r},o=s.child(0)?.child(1)?.child(0);return o&&(a.index=o.value),a},TstEchoOperation:(t,e)=>({op:"echo",message:e.String}),TstClearEchoOperation:t=>({op:"clear-echo"}),TstLoadROMOperation(t,e,s){let{name:n}=s;return{op:"loadRom",file:n}},TstFileOperation:(t,e)=>({op:t.sourceString,file:e?.sourceString})}),o.addAttribute("command",{TstCommand(t,e){return{op:t.operation,separator:e.sourceString,span:(0,i.yP)(this.source)}}}),o.addAttribute("condition",{Condition(t,e,s){let{value:n}=t,{sourceString:i}=e,{value:r}=s;return{left:n,right:r,op:i}}}),o.addAttribute("statement",{TstWhile(t,e,s,n,r){return{statements:n.children.map((t=>t.command)),condition:e.condition,span:(0,i.yP)(this.source)}},TstRepeat(t,e,s,n,r){return{statements:n.children.map((t=>t.command)),count:e.sourceString?Number(e.sourceString):-1,span:(0,i.yP)(this.source)}},TstStatement:t=>t.command}),o.addAttribute("tst",{Tst:t=>({lines:t.children.map((t=>t.statement))})}),o.addAttribute("root",{Root(t){let{tst:e}=t;return e}});const c={grammar:r,semantics:o,parser:a,parse:(0,i.Pz)(a,o)}},7529:(t,e,s)=>{s.d(e,{h:()=>u});var n=s(7239),i=s(2836),r=s(1003),a=s(8038),o=s(4388);function c(t){return void 0!==t.op}function l(t){return void 0!==t.condition}function h(t){const{op:e}=t;switch(e){case"tick":return new i.oK;case"tock":return new i.mL;case"ticktock":return new r.r;case"eval":return new i.Mb;case"vmstep":return new o.R;case"output":return new a.$c;case"set":return new a.qn(t.id,t.value,t.index);case"output-list":return new a.$Z(t.spec);case"echo":return new a.Sr(t.message);case"clear-echo":return new a.Ww;case"loadRom":return new a.Uf(t.file);case"load":return new a.Hc(t.file);case"output-file":case"compare-to":return;default:(0,n.qV)(e,`Unknown tst operation ${e}`)}}function u(t,e){let s,n=[],i=t,r=[];for(const o of e.lines){if(c(o))i=t,r=[o];else{const e=l(o)?new a.zQ(new a.gP(o.condition.left,o.condition.right,o.condition.op)):new a.Bv(o.count);e.span=o.span,t.addInstruction(e),i=e,r=o.statements}for(const t of r){const e=h(t.op);if(void 0!==e&&(void 0===s?s=o.span:s.end=o.span.end,i.addInstruction(e),n.push(e)),","!=t.separator){";"==t.separator?i.addInstruction(new a.dP(s??t.span)):"!"==t.separator&&i.addInstruction(new a.ps(s??t.span));for(const e of n)e.span=s??t.span;s=void 0,n=[]}}}return t.reset(),t}},2836:(t,e,s)=>{s.d(e,{Mb:()=>c,l1:()=>o,mL:()=>h,oK:()=>l});var n=s(5524),i=s(5424),r=s(7529),a=s(8186);class o extends a.e{chip=new n.P9;get chipId(){return this.chip.id}clock=i.S.get();static from(t,e){const s=new o(e);return(0,r.h)(s,t)}with(t){return this.chip=t,this}hasVar(t){return"time"===t||(t=`${t}`,this.chip.hasIn(t)||this.chip.hasOut(t))}getVar(t,e){if("time"===(t=`${t}`))return this.clock.toString();const s=this.chip.get(t,e);return s?s instanceof n.Gc?s.busVoltage:s.voltage():0}getWidth(t,e){const s=this.chip.get(t,e);return s?s.width:0}setVar(t,e,s){const i=this.chip.get(t,s);i instanceof n.Gc?i.busVoltage=e:i?.pull(0===e?n.yE:n.lj)}eval(){this.chip.eval()}tick(){this.chip.eval(),this.clock.tick()}tock(){this.chip.eval(),this.clock.tock()}async loadROM(t){await this.chip.load(this.fs,t)}async run(){this.clock.reset(),await super.run()}}class c{_chipTestInstruction_=!0;async do(t){t.eval()}*steps(){yield this}}class l{_chipTestInstruction_=!0;async do(t){t.tick()}*steps(){yield this}}class h{_chipTestInstruction_=!0;async do(t){t.tock()}*steps(){yield this}}},1003:(t,e,s)=>{s.d(e,{o:()=>o,r:()=>c});var n=s(2369),i=s(2201),r=s(7529),a=s(8186);class o extends a.e{cpu;ticks=0;static from(t,e){const s=new o(e);return(0,r.h)(s,t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new i.eD(new Int16Array);super(),this.cpu=new n.Z9({ROM:t}),this.reset()}reset(){return super.reset(),this.cpu.reset(),this.ticks=0,this}hasVar(t){return"number"!==typeof t&&!("A"!==t&&"D"!==t&&"PC"!==t&&"time"!==t&&!t.startsWith("RAM"))}getVar(t,e){switch(t){case"A":return this.cpu.A;case"D":return this.cpu.D;case"PC":return this.cpu.PC;case"time":return this.ticks;case"RAM":return void 0===e?0:this.cpu.RAM.get(e)}if("number"===typeof t)return 0;if(t.startsWith("RAM")){const e=Number(t.substring(4,t.length-1));return this.cpu.RAM.get(e)}return 0}getWidth(t,e){return 16}setVar(t,e,s){switch(t){case"A":this.cpu.setA(e);break;case"D":this.cpu.setD(e);break;case"PC":this.cpu.setPC(e);break;case"RAM":this.cpu.RAM.set(s??0,e)}}ticktock(){this.ticks+=1,this.cpu.tick()}async loadROM(t){await this.cpu.ROM.load(this.fs,t)}}class c{_cpuTestInstruction_=!0;async do(t){t.ticktock()}*steps(){yield this}}},8038:(t,e,s)=>{s.d(e,{$Z:()=>c,$c:()=>o,Bv:()=>h,Hc:()=>f,Sr:()=>p,Uf:()=>g,Ww:()=>m,dP:()=>i,gP:()=>u,ps:()=>r,qn:()=>a,zQ:()=>d});class n{span;constructor(t){this.span=t}async do(){}*steps(){yield this}}class i extends n{}class r extends n{}class a{variable;value;index;constructor(t,e,s){this.variable=t,this.value=e,this.index=s}async do(t){t.setVar(this.variable,this.value,this.index)}*steps(){yield this}}class o{async do(t){t.output()}*steps(){yield this}}class c{outputs=[];constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const e of t)this.addOutput(e)}addOutput(t){this.outputs.push({id:t.id,style:t.format?.style??"B",len:t.format?.width??-1,lpad:t.format?.lpad??1,rpad:t.format?.rpad??1,builtin:t.builtin,address:t.address})}async do(t){t.outputList(this.outputs),t.header()}*steps(){yield this}}class l{instructions=[];span;addInstruction(t){this.instructions.push(t)}async do(t){for(const e of this.instructions)e.do(t)}*steps(t){yield this}}class h extends l{repeat;constructor(t){super(),this.repeat=t}async do(){}*innerSteps(t){for(const e of this.instructions)yield*e.steps(t)}*steps(t){if(-1===this.repeat)for(yield this;;)yield*this.innerSteps(t);else for(let e=0;e<this.repeat;e++)yield this,yield*this.innerSteps(t)}}class u{x;y;op;constructor(t,e,s){this.x=t,this.y=e,this.op=s}check(t){const e=t.hasVar(this.x)?t.getVar(this.x):this.x,s=t.hasVar(this.y)?t.getVar(this.y):this.y;if("string"===typeof e||"string"===typeof s)switch(this.op){case"=":return`${e}`===`${s}`;case"<>":return`${e}`!==`${s}`}else switch(this.op){case"<":return e<s;case"<=":return e<=s;case">":return e>s;case">=":return e>=s;case"=":return e===s;case"<>":return e!==s}return!1}}class d extends l{condition;constructor(t){super(),this.condition=t}*steps(t){for(;this.condition.check(t);){yield this;for(const e of this.instructions)yield*e.steps(t)}}}class p{content;constructor(t){this.content=t}async do(t){t.echo(this.content)}*steps(){yield this}}class m{async do(t){t.clearEcho()}*steps(){yield this}}class g{file;constructor(t){this.file=t}async do(t){t.fs.pushd("/samples"),await t.loadROM(this.file),t.fs.popd()}*steps(){yield this}}class f{file;constructor(t){this.file=t}async do(t){await t.load(this.file)}*steps(){yield this}}},8186:(t,e,s)=>{s.d(e,{e:()=>c});var n=s(7239),i=s(2608),r=s(5150);class a{variable;fmt;lPad;rPad;len;index;builtin;constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"%B1.1.1",s=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;if(this.variable=t,e.startsWith("%")&&void 0===s&&void 0===i&&void 0===r){const{fmt:t,lPad:s,rPad:n,len:i}=e.match(/^%(?<fmt>[BDXS])(?<lPad>\d+)\.(?<len>\d+)\.(?<rPad>\d+)$/)?.groups;this.fmt=t,this.lPad=parseInt(s),this.rPad=parseInt(n),this.len=parseInt(i),this.builtin=!1,this.index=-1}else(0,n.hu)(["B","X","D","S"].includes(e[0])),this.fmt=e[0],this.len=s??3,this.lPad=i??1,this.rPad=r??1,this.builtin=a??!1,this.index=o??-1}header(t){let e=`${this.variable}`;if(this.builtin){e=`${e}[${this.index>=0?this.index:""}]`}return e.length>this.len+this.lPad+this.rPad?e.substring(0,this.len+this.lPad+this.rPad):this.padCenter(e)}print(t){const e=t.getVar(this.variable,this.index);if("S"===this.fmt)return this.padLeft(e);const s=(0,{B:r.Ly,D:r.E_,X:r.$v}[this.fmt])(e);return"D"===this.fmt?this.padRight(s):this.padLeft(s.slice(s.length-this.len))}padCenter(t){const e=this.lPad+this.len+this.rPad,s=Math.floor((e-t.length)/2),n=e-s-t.length,i=s+t.length,r=i+n;return t=(t=t.padStart(i)).padEnd(r)}padLeft(t){t=t.substring(0,this.len);const e=this.rPad+this.len,s=this.lPad+e;return t=(t=t.padEnd(e)).padStart(s)}padRight(t){t=t.substring(0,this.len);const e=this.lPad+this.len,s=this.rPad+e;return t=(t=t.padStart(e)).padEnd(s)}}var o=s(8038);class c{instructions=[];_outputList=[];_log="";fs=new i.Wd;doEcho;constructor(t){this.doEcho=t}setFileSystem(t){return this.fs=t,this}echo(t){this.doEcho?.(t)}clearEcho(){this.doEcho?.("")}async loadROM(t){}async load(t){}async compareTo(t){}outputFile(t){}createOutputs(t){return t.map((t=>{if(-1===t.len)if("time"===t.id)t.len=7,t.style="S";else{const e=this.getWidth(t.id,t.address);"B"===t.style?t.len=e:"D"===t.style?t.len=Math.ceil(Math.log(e)):"X"===t.style&&(t.len=Math.ceil(e/4))}return new a(t.id,t.style,t.len,t.lpad,t.rpad,t.builtin,t.address)}))}outputList(t){this._outputList=this.createOutputs(t)}addInstruction(t){this.instructions.push(t)}reset(){return this._steps=function*(t){for(const e of t.instructions)yield*e.steps(t)}(this),this._step=this._steps.next(),this._log="",this}_steps;_step;get steps(){return void 0===this._steps&&(this.reset(),this._steps=(0,n.kP)(this._steps,"Reset did not initialize steps"),this._step=(0,n.kP)(this._step,"Reset did not find first step")),this._steps}get currentStep(){return this._step?.value}get done(){return this._step?.done??!1}async step(){for(;!this._step.done;){if(await this._step.value.do(this),this._step=this.steps.next(),this._step.value instanceof o.dP)return this._step=this.steps.next(),!1;if(this._step.value instanceof o.ps)return!0}return!0}async run(){for(this.reset();!await this.step(););}breakpoints=new Map;addBreakpoint(t,e){this.breakpoints.set(t,e)}clearBreakpoints(){this.breakpoints.clear()}output(){const t=this._outputList.map((t=>t.print(this)));this._log+=`|${t.join("|")}|\n`}header(){const t=this._outputList.map((t=>t.header(this)));this._log+=`|${t.join("|")}|\n`}log(){return this._log}}},4388:(t,e,s)=>{s.d(e,{R:()=>c,w:()=>o});var n=s(2201),i=s(5920),r=s(7529),a=s(8186);class o extends a.e{vm=new i.Vm;loadAction;dir;static from(t,e,s){const n=new o;return n.dir=e?.split("/").slice(0,-1).join("/"),n.loadAction=s,(0,r.h)(n,t)}using(t){return this.fs=t,this}with(t){return this.vm=t,this}hasVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e&&e>0&&e<n.FH.SIZE||["argument","local","static","constant","this","that","pointer","temp"].includes(t.toLowerCase())}getVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e?this.vm.RAM.get(e):this.vm.memory.getSegment(t,e??0)}getWidth(t,e){return 16}setVar(t,e,s){if("string"!==typeof t&&(s=t,t="RAM"),"RAM"!==t||void 0===s)if(void 0!==s)this.vm.memory.setSegment(t,s,e);else switch(t.toLowerCase()){case"sp":this.vm.memory.SP=e;break;case"arg":case"argument":this.vm.memory.ARG=e,this.vm.segmentInitializations.argument.initialized=!0;break;case"lcl":case"local":this.vm.memory.LCL=e,this.vm.segmentInitializations.local.initialized=!0;break;case"this":this.vm.memory.THIS=e,this.vm.invocation.thisInitialized=!0;break;case"that":this.vm.memory.THAT=e,this.vm.invocation.thatInitialized=!0}else this.vm.RAM.set(s,e)}vmstep(){this.vm.step()}async load(t){if(this.loadAction)if(t){const e=await this.fs.readFile(`${this.dir?`${this.dir}/`:""}${t}`);this.loadAction?.([{name:t,content:e.replace(".vm","")}])}else{const t=await this.fs.scandir(this.dir??"/"),e=[];for(const s of t)if(s.isFile()&&s.name.endsWith(".vm")){const t=await this.fs.readFile(`${this.dir?`${this.dir}/`:""}${s.name}`);e.push({name:s.name.replace(".vm",""),content:t})}this.loadAction(e)}}}class c{_vmTestInstruction_=!0;async do(t){t.vmstep()}*steps(){yield this}}},9882:(t,e,s)=>{var n;function i(t){return Object.values(n).includes(t)}s.d(e,{b:()=>n,q:()=>i}),function(t){t[t.SYS_WAIT_DURATION_NOT_POSITIVE=1]="SYS_WAIT_DURATION_NOT_POSITIVE",t[t.ARRAY_SIZE_NOT_POSITIVE=2]="ARRAY_SIZE_NOT_POSITIVE",t[t.DIVIDE_BY_ZERO=3]="DIVIDE_BY_ZERO",t[t.SQRT_NEG=4]="SQRT_NEG",t[t.ALLOC_SIZE_NOT_POSITIVE=5]="ALLOC_SIZE_NOT_POSITIVE",t[t.HEAP_OVERFLOW=6]="HEAP_OVERFLOW",t[t.ILLEGAL_PIXEL_COORD=7]="ILLEGAL_PIXEL_COORD",t[t.ILLEGAL_LINE_COORD=8]="ILLEGAL_LINE_COORD",t[t.ILLEGAL_RECT_COORD=9]="ILLEGAL_RECT_COORD",t[t.ILLEGAL_CENTER_COORD=12]="ILLEGAL_CENTER_COORD",t[t.ILLEGAL_RADIUS=13]="ILLEGAL_RADIUS",t[t.STRING_LENGTH_NEG=14]="STRING_LENGTH_NEG",t[t.GET_CHAR_INDEX_OUT_OF_BOUNDS=15]="GET_CHAR_INDEX_OUT_OF_BOUNDS",t[t.SET_CHAR_INDEX_OUT_OF_BOUNDS=16]="SET_CHAR_INDEX_OUT_OF_BOUNDS",t[t.STRING_FULL=17]="STRING_FULL",t[t.STRING_EMPTY=18]="STRING_EMPTY",t[t.STRING_INSUFFICIENT_CAPACITY=19]="STRING_INSUFFICIENT_CAPACITY",t[t.ILLEGAL_CURSOR_LOCATION=20]="ILLEGAL_CURSOR_LOCATION"}(n||(n={}))},5920:(t,e,s)=>{s.d(e,{tN:()=>x,bU:()=>C,Vm:()=>k});var n=s(7054),i=s(3484),r=s(9882);function a(t){return t-48}function o(t){return t.toString().split("").map((t=>Number(t)+48))}class c{memory;os;constructor(t,e){this.memory=t,this.os=e}new(t){t<=0&&this.os.sys.error(r.b.STRING_LENGTH_NEG);const e=this.os.memory.alloc(t+2);return this.os.sys.halted?0:(this.memory.set(e,t),this.memory.set(e+1,0),e)}dispose(t){this.os.memory.deAlloc(t)}maxLength(t){return this.memory.get(t)}length(t){return this.memory.get(t+1)}setLength(t,e){this.memory.set(t+1,e)}charAt(t,e){return e<0||e>=this.length(t)?(this.os.sys.error(r.b.GET_CHAR_INDEX_OUT_OF_BOUNDS),0):this.memory.get(t+e+2)}setCharAt(t,e,s){e<0||e>=this.length(t)?this.os.sys.error(r.b.SET_CHAR_INDEX_OUT_OF_BOUNDS):this.memory.set(t+e+2,s)}appendChar(t,e){const s=this.length(t);return s==this.maxLength(t)?(this.os.sys.error(r.b.STRING_FULL),0):(this.setLength(t,s+1),this.setCharAt(t,s,e),t)}eraseLastChar(t){const e=this.length(t);0!=e?this.setLength(t,e-1):this.os.sys.error(r.b.STRING_EMPTY)}intValue(t){const e=[];for(let n=0;n<this.length(t)&&((s=this.charAt(t,n))>=48&&s<=57);n++)e.push(a(this.charAt(t,n)));var s;return e.reduce(((t,e)=>10*t+e),0)}setInt(t,e){const s=o(e);if(s.length>this.maxLength(t))this.os.sys.error(r.b.STRING_INSUFFICIENT_CAPACITY);else{this.setLength(t,0);for(const e of s)this.appendChar(t,e)}}}function l(t,e){const s=[];for(let n=0;n<e;n++)s.push(t.get(t.SP-e+n));return s}const h={"Math.multiply":{func:(t,e)=>{const[s,n]=l(t,2);return s*n&65535},nArgs:2},"Math.divide":{func:(t,e)=>{const[s,n]=l(t,2);return 0==n?(e.sys.error(r.b.DIVIDE_BY_ZERO),0):65535&Math.floor(s/n)},nArgs:2},"Math.min":{func:(t,e)=>{const[s,n]=l(t,2);return 65535&Math.min(s,n)},nArgs:2},"Math.max":{func:(t,e)=>{const[s,n]=l(t,2);return 65535&Math.max(s,n)},nArgs:2},"Math.sqrt":{func:(t,e)=>{const[s]=l(t,1);return s<0?(e.sys.error(r.b.SQRT_NEG),0):65535&Math.floor(Math.sqrt(s))},nArgs:1},"Math.abs":{func:(t,e)=>{const[s]=l(t,1);return 65535&Math.abs(s)},nArgs:1},"Screen.clearScreen":{func:(t,e)=>(e.screen.clear(),0),nArgs:0},"Screen.setColor":{func:(t,e)=>{const[s]=l(t,1);return e.screen.color=0!==s,0},nArgs:1},"Screen.drawPixel":{func:(t,e)=>{const[s,n]=l(t,2);return e.screen.drawPixel(s,n),0},nArgs:2},"Screen.drawLine":{func:(t,e)=>{const[s,n,i,r]=l(t,4);return e.screen.drawLine(s,n,i,r),0},nArgs:4},"Screen.drawRectangle":{func:(t,e)=>{const[s,n,i,r]=l(t,4);return e.screen.drawRect(s,n,i,r),0},nArgs:4},"Screen.drawCircle":{func:(t,e)=>{const[s,n,i]=l(t,3);return e.screen.drawCircle(s,n,i),0},nArgs:3},"Memory.peek":{func:(t,e)=>{const[s]=l(t,1);return t.get(s)},nArgs:1},"Memory.poke":{func:(t,e)=>{const[s,n]=l(t,2);return t.set(s,n),0},nArgs:1},"Memory.alloc":{func:(t,e)=>{const[s]=l(t,1);return e.memory.alloc(s)},nArgs:1},"Memory.deAlloc":{func:(t,e)=>{const[s]=l(t,1);return e.memory.deAlloc(s),0},nArgs:1},"Array.new":{func:(t,e)=>{const[s]=l(t,1);return s<=0?(e.sys.error(r.b.ARRAY_SIZE_NOT_POSITIVE),0):e.memory.alloc(s)},nArgs:1},"Array.dispose":{func:(t,e)=>{const[s]=l(t,1);return e.memory.deAlloc(s),0},nArgs:1},"String.new":{func:(t,e)=>{const[s]=l(t,1);return e.string.new(s)},nArgs:1},"String.dispose":{func:(t,e)=>{const[s]=l(t,1);return e.string.dispose(s),0},nArgs:1},"String.length":{func:(t,e)=>{const[s]=l(t,1);return e.string.length(s)},nArgs:1},"String.charAt":{func:(t,e)=>{const[s,n]=l(t,2);return e.string.charAt(s,n)},nArgs:2},"String.setCharAt":{func:(t,e)=>{const[s,n,i]=l(t,3);return e.string.setCharAt(s,n,i),0},nArgs:3},"String.appendChar":{func:(t,e)=>{const[s,n]=l(t,2);return e.string.appendChar(s,n)},nArgs:2},"String.eraseLastChar":{func:(t,e)=>{const[s]=l(t,1);return e.string.eraseLastChar(s),0},nArgs:1},"String.intValue":{func:(t,e)=>{const[s]=l(t,1);return e.string.intValue(s)},nArgs:1},"String.setInt":{func:(t,e)=>{const[s,n]=l(t,2);return e.string.setInt(s,n),0},nArgs:2},"String.backSpace":{func:(t,e)=>129,nArgs:0},"String.doubleQuote":{func:(t,e)=>34,nArgs:0},"String.newLine":{func:(t,e)=>128,nArgs:0},"Output.moveCursor":{func:(t,e)=>{const[s,n]=l(t,2);return e.output.moveCursor(s,n),0},nArgs:2},"Output.printChar":{func:(t,e)=>{const[s]=l(t,1);return e.output.printChar(s),0},nArgs:1},"Output.printString":{func:(t,e)=>{const[s]=l(t,1);return e.output.printString(s),0},nArgs:1},"Output.printInt":{func:(t,e)=>{const[s]=l(t,1);return e.output.printInt(s),0},nArgs:1},"Output.println":{func:(t,e)=>(e.output.println(),0),nArgs:0},"Output.backSpace":{func:(t,e)=>(e.output.backspace(),0),nArgs:0},"Keyboard.keyPressed":{func:(t,e)=>e.keyboard.keyPressed(),nArgs:0},"Keyboard.readChar":{func:(t,e)=>(e.keyboard.readChar(),0),nArgs:0},"Keyboard.readLine":{func:(t,e)=>{const[s]=l(t,1);return e.keyboard.readLine(s),0},nArgs:1},"Keyboard.readInt":{func:(t,e)=>{const[s]=l(t,1);return e.keyboard.readInt(s),0},nArgs:1},"Sys.halt":{func:(t,e)=>(e.sys.halt(),0),nArgs:0},"Sys.error":{func:(t,e)=>{const[s]=l(t,1);return e.sys.error(s),0},nArgs:1},"Sys.wait":{func:(t,e)=>{const[s]=l(t,1);return e.sys.wait(s),0},nArgs:1}};var u=s(2201);class d extends u.FH{strict=!0;get SP(){return this.get(0)}set SP(t){this.set(0,t)}get LCL(){return this.get(1)}set LCL(t){this.set(1,t)}get ARG(){return this.get(2)}set ARG(t){this.set(2,t)}get THIS(){return this.get(3)}set THIS(t){this.set(3,t)}get THAT(){return this.get(4)}set THAT(t){this.set(4,t)}get statics(){const t=[];for(let e=16;e<256;e++)t.push(this.get(e));return t}constructor(){super(),this.set(0,256)}baseSegment(t,e){if(this.strict&&(e<0||e>32767))return(0,n.UG)(new Error(`Illegal offset value ${e} (must be between 0 and 32767)`));switch(t){case"argument":return(0,n.Ok)(this.ARG+e);case"constant":return(0,n.Ok)(e);case"local":return(0,n.Ok)(this.LCL+e);case"pointer":if(this.strict&&e>1)throw new Error(`pointer out of bounds access (pointer can be 0 for this, 1 for that, but got ${e}`);return(0,n.Ok)(0===e?3:4);case"static":return this.strict&&e>239?(0,n.UG)(new Error(`Cannot access statics beyond 239: ${e}`)):(0,n.Ok)(16+e);case"temp":return this.strict&&e>7?(0,n.UG)(new Error(`Temp out of bounds access (temp can be 0 to 7, but got ${e}`)):(0,n.Ok)(5+e);case"that":return(0,n.Ok)(this.THAT+e);case"this":return(0,n.Ok)(this.THIS+e)}}getSegment(t,e){if("constant"===t){if(this.strict&&(e<0||e>32767))throw new Error(`Illegal offset value ${e} (must be between 0 and 32767)`);return e}const s=this.baseSegment(t,e);if((0,n.dZ)(s))throw(0,n.UG)(s);return this.get((0,n.Ok)(s))}setSegment(t,e,s){const i=this.baseSegment(t,e);if((0,n.dZ)(i))throw(0,n.UG)(i);this.set((0,n.Ok)(i),s)}argument(t){return this.getSegment("argument",t)}local(t){return this.getSegment("local",t)}static(t){return this.getSegment("static",t)}constant(t){return this.getSegment("constant",t)}this(t){return this.getSegment("this",t)}that(t){return this.getSegment("that",t)}pointer(t){return this.getSegment("pointer",t)}temp(t){return this.getSegment("temp",t)}push(t){const e=this.SP;this.set(e,t),this.set(0,e+1)}pop(){if(this.strict&&256===this.SP)throw new Error("Cannot pop the stack below 256 in strict mode");this.set(0,this.SP-1);return this.get(this.SP)}pushFrame(t,e,s){const n=this.SP,i=n-e;this.set(n,t),this.set(n+1,this.LCL),this.set(n+2,this.ARG),this.set(n+3,this.THIS),this.set(n+4,this.THAT),this.set(2,i),this.set(1,n+5);const r=n+5;for(let a=0;a<s;a++)this.set(r+a,0);return this.set(0,r+s),n}popFrame(){const t=this.LCL,e=this.get(t-5),s=this.pop();return this.set(this.ARG,s),this.set(0,this.ARG+1),this.set(4,this.get(t-1)),this.set(3,this.get(t-2)),this.set(2,this.get(t-3)),this.set(1,this.get(t-4)),e}getFrame(t,e,s,n,i,r){const a=t-e,o=t+5,c=o+s,l=r-c;return{args:{base:a,count:e,values:[...this.map(((t,e)=>e),a,a+e)]},locals:{base:o,count:s,values:[...this.map(((t,e)=>e),o,o+s)]},stack:{base:c,count:l,values:[...this.map(((t,e)=>e),c,c+l)]},this:{base:c,count:n,values:[...this.map(((t,e)=>e),this.THIS,this.THIS+n)]},that:{base:c,count:i,values:[...this.map(((t,e)=>e),this.THAT,this.THAT+i)]},frame:{RET:this.get(t),LCL:this.LCL,ARG:this.ARG,THIS:this.THIS,THAT:this.THAT}}}getVmState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:240;const e=[...this.map(((t,e)=>e),5,13)],s=[...this.map(((t,e)=>e),13,16)],n=[...this.map(((t,e)=>e),16,16+t)];return{"0: SP":this.SP,"1: LCL":this.LCL,"2: ARG":this.ARG,"3: THIS":this.THIS,"4: THAT":this.THAT,temps:e,internal:s,static:n}}binOp(t){const e=65535&t(this.get(this.SP-2),this.get(this.SP-1));this.set(this.SP-2,e),this.set(0,this.SP-1)}unOp(t){const e=65535&t(this.get(this.SP-1));this.set(this.SP-1,e)}comp(t){this.binOp(((e,s)=>t(e,s)?-1:0))}}class p{memory;os;animationFrameId=void 0;cancel=!1;constructor(t,e){this.memory=t,this.os=e}keyPressed(){return this.memory.get(u.eu)}readCharLoop(t){let e=!1,s=0;const n=()=>{if(this.cancel)return;let i=!1;e||0===this.keyPressed()||(e=!0,s=this.keyPressed()),e&&0===this.keyPressed()&&(i=!0,t(s)),i||(this.animationFrameId=requestAnimationFrame(n))};n()}readChar(){this.os.sys.block(),this.os.output.drawCursor(),new Promise((t=>{this.readCharLoop(t)})).then((t=>{this.os.output.printChar(t),this.os.sys.release(t)}))}readLineLoop(t){const e=this.os.string.new(100);this.os.sys.halted&&t(0);let s=!1,n=0;const i=()=>{if(this.cancel)return;let r=!1;s||0==this.keyPressed()||(s=!0,n=this.keyPressed()),s&&0==this.keyPressed()&&(s=!1,129==n?(this.os.string.length(e)>0&&this.os.output.backspace(),this.os.string.eraseLastChar(e)):128==n?(t(e),r=!0):(this.os.string.appendChar(e,n),this.os.sys.halted&&t(0),this.os.output.printChar(n),this.os.output.drawCursor())),r||(this.animationFrameId=requestAnimationFrame(i))};i()}readLine(t){this.os.sys.block(),this.os.output.printString(t),this.os.output.drawCursor(),new Promise((t=>{this.readLineLoop(t)})).then((t=>{this.os.sys.halted||(this.os.output.clearChar(),this.os.output.println()),this.os.sys.release(t)}))}readInt(t){this.os.sys.block(),this.os.output.printString(t),this.os.output.drawCursor(),new Promise((t=>{this.readLineLoop(t)})).then((t=>{this.os.sys.halted||(this.os.output.clearChar(),this.os.output.println()),this.os.sys.release(this.os.string.intValue(t))}))}dispose(){this.cancel=!0,this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)}}class m{memory;os;freeSegments=[{address:2048,length:14336}];constructor(t,e){this.memory=t,this.os=e}alloc(t){if(t<=0)return this.os.sys.error(r.b.ARRAY_SIZE_NOT_POSITIVE),0;for(let e=0;e<this.freeSegments.length;e++){const s=this.freeSegments[e];if(s.length>=t){const n=s.address;return s.address+=t+1,s.length-=t+1,0===s.length&&this.freeSegments.splice(e,1),this.memory.set(n,t),n+1}}return this.os.sys.error(r.b.HEAP_OVERFLOW),0}deAlloc(t){const e=this.memory.get(t-1);this.freeSegments.push({address:t-1,length:e+1})}}const g=function(){const t=new Array(126);return t[32]=f(["        ","        ","        ","        ","        ","        ","        ","        ","        ","        ","        "]),t[33]=f(["  \u2588\u2588    "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[34]=f([" \u2588\u2588 \u2588\u2588  "," \u2588\u2588 \u2588\u2588  ","  \u2588 \u2588   ","        ","        ","        ","        ","        ","        ","        ","        "]),t[35]=f(["        "," \u2588  \u2588   "," \u2588  \u2588   ","\u2588\u2588\u2588\u2588\u2588\u2588  "," \u2588  \u2588   "," \u2588  \u2588   ","\u2588\u2588\u2588\u2588\u2588\u2588  "," \u2588  \u2588   "," \u2588  \u2588   ","        ","        "]),t[36]=f(["  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588      "," \u2588\u2588\u2588\u2588   ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","        "]),t[37]=f(["        ","        ","\u2588\u2588   \u2588  ","\u2588\u2588  \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588  \u2588\u2588  ","\u2588   \u2588\u2588  ","        ","        "]),t[38]=f(["  \u2588\u2588    "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588 \u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","        ","        "]),t[39]=f(["  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588     ","        ","        ","        ","        ","        ","        ","        ","        "]),t[40]=f(["   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","        ","        "]),t[41]=f([" \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","        ","        "]),t[42]=f(["        ","        ","        ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","\u2588\u2588\u2588\u2588\u2588\u2588  "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","        ","        ","        "]),t[43]=f(["        ","        ","        ","  \u2588\u2588    ","  \u2588\u2588    ","\u2588\u2588\u2588\u2588\u2588\u2588  ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        ","        "]),t[44]=f(["        ","        ","        ","        ","        ","        ","        ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588     ","        "]),t[45]=f(["        ","        ","        ","        ","        ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        ","        ","        ","        "]),t[46]=f(["        ","        ","        ","        ","        ","        ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[47]=f(["        ","        ","     \u2588  ","    \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588      ","\u2588       ","        ","        "]),t[48]=f(["  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","        ","        "]),t[49]=f(["  \u2588\u2588    "," \u2588\u2588\u2588    ","\u2588\u2588\u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[50]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","    \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588      ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[51]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","  \u2588\u2588\u2588   ","    \u2588\u2588  ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[52]=f(["    \u2588   ","   \u2588\u2588   ","  \u2588\u2588\u2588   "," \u2588 \u2588\u2588   ","\u2588  \u2588\u2588   ","\u2588\u2588\u2588\u2588\u2588\u2588  ","   \u2588\u2588   ","   \u2588\u2588   ","  \u2588\u2588\u2588\u2588  ","        ","        "]),t[53]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588\u2588\u2588\u2588   ","    \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[54]=f(["  \u2588\u2588\u2588   "," \u2588\u2588     ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[55]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588   \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[56]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[57]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","   \u2588\u2588   "," \u2588\u2588\u2588    ","        ","        "]),t[58]=f(["        ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        ","        "]),t[59]=f(["        ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588     ","        ","        "]),t[60]=f(["        ","        ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588      "," \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","        ","        "]),t[61]=f(["        ","        ","        ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        ","        ","        "]),t[62]=f(["        ","        ","\u2588\u2588      "," \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588      ","        ","        "]),t[64]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588      "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[63]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","        ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[65]=f(["  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[66]=f(["\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588   ","        ","        "]),t[67]=f(["  \u2588\u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","\u2588\u2588   \u2588  ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588   \u2588  "," \u2588\u2588 \u2588\u2588  ","  \u2588\u2588\u2588   ","        ","        "]),t[68]=f(["\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588\u2588\u2588    ","        ","        "]),t[69]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588   \u2588  ","\u2588\u2588 \u2588    ","\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588    ","\u2588\u2588   \u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[70]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588   \u2588  ","\u2588\u2588 \u2588    ","\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588    ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","        ","        "]),t[71]=f(["  \u2588\u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","\u2588\u2588   \u2588  ","\u2588\u2588      ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588 \u2588\u2588  ","  \u2588\u2588 \u2588  ","        ","        "]),t[72]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[73]=f([" \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[74]=f(["  \u2588\u2588\u2588\u2588  ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","   \u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   "," \u2588\u2588\u2588    ","        ","        "]),t[75]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[76]=f(["\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588   \u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[77]=f(["\u2588    \u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[78]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588 \u2588\u2588  ","\u2588\u2588\u2588 \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[79]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[80]=f(["\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","        ","        "]),t[81]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588\u2588  "," \u2588\u2588\u2588\u2588   ","    \u2588\u2588  ","        "]),t[82]=f(["\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[83]=f([" \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588     ","  \u2588\u2588\u2588   ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[84]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588 \u2588\u2588 \u2588  ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[85]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[86]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[87]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  "," \u2588  \u2588   ","        ","        "]),t[88]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[89]=f(["\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[90]=f(["\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588   \u2588\u2588  ","   \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588   \u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[91]=f([" \u2588\u2588\u2588\u2588   "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[92]=f(["        ","        ","\u2588       ","\u2588\u2588      "," \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","    \u2588\u2588  ","     \u2588  ","        ","        "]),t[94]=f(["   \u2588    ","  \u2588\u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","        ","        ","        ","        ","        ","        ","        ","        "]),t[95]=f(["        ","        ","        ","        ","        ","        ","        ","        ","        ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        "]),t[96]=f([" \u2588\u2588     ","  \u2588\u2588    ","   \u2588\u2588   ","        ","        ","        ","        ","        ","        ","        ","        "]),t[97]=f(["        ","        ","        "," \u2588\u2588\u2588    ","   \u2588\u2588   "," \u2588\u2588\u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","        ","        "]),t[98]=f(["\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[99]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[100]=f(["    \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","  \u2588\u2588\u2588\u2588  "," \u2588\u2588 \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[101]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588      ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[102]=f(["  \u2588\u2588\u2588   "," \u2588\u2588 \u2588\u2588  "," \u2588\u2588  \u2588  "," \u2588\u2588     ","\u2588\u2588\u2588\u2588    "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     ","\u2588\u2588\u2588\u2588    ","        ","        "]),t[103]=f(["        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588\u2588  ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        "]),t[104]=f(["\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588\u2588 \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[105]=f(["  \u2588\u2588    ","  \u2588\u2588    ","        "," \u2588\u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[106]=f(["    \u2588\u2588  ","    \u2588\u2588  ","        ","   \u2588\u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        "]),t[107]=f(["\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588\u2588\u2588    ","\u2588\u2588\u2588\u2588    ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[108]=f([" \u2588\u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[109]=f(["        ","        ","        ","\u2588 \u2588\u2588\u2588   ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588 \u2588 \u2588  ","\u2588\u2588 \u2588 \u2588  ","\u2588\u2588 \u2588 \u2588  ","\u2588\u2588 \u2588 \u2588  ","        ","        "]),t[110]=f(["        ","        ","        ","\u2588 \u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[111]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[112]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588   ","\u2588\u2588      ","\u2588\u2588      ","        "]),t[113]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588\u2588  ","    \u2588\u2588  ","    \u2588\u2588  ","        "]),t[114]=f(["        ","        ","        ","\u2588 \u2588\u2588\u2588   ","\u2588\u2588\u2588 \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588      ","\u2588\u2588      ","\u2588\u2588\u2588     ","        ","        "]),t[115]=f(["        ","        ","        "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588     ","   \u2588\u2588   ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","        ","        "]),t[116]=f(["  \u2588     "," \u2588\u2588     "," \u2588\u2588     ","\u2588\u2588\u2588\u2588    "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588     "," \u2588\u2588 \u2588\u2588  ","  \u2588\u2588\u2588   ","        ","        "]),t[117]=f(["        ","        ","        ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   ","\u2588\u2588 \u2588\u2588   "," \u2588\u2588 \u2588\u2588  ","        ","        "]),t[118]=f(["        ","        ","        ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","        ","        "]),t[119]=f(["        ","        ","        ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  "," \u2588  \u2588   ","        ","        "]),t[120]=f(["        ","        ","        ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588   ","  \u2588\u2588    ","  \u2588\u2588    "," \u2588\u2588\u2588\u2588   ","\u2588\u2588  \u2588\u2588  ","        ","        "]),t[121]=f(["        ","        ","        ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588  \u2588\u2588  "," \u2588\u2588\u2588\u2588\u2588  ","    \u2588\u2588  ","   \u2588\u2588   ","\u2588\u2588\u2588\u2588    ","        "]),t[122]=f(["        ","        ","        ","\u2588\u2588\u2588\u2588\u2588\u2588  ","\u2588\u2588 \u2588\u2588   ","  \u2588\u2588    "," \u2588\u2588     ","\u2588\u2588  \u2588\u2588  ","\u2588\u2588\u2588\u2588\u2588\u2588  ","        ","        "]),t[123]=f(["   \u2588\u2588\u2588  ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","\u2588\u2588\u2588     ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","   \u2588\u2588\u2588  ","        ","        "]),t[124]=f(["  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","        ","        "]),t[125]=f(["\u2588\u2588\u2588     ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","   \u2588\u2588\u2588  ","  \u2588\u2588    ","  \u2588\u2588    ","  \u2588\u2588    ","\u2588\u2588\u2588     ","        ","        "]),t[126]=f([" \u2588\u2588  \u2588  ","\u2588 \u2588\u2588 \u2588  ","\u2588  \u2588\u2588   ","        ","        ","        ","        ","        ","        ","        ","        "]),t}();function f(t){return t.map((t=>t.split("").map((t=>"\u2588"==t))))}const b=new Array(u.yJ).fill(0),y=!0;class v{memory;os;color=y;constructor(t,e){this.memory=t,this.os=e}clear(){this.memory.screen.loadBytes(b)}outOfBounds(t,e){return t<0||t>16*u.ZQ||e<0||e>u.KC}drawPixel(t,e){if(this.outOfBounds(t,e))return void this.os.sys.error(r.b.ILLEGAL_PIXEL_COORD);const s=32*e+Math.floor(t/16);let n=this.memory.screen.get(s);this.color?n|=1<<t%16:n&=~(1<<t%16),this.memory.screen.set(s,n)}drawLine(t,e,s,n){this.outOfBounds(t,e)||this.outOfBounds(s,n)?this.os.sys.error(r.b.ILLEGAL_LINE_COORD):t==s?this.drawVerticalLine(t,e,n):e==n?this.drawHorizontalLine(e,t,s):this.drawGeneralLine(t,e,s,n)}drawHorizontalLine(t,e,s){for(let n=Math.min(e,s);n<=Math.max(e,s);n++)this.drawPixel(n,t)}drawVerticalLine(t,e,s){for(let n=Math.min(e,s);n<=Math.max(e,s);n++)this.drawPixel(t,n)}drawGeneralLine(t,e,s,n){const i=Math.abs(s-t),r=Math.abs(n-e);let a=0,o=0,c=0;const l=t<s?1:-1,h=e<n?1:-1;for(;a<=i&&o<=r;)this.drawPixel(t+l*a,e+h*o),c<0?(a+=1,c+=r):(o+=1,c-=i)}drawRect(t,e,s,n){if(this.outOfBounds(t,e)||this.outOfBounds(s,n))this.os.sys.error(r.b.ILLEGAL_RECT_COORD);else for(let i=t;i<=s;i++)for(let t=e;t<=n;t++)this.drawPixel(i,t)}drawCircle(t,e,s){if(this.outOfBounds(t,e))this.os.sys.error(r.b.ILLEGAL_CENTER_COORD);else if(s>181)this.os.sys.error(r.b.ILLEGAL_RADIUS);else for(let n=-s;n<=s;n++)this.drawLine(t-Math.floor(Math.sqrt(s*s-n*n)),e+n,t+Math.floor(Math.sqrt(s*s-n*n)),e+n)}}class S{os;col=0;row=0;lastColor=!1;constructor(t){this.os=t}setColor(t){this.lastColor=this.os.screen.color,this.os.screen.color=t}restoreColor(){this.os.screen.color=this.lastColor}clearChar(){this.setColor(false),this.os.screen.drawRect(8*this.col,11*this.row,8*(this.col+1),11*(this.row+1)),this.restoreColor()}moveCursor(t,e){t<0||t>22||e<0||e>64?this.os.sys.error(r.b.ILLEGAL_CURSOR_LOCATION):(this.row=t,this.col=e,this.drawCursor())}println(){this.row+=1,this.col=0}drawCursor(){this.clearChar(),this.setColor(y),this.os.screen.drawRect(8*this.col+2,11*this.row+2,8*(this.col+1)-2,11*(this.row+1)-2),this.restoreColor()}printChar(t){const e=g[t];if(e){this.clearChar(),this.setColor(y);for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)e[t][s]&&this.os.screen.drawPixel(8*this.col+s,11*this.row+t);this.restoreColor()}this.col+=1,64==this.col&&(this.println(),22==this.row&&(this.row=0))}printString(t){for(let e=0;e<this.os.string.length(t);e++)this.printChar(this.os.string.charAt(t,e))}printJsString(t){for(const e of t)this.printChar(e.charCodeAt(0))}printInt(t){for(const e of o(t))this.printChar(e)}backspace(){this.clearChar(),this.col-=1,this.col<0&&(this.col=0,this.row-=1,this.row<0&&(this.row=0)),this.drawCursor()}}class A{os;_blocked=!1;_released=!1;_returnValue=0;_halted=!1;_exitCode=0;cancelWait=!1;animationFrameId;constructor(t){this.os=t}get blocked(){return this._blocked}get released(){return this._released}get halted(){return this._halted}get exitCode(){return this._exitCode}block(){this._blocked=!0}release(t){this._blocked=!1,this._returnValue=t??0,this._released=!0}readReturnValue(){return this._released=!1,this._returnValue}wait(t){if(t<=0)return void this.error(r.b.SYS_WAIT_DURATION_NOT_POSITIVE);this.block();let e=0;const s=n=>{this.cancelWait||(e+=n,e>=t?this.release():this.animationFrameId=requestAnimationFrame(s))};s(0)}halt(){this._halted=!0,this._exitCode=0}error(t){this.os.output.printJsString(`ERR${t}`),this._halted=!0,this._exitCode=t}dispose(){this.cancelWait=!0,this.animationFrameId&&cancelAnimationFrame(this.animationFrameId)}}class w{vmMemory;screen;memory;string;output;keyboard;sys;constructor(t){this.vmMemory=t,this.screen=new v(this.vmMemory,this),this.memory=new m(this.vmMemory,this),this.string=new c(this.vmMemory,this),this.output=new S(this),this.keyboard=new p(this.vmMemory,this),this.sys=new A(this)}dispose(){this.keyboard.dispose(),this.sys.dispose()}}const x="__implicit",C={name:"Sys.init",labels:{},nVars:0,opBase:0,operations:[{op:"function",name:"Sys.init",nVars:0},{op:"call",name:"Main.main",nArgs:0}]};class k{memory=new d;os=new w(this.memory);functionMap={};executionStack=[];entry="";segmentInitializations={local:{initialized:!1,n:0},argument:{initialized:!1,n:0}};functions=[];program=[];addedSysInit=!1;staticCount=0;statics={};getStaticCount(){return this.staticCount}returnLine=void 0;registerStatic(t,e){const s=t.split(".")[0],n=this.statics[s]??[];this.statics[s]=n;const i=n[e]??this.staticCount++;return n[e]=i,i}registerStatics(){for(const t of Object.values(this.functionMap))for(const e of t.operations)"push"!==e.op&&"pop"!==e.op||"static"!==e?.segment||(e.offset=this.registerStatic(t.name,e.offset))}static validateFile(t){for(const e of t.instructions)if("function"==e.op){const s=e.name.split(".");if(2!=s.length)return(0,n.UG)((0,i.Tr)(`Illegal subroutine name ${e.name} (Expected <className>.<SubroutineName>)`,e.span));if(s[0]!=t.name)return(0,n.UG)((0,i.Tr)(`File name ${t.name} doesn't match class name ${s[0]} (at ${e.name})`,e.span))}return(0,n.Ok)()}static validateFiles(t){const e=new Set;for(const s of t){if(e.has(s.name))return(0,n.UG)((0,i.Tr)(`File ${s.name} already exists`));const t=this.validateFile(s);if((0,n.dZ)(t))return t;e.add(s.name)}return(0,n.Ok)()}validateStackInstructions(){for(const t of Object.values(this.functionMap))for(const e of t.operations)if("pop"==e.op||"push"==e.op){const t=this.memory.baseSegment(e.segment,e.offset);if((0,n.dZ)(t))return(0,n.UG)((0,i.Tr)((0,n.UG)(t).message,e.span))}return(0,n.Ok)()}static validateFunctions(t){const e=new Set,s=[];for(const r of t){if("function"==r.op){if(r.nVars<0||r.nVars>32767)return(0,n.UG)((0,i.Tr)(`Illegal number of local variables ${r.nVars} (Expected 0-32767)`,r.span));e.add(r.name)}if("call"==r.op){if(r.nArgs<0||r.nArgs>32767)return(0,n.UG)((0,i.Tr)(`Illegal number of arguments ${r.nArgs} (Expected 0-32767)`,r.span));s.push(r)}}for(const r of s)if(!e.has(r.name)){if(!h[r.name])return(0,n.UG)((0,i.Tr)(`Undefined function ${r.name}`,r.span));if(h[r.name].nArgs!=r.nArgs)return(0,n.UG)(new Error(`OS function ${r.name} expects ${h[r.name].nArgs} arguments, not ${r.nArgs}`))}return(0,n.Ok)()}static buildFromFiles(t){let e=this.validateFiles(t);if((0,n.dZ)(e))return e;const s=t.map((t=>t.instructions)).reduce(((t,e)=>t.concat(e)));if(e=this.validateFunctions(s),(0,n.dZ)(e))return e;const i=new k,r=i.load(s);return(0,n.dZ)(r)?r:i.bootstrap()}static build(t){const e=this.validateFunctions(t);if((0,n.dZ)(e))return e;const s=new k,i=s.load(t);return(0,n.dZ)(i)?i:s.bootstrap()}static buildFunction(t,e){if("function"!==t[e].op)throw new Error("Only call buildFunction at the initial Function instruction");const{name:s,nVars:r}=t[e],a={name:s,nVars:r,labels:{},operations:[{op:"function",name:s,nVars:r,span:t[e].span}],opBase:0},o=new Set,c={};e+=1;t:for(;e<t.length;){switch(t[e].op){case"function":break t;case"add":case"sub":case"neg":case"and":case"or":case"not":case"gt":case"lt":case"eq":a.operations.push({op:t[e].op,span:t[e].span});break;case"push":case"pop":a.operations.push({op:t[e].op,segment:t[e].segment,offset:t[e].offset,span:t[e].span});break;case"call":a.operations.push({op:"call",name:t[e].name,nArgs:t[e].nArgs,span:t[e].span});break;case"goto":case"if-goto":{const{label:s}=t[e];c[s]=t[e].span,a.operations.push({op:t[e].op,label:s,span:t[e].span});break}case"label":{const{label:s}=t[e];if(o.add(s),a.labels[s])return(0,n.UG)((0,i.Tr)(`Cannot redeclare label ${s} in function ${a.name} (previously at line ${a.labels[s]+1})`,t[e].span));a.labels[s]=a.operations.length,a.operations.push({op:"label",label:s,span:t[e].span});break}case"return":a.operations.push({op:"return",span:t[e].span})}e+=1}for(const l of Object.keys(c))if(!o.has(l))return(0,n.UG)((0,i.Tr)(`Undeclared label ${l}`,c[l]));return(0,n.Ok)([a,e])}get RAM(){return this.memory}get Keyboard(){return this.memory.keyboard}get Screen(){return this.memory.screen}get invocation(){const t=this.executionStack.at(-1);return void 0===t?{frameBase:256,function:x,nArgs:0,opPtr:0,thisInitialized:!1,thatInitialized:!1}:t}get currentFunction(){return this.functionMap[this.invocation.function]}get operation(){if(this.currentFunction){if(this.invocation.opPtr>this.currentFunction.operations.length)throw new Error(`Current operation step beyond end of function operations (${this.invocation.opPtr} > ${this.currentFunction.operations.length})`);return this.currentFunction.operations[this.invocation.opPtr]}}load(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e&&(this.functionMap={},this.statics={},this.staticCount=0),"function"!==t[0]?.op&&t.unshift({op:"function",name:x,nVars:0});let s=0;for(;s<t.length;){const e=k.buildFunction(t,s);if((0,n.dZ)(e))return e;const[r,a]=(0,n.Wg)(e);if(this.functionMap[r.name]&&this.memory.strict&&r.name!==x&&r.name!==C.name)return(0,n.UG)((0,i.Tr)(`VM Already has a function named ${r.name}`,t[0].span));this.functionMap[r.name]=r,s=a}const r=this.validateStackInstructions();return(0,n.dZ)(r)?r:(this.registerStatics(),e&&this.bootstrap(),(0,n.Ok)(this))}bootstrap(){if(!this.functionMap[C.name]&&this.functionMap["Main.main"]&&(this.functionMap[C.name]=C,this.addedSysInit=!0),this.functionMap[C.name])this.entry=C.name;else if(this.functionMap[x])this.entry=x;else{const t=Object.keys(this.functionMap);1===t.length&&(this.entry=t[0])}if(this.functionMap[x]&&this.functionMap[C.name])return(0,n.UG)((0,i.Tr)("Cannot use both bootstrap and an implicit function"));if(""===this.entry)return(0,n.UG)((0,i.Tr)("Could not determine an entry point for VM"));this.functions=Object.values(this.functionMap),this.functions.sort(((t,e)=>t.name===this.entry?-1:e.name===this.entry?1:0));let t=0;return this.program=this.functions.reduce(((e,s)=>(s.name!=C.name&&(s.opBase=t),t+=s.operations.length,e.concat(s.operations))),[]),this.reset(),(0,n.Ok)(this)}reset(){this.executionStack=[{function:this.entry,opPtr:1,frameBase:256,nArgs:0,thisInitialized:!1,thatInitialized:!1}],this.memory.reset(),this.memory.SP=256,this.segmentInitializations={local:{initialized:!1,n:0},argument:{initialized:!1,n:0}},this.os.dispose(),this.os=new w(this.memory)}validateStackOp(t){if(this.currentFunction?.name==this.entry){for(const e of["local","argument"])if(t.segment==e){if(this.segmentInitializations[e].initialized)return void(this.segmentInitializations[e].n=Math.max(t.offset+1,this.segmentInitializations[e].n));throw new Error(`The ${e} segment cannot be accessed since it was not initialized`)}if("this"==t.segment&&this.invocation.thisInitialized)return void(this.invocation.thisN=Math.max(t.offset+1,this.invocation.thisN??0))}if("argument"==t.segment&&t.offset>=this.invocation.nArgs)throw new Error("Argument offset out of bounds");if("local"==t.segment&&t.offset>=this.functionMap[this.invocation.function]?.nVars)throw new Error("Local offset out of bounds");if("this"==t.segment&&!this.invocation.thisInitialized)throw new Error("The this segment cannot be accessed since it was not initialized");if("that"==t.segment&&!this.invocation.thatInitialized)throw new Error("The that segment cannot be accessed since it was not initialized")}step(){if(this.os.sys.halted)return this.os.sys.exitCode;if(this.os.sys.blocked)return;if(this.os.sys.released&&"call"==this.operation?.op){const t=this.os.sys.readReturnValue(),e=this.memory.SP-this.operation.nArgs;return this.memory.set(e,t),this.memory.SP=e+1,void(this.invocation.opPtr+=1)}if(void 0==this.operation)return this.os.sys.halt(),this.step();const t=this.operation;if("label"===t.op)return this.invocation.opPtr+=1,this.step();switch(t.op){case"push":{this.validateStackOp(t);const e=this.memory.getSegment(t.segment,t.offset);this.memory.push(e);break}case"pop":{this.validateStackOp(t);const e=this.memory.pop();this.memory.setSegment(t.segment,t.offset,e),"pointer"==t.segment&&(0==t.offset?(this.invocation.thisInitialized=!0,this.invocation.thisN=this.memory.get(this.memory.THIS-1)):1==t.offset&&(this.invocation.thatInitialized=!0));break}case"add":this.memory.binOp(((t,e)=>t+e));break;case"sub":this.memory.binOp(((t,e)=>t-e));break;case"neg":this.memory.unOp((t=>-t));break;case"and":this.memory.binOp(((t,e)=>t&e));break;case"or":this.memory.binOp(((t,e)=>t|e));break;case"not":this.memory.unOp((t=>~t));break;case"eq":this.memory.comp(((t,e)=>t===e));break;case"lt":this.memory.comp(((t,e)=>t<e));break;case"gt":this.memory.comp(((t,e)=>t>e));break;case"goto":this.goto(t.label);break;case"if-goto":0!=this.memory.pop()&&this.goto(t.label);break;case"call":{const e=t.name;if(this.functionMap[e]){const s=this.memory.pushFrame(this.invocation.opPtr,t.nArgs,this.functionMap[e].nVars);this.executionStack.push({function:e,opPtr:0,nArgs:t.nArgs,frameBase:s,thisInitialized:!1,thatInitialized:!1})}else if(h[e]){const s=h[e].func(this.memory,this.os);if(this.os.sys.blocked)return;const n=this.memory.SP-t.nArgs;this.memory.set(n,s),this.memory.SP=n+1}break}case"return":{const t=this.derivedLine();this.executionStack.pop();const e=this.memory.popFrame();if(this.invocation.opPtr=e,0===this.executionStack.length)return this.returnLine=t,0;break}}this.invocation.opPtr+=1}goto(t){if(this.currentFunction){if(void 0===this.currentFunction.labels[t])throw new Error(`Attempting GOTO to unknown label ${t} in ${this.currentFunction.name}`);this.invocation.opPtr=this.currentFunction.labels[t]}}write(t){t.map((t=>{let[e,s]=t;this.memory.set(e,s)}))}read(t){return t.map((t=>this.memory.get(t)))}vmStack(){return this.executionStack.map(((t,e)=>{const s=this.executionStack[e+1],n=s?s.frameBase-s.nArgs:this.memory.get(0);return this.makeFrame(t,n)}))}getUsedSegments(t){const e=new Set;for(const s of this.functionMap[t.function].operations)"push"!==s.op&&"pop"!=s.op||e.add(s.segment);return e}makeFrame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.invocation,e=arguments.length>1?arguments[1]:void 0;const s=this.functionMap[t.function];if(s.name===this.entry){const e=256+s.nVars,n=this.executionStack[1],i=n?n.frameBase-n.nArgs:this.memory.get(0),{ARG:r,LCL:a,THAT:o,THIS:c}=this.memory,l=this.segmentInitializations.argument.n,h=this.segmentInitializations.local.n,u=this.invocation.thisN??0;return{fn:s,args:{base:r,count:l,values:[...this.memory.map(((t,e)=>e),r,r+l)]},locals:{base:a,count:h,values:[...this.memory.map(((t,e)=>e),a,a+h)]},stack:{base:256,count:i-e,values:[...this.memory.map(((t,e)=>e),e,i)]},this:{base:c,count:u,values:[...this.memory.map(((t,e)=>e),c,c+u)]},that:{base:o,count:1,values:[this.memory.THAT]},frame:{ARG:r,LCL:a,RET:65535,THAT:o,THIS:c},usedSegments:this.getUsedSegments(t)}}const n=this.memory.getFrame(t.frameBase,t.nArgs,s.nVars,this.invocation.thisN??0,1,e);return n.fn=s,n.usedSegments=this.getUsedSegments(t),n}derivedLine(){return this.operation?.span?.line??this.returnLine??0}writeDebug(){const t=this.derivedLine(),e=Math.max(t-5,0),s=Math.min(t+3,this.program.length),n=this.program.slice(e,s).map(((s,n)=>`${n===t-e?"->":"  "} ${function(t){switch(t.op){case"add":case"and":case"sub":case"eq":case"gt":case"lt":case"neg":case"not":case"or":case"return":return`  ${t.op}`;case"goto":return`  ${t.op}    ${t.label}`;case"if-goto":return`  ${t.op} ${t.label}`;case"label":return`${t.op}     ${t.label}`;case"call":return`  ${t.op}    ${t.name} ${t.nArgs}`;case"function":return`${t.op}  ${t.name} ${t.nVars}`;case"pop":return`  ${t.op}     ${t.segment} ${t.offset}`;case"push":return`  ${t.op}    ${t.segment} ${t.offset}`}}(s)}`)).join("\n"),i=this.vmStack().at(-1);return i?n+"\n\n"+function(t){return[`Frame: ${t.fn?.name??"Unknown Fn"} ARG:${t.frame.ARG} LCL:${t.frame.LCL}`,`Args: ${I(t.args)}`,`Lcls: ${I(t.locals)}`,`Stck: ${I(t.stack)}`].join("\n")}(i):n}}function I(t){return`[${t.base};${t.count}][${t.values.join(", ")}]`}}}]);
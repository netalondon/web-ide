"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[547],{8815:(e,t,n)=>{n.r(t),n.d(t,{default:()=>w});var s=n(5072),r=n(1058),i=n(3478),a=n(3577),o=n(8963),c=n(6604),l=n(6791),d=n(5692),u=n(7054);const m="function Main.fibonacci 0\n    push argument 0\n    push constant 2\n    lt                     // checks if n<2\n    if-goto IF_TRUE\n    goto IF_FALSE\n    label IF_TRUE          // if n<2, return n\n    push argument 0        \n    return\n    label IF_FALSE         // if n>=2, returns fib(n-2)+fib(n-1)\n    push argument 0\n    push constant 2\n    sub\n    call Main.fibonacci 1  // computes fib(n-2)\n    push argument 0\n    push constant 1\n    sub\n    call Main.fibonacci 1  // computes fib(n-1)\n    add                    // returns fib(n-1) + fib(n-2)\n    return\nfunction Sys.init 0\n    push constant 4\n    call Main.fibonacci 1   // computes the 4'th fibonacci element\nlabel WHILE\n    goto WHILE              // loops infinitely\n";var p=n(2201),f=n(4430),h=n(8637),g=n(4388),v=n(5920),S=n(6845),b=n(4913),x=n(5969);const _="repeat {\n\tvmstep;\n}";function y(e,t,n){const s=new x.j(e.vm.RAM,t),r=new x.j(e.vm.Screen,t),i=new p.qT(new x.j(e.vm.RAM,t)),a=e.vm.derivedLine();let o=[];try{o=e.vm.vmStack().reverse()}catch(c){n("Runtime error: Invalid stack")}return{Keyboard:i,RAM:s,Screen:r,Stack:o,Prog:e.vm.program,Statics:[...e.vm.memory.map(((e,t)=>t),16,16+e.vm.getStaticCount())],Temp:[...e.vm.memory.map(((e,t)=>t),5,13)],AddedSysInit:e.vm.addedSysInit,highlight:a}}function j(){const{fs:e,setStatus:t,storage:n}=(0,S.useContext)(d.r),s=(0,S.useRef)((()=>{})),{initialState:r,reducers:i,actions:a}=(0,S.useMemo)((()=>function(e,t,n,s){const r=(0,u.Wg)(h.VM.parse(m));let i=(0,u.Wg)(v.Vm.build(r.instructions)),a=(new g.w).with(i),o=!1,c=!0;const l={setVm(e,t){e.files.vm=t},setTst(e,t){let{tst:n,cmp:s}=t;e.files.tst=n,e.files.cmp=s??""},setExitCode(e,t){e.controls.exitCode=t},setValid(e,t){e.controls.valid=t},update(e){e.vm=y(a,s,t),e.test.useTest=o,e.test.highlight=a.currentStep?.span},setAnimate(e,t){e.controls.animate=t},testStep(e){e.files.out=a.log()},testFinished(e){const n=(0,b.q)(e.files.cmp.trim(),e.files.out);t(n?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}},d={setVm(e){s.current({action:"setVm",payload:e});const n=h.VM.parse(e);if((0,u.dZ)(n))return s.current({action:"setValid",payload:!1}),t(`Parse error: ${n.err.message}`),!1;const r=(0,u.Wg)(n).instructions,i=v.Vm.build(r);return this.replaceVm(i)},loadVm(e){for(const t of e)t.content.endsWith("\n")&&(t.content=t.content.slice(0,-1));s.current({action:"setVm",payload:e.map((e=>e.content)).join("\n")});const n=[];let r=0;for(const a of e){const e=h.VM.parse(a.content);if((0,u.dZ)(e))return s.current({action:"setValid",payload:!1}),t(`Parse error: ${e.err.message}`),!1;const i=(0,u.Wg)(e).instructions;for(const t of i)void 0!=t.line&&(t.line+=r);r+=i.length,n.push({name:a.name,instructions:i})}const i=v.Vm.buildFromFiles(n);return this.replaceVm(i)},replaceVm:e=>(0,u.dZ)(e)?(s.current({action:"setValid",payload:!1}),t(`Build Error: ${e.err.message}`),!1):(s.current({action:"setValid",payload:!0}),t("Compiled VM code successfully"),i=(0,u.Wg)(e),a.vm=i,a.reset(),s.current({action:"update"}),!0),loadTest(e,n){s.current({action:"setTst",payload:{tst:e,cmp:n}});const r=f.qH.parse(e);return(0,u.dZ)(r)?(s.current({action:"setValid",payload:!1}),t("Failed to parse test"),!1):(s.current({action:"setValid",payload:!0}),t("Parsed tst"),i.reset(),a=g.w.from((0,u.Wg)(r)),a.vm=i,s.current({action:"update"}),!0)},setAnimate(e){c=e,s.current({action:"setAnimate",payload:e})},testStep(){let e=!1;try{return e=a.step(),s.current({action:"testStep"}),e&&s.current({action:"testFinished"}),c&&s.current({action:"update"}),e}catch(n){return t(`Runtime error: ${n.message}`),s.current({action:"setValid",payload:!1}),!0}},step(){try{let e=!1;const t=i.step();return void 0!==t&&(e=!0,s.current({action:"setExitCode",payload:t})),c&&s.current({action:"update"}),e}catch(e){return t(`Runtime error: ${e.message}`),s.current({action:"setValid",payload:!1}),!0}},reset(){a.reset(),i.reset(),s.current({action:"update"}),s.current({action:"setExitCode",payload:void 0}),s.current({action:"setValid",payload:!0})},toggleUseTest(){o=!o,s.current({action:"update"})},initialize(){this.loadVm([{name:"fib",content:m}])}};return{initialState:{vm:y(a,s,t),controls:{exitCode:void 0,runningTest:!1,animate:!0,valid:!0},test:{useTest:o,highlight:void 0},files:{vm:"",tst:_,cmp:"",out:""}},reducers:l,actions:d}}(0,t,0,s)),[e,t,n,s]),[o,l]=(0,c.C)(i,r);return s.current=l,{state:o,dispatch:s,actions:a}}var C=n(4619),I=n(9882),T=n(8722),E=n(9200),R=n(8398),A=n(558),L=n(864);const V={[I.b.SYS_WAIT_DURATION_NOT_POSITIVE]:r.ag._("Duration must be positive (Sys.wait)"),[I.b.ARRAY_SIZE_NOT_POSITIVE]:r.ag._("Array size must be positive (Array.new)"),[I.b.DIVIDE_BY_ZERO]:r.ag._("Division by zero (Math.divide)"),[I.b.SQRT_NEG]:r.ag._("Cannot compute square root of a negative number (Math.sqrt)"),[I.b.ALLOC_SIZE_NOT_POSITIVE]:r.ag._("Allocated memory size must be positive (Memory.alloc)"),[I.b.HEAP_OVERFLOW]:r.ag._("Heap overflow (Memory.alloc)"),[I.b.ILLEGAL_PIXEL_COORD]:r.ag._("Illegal pixel coordinates (Screen.drawPixel)"),[I.b.ILLEGAL_LINE_COORD]:r.ag._("Illegal line coordinates (Screen.drawLine)"),[I.b.ILLEGAL_RECT_COORD]:r.ag._("Illegal rectangle coordinates (Screen.drawRectangle)"),[I.b.ILLEGAL_CENTER_COORD]:r.ag._("Illegal center coordinates (Screen.drawCircle)"),[I.b.ILLEGAL_RADIUS]:r.ag._("Illegal radius (Screen.drawCircle)"),[I.b.STRING_LENGTH_NEG]:r.ag._("Maximum length must be non-negative (String.new)"),[I.b.GET_CHAR_INDEX_OUT_OF_BOUNDS]:r.ag._("String index out of bounds (String.charAt)"),[I.b.SET_CHAR_INDEX_OUT_OF_BOUNDS]:r.ag._("String index out of bounds (String.setCharAt)"),[I.b.STRING_FULL]:r.ag._("String is full (String.appendChar)"),[I.b.STRING_EMPTY]:r.ag._("String is empty (String.eraseLastChar)"),[I.b.STRING_INSUFFICIENT_CAPACITY]:r.ag._("Insufficient string capacity (String.setInt)"),[I.b.ILLEGAL_CURSOR_LOCATION]:r.ag._("Illegal cursor location (Output.moveCursor)")},w=()=>{const{state:e,actions:t,dispatch:n}=j(),{toolStates:r}=(0,S.useContext)(T.Il),{setStatus:u}=(0,S.useContext)(d.r),[m,p]=(0,c.i)(e.files.tst),[f,h]=(0,c.i)(e.files.out),[g,v]=(0,c.i)(e.files.cmp);(0,S.useEffect)((()=>{r.setTool("vm")}),[]),(0,S.useEffect)((()=>{t.initialize()}),[t]),(0,S.useEffect)((()=>{t.loadTest(m,g),t.reset()}),[m,g]),(0,S.useEffect)((()=>{void 0!==e.controls.exitCode&&u(0==e.controls.exitCode?"Program halted":`Program exited with error code ${e.controls.exitCode}${(0,I.q)(e.controls.exitCode)?`: ${V[e.controls.exitCode]}`:""}`)}),[e.controls.exitCode]);const b=(0,S.useRef)(),x=(0,S.useRef)(),[y,w]=(0,S.useState)(!1);(0,S.useEffect)((()=>(b.current=new class extends C.B{async tick(){return t.step()}finishFrame(){n.current({action:"update"})}reset(){u("Reset"),t.reset()}toggle(){n.current({action:"update"})}},x.current=new class extends C.B{async tick(){return t.testStep()}finishFrame(){n.current({action:"update"})}reset(){u("Reset"),t.reset()}toggle(){n.current({action:"update"})}},w(!0),()=>{var e,t;null===(e=b.current)||void 0===e||e.stop(),null===(t=x.current)||void 0===t||t.stop()})),[t,n]);const M=(0,S.useRef)(null),k=(0,S.useRef)(null),P=async e=>{var n;if(null===(n=e.target.files)||void 0===n||!n.length)return void u("No file selected");u("Loading");const s=[];for(const t of e.target.files)t.name.endsWith(".vm")&&s.push({name:t.name.replace(".vm",""),content:await t.text()});if(0==s.length)return void u("No .vm file was selected");t.loadVm(s)&&u("Loaded vm file")},F=e=>{t.setAnimate(e<=2)},U=(0,S.useRef)();return(0,L.jsxs)("div",{className:"Page VmPage grid",children:[(0,L.jsx)(R.s,{className:"program",header:(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(s.cC,{id:"VM Code"}),(0,L.jsx)("input",{type:"file",style:{display:"none"},ref:M,onChange:P}),(0,L.jsx)("input",{type:"file",webkitdirectory:"",style:{display:"none"},ref:k,onChange:P}),(0,L.jsxs)("fieldset",{role:"group",children:[(0,L.jsx)("button",{className:"flex-0",onClick:()=>{var e;null===(e=M.current)||void 0===e||e.click()},"data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc4"}),(0,L.jsx)("button",{className:"flex-0",onClick:()=>{var e;null===(e=k.current)||void 0===e||e.click()},"data-tooltip":"Load directory","data-placement":"bottom",children:"\ud83d\udcc2"})]})]}),children:(0,L.jsx)(E.M,{value:e.files.vm,onChange:e=>{t.setVm(e)},language:"vm",highlight:e.controls.valid?e.vm.highlight:void 0})}),(0,L.jsx)(R.s,{className:"stack",header:(0,L.jsx)(s.cC,{id:"VM Structures"}),children:e.controls.valid&&e.vm.Stack.length>0&&(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(N,{statics:e.vm.Statics,temp:e.vm.Temp,frame:e.vm.Stack[0]}),(0,L.jsx)(O,{stack:e.vm.Stack,addedSysInit:e.vm.AddedSysInit})]})}),(0,L.jsxs)(R.s,{className:"display",style:{gridArea:"display"},children:[y&&b.current&&(0,L.jsx)(l.D,{runner:b.current,disabled:!e.controls.valid,onSpeedChange:F}),(0,L.jsx)(o.l,{memory:e.vm.Screen}),(0,L.jsx)(i.N,{keyboard:e.vm.Keyboard}),(0,L.jsxs)("div",{style:{display:"flex",flexDirection:"row"},children:[(0,L.jsx)(a.ZP,{ref:U,name:"Global Stack",memory:e.vm.RAM,initialAddr:256,format:"dec",showUpload:!1,showClear:!1}),(0,L.jsx)(a.ZP,{name:"RAM",memory:e.vm.RAM,format:"dec",cellLabels:["SP:","LCL:","ARG:","THIS:","THAT:","TEMP1:","TEMP2:","TEMP3:","TEMP4:","TEMP5:","TEMP6:","TEMP7:","TEMP8:","R13:","R14:","R15:"],showUpload:!1,onChange:()=>{var e;null===(e=U.current)||void 0===e||e.rerender()}})]})]}),y&&(0,L.jsx)(A.F,{runner:x,tst:[m,p,e.test.highlight],out:[f,h],cmp:[g,v],showClear:!0,defaultTst:_,onSpeedChange:F,disabled:!e.controls.valid})]})};function M(e,t){const n={};e=e.filter((e=>{var t;return(null===(t=e.fn)||void 0===t?void 0:t.name)!=v.tN}));for(const r of e)r.fn&&(n[r.fn.name]?n[r.fn.name]++:n[r.fn.name]=1);const s=e.slice().reverse().map((e=>{var n,s,r;return(null===(n=e.fn)||void 0===n?void 0:n.name)==v.bU.name?t?`${v.bU.name} (built-in)`:v.bU.name:null!==(s=null===(r=e.fn)||void 0===r?void 0:r.name)&&void 0!==s?s:"Unknown function"}));for(const r of Object.keys(n))if(1!=n[r]){n[r]=0;for(let e=0;e<s.length;e++)s[e]===r&&(s[e]=`${r}[${n[r]}]`,n[r]++)}return s}function O(e){let{stack:t,addedSysInit:n}=e;return(0,L.jsx)("section",{children:(0,L.jsxs)("p",{children:["Call-stack:",(0,L.jsx)("code",{children:M(t,n).join(" > ")})]})})}function N(e){var t,n,s,r,i,a;let{statics:o,temp:c,frame:l}=e;return(0,L.jsx)("section",{children:(0,L.jsxs)("main",{children:[(0,L.jsxs)("p",{children:["Stack:",(0,L.jsxs)("code",{children:["[",l.stack.values.join(", "),"]"]})]}),(null===(t=l.usedSegments)||void 0===t?void 0:t.has("local"))&&(0,L.jsxs)("p",{children:["local:",(0,L.jsxs)("code",{children:["[",l.locals.values.join(", "),"]"]})]}),(null===(n=l.usedSegments)||void 0===n?void 0:n.has("argument"))&&(0,L.jsxs)("p",{children:["argument:",(0,L.jsxs)("code",{children:["[",l.args.values.join(", "),"]"]})]}),(null===(s=l.usedSegments)||void 0===s?void 0:s.has("static"))&&(0,L.jsxs)("p",{children:["static:",(0,L.jsxs)("code",{children:["[",o.join(", "),"]"]})]}),(null===(r=l.usedSegments)||void 0===r?void 0:r.has("pointer"))&&(0,L.jsxs)("p",{children:["pointer:",(0,L.jsxs)("code",{children:["[",`${l.frame.THIS}, ${l.frame.THAT}`,"]"]})]}),(null===(i=l.usedSegments)||void 0===i?void 0:i.has("that"))&&(0,L.jsxs)("p",{children:["that:",(0,L.jsxs)("code",{children:["[",l.that.values.join(", "),"]"]})]}),(null===(a=l.usedSegments)||void 0===a?void 0:a.has("temp"))&&(0,L.jsxs)("p",{children:["temp:",(0,L.jsxs)("code",{children:["[",c.join(", "),"]"]})]})]})})}},5969:(e,t,n)=>{n.d(t,{j:()=>r});var s=n(2201);class r extends s.kG{dispatch;constructor(e,t){super(e,e.size,0),this.dispatch=t}async load(e,t){await super.load(e,t),this.dispatch.current({action:"update"})}}},554:(e,t,n)=>{n.d(t,{j:()=>s});const s=e=>{if((e=>"function"===typeof e?.toString||"string"===typeof e)(e)){const t=e.toString();return"[object Object]"===t?JSON.stringify(e):t}return JSON.stringify(e)}},2936:(e,t,n)=>{n.d(t,{b:()=>r});var s=n(5251);function r(e,t){return void 0===e&&void 0!==s.BM[t]&&(e=t),{..."inline"===t?{display:"inline-block"}:{},width:s.BM[e]??"0"}}}}]);
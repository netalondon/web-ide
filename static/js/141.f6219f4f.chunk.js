"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[141],{6213:(t,e,s)=>{s.r(e),s.d(e,{CPU:()=>A,default:()=>P});var a=s(5072),r=s(4619),n=s(3478),i=s(1062),c=s(8963),l=s(7054),o=s(2201),u=s(4430);const d=new Int16Array([2,55944,0,64528,15,54018,1,64528,2,61584,54024,0,64648,2,55943,15,55943]);var p=s(9632),h=s(6845),m=s(4913),x=s(6604),b=s(5692);class j extends o.kG{dispatch;constructor(t,e){super(t,t.size,0),this.dispatch=e}async load(t,e){await super.load(t,e),this.dispatch.current({action:"update"})}}function f(t,e){const s=new j(t.cpu.RAM,e),a=new j(t.cpu.ROM,e),r=new j(t.cpu.Screen,e),n=new o.qT(new j(t.cpu.RAM,e));return{A:t.cpu.A,D:t.cpu.D,PC:t.cpu.PC,RAM:s,ROM:a,Screen:r,Keyboard:n}}function g(){const{fs:t,setStatus:e,storage:s}=(0,h.useContext)(b.r),a=(0,h.useRef)((()=>{})),{initialState:r,reducers:n,actions:i}=(0,h.useMemo)((()=>function(t,e,s,a){let r=new p.o6(new o.eD(d));const n={update(t){t.sim=f(r,a),t.test.highlight=r.currentStep?.span},setTest(t,e){let{tst:s,cmp:a}=e;t.test.tst=s??t.test.tst,t.test.cmp=a??t.test.cmp,t.test.out=""},testStep(t){t.test.out=r.log(),this.update(t)},testFinished(t){const s=(0,m.q)(t.test.cmp.trim(),r.log().trim());e(s?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}},i={tick(){r.cpu.tick()},testStep(){const t=r.step();return a.current({action:"testStep"}),t&&a.current({action:"testFinished"}),t},resetRAM(){r.cpu.RAM.loadBytes([]),a.current({action:"update"}),e("Reset RAM")},toggleUseTest(){a.current({action:"update"})},resetCPU(){r.reset(),a.current({action:"setTest",payload:{}}),a.current({action:"update"}),e("Reset CPU")},reset(){this.resetCPU(),e("Reset CPU & RAM")},compileTest(t,s){a.current({action:"setTest",payload:{tst:t,cmp:s}});const n=u.qH.parse(t);return(0,l.dZ)(n)?(e("Failed to parse test"),!1):(e("Parsed tst"),r=p.o6.from((0,l.Ok)(n),r.cpu.ROM),a.current({action:"update"}),!0)},initialize(){this.compileTest("repeat {\n  ticktock;\n}")}};return{initialState:{sim:f(r,a),test:{highlight:r.currentStep?.span,tst:"",cmp:"",out:""}},reducers:n,actions:i}}(0,e,0,a)),[t,e,s,a]),[c,j]=(0,x.C)(n,r);return a.current=j,{state:c,dispatch:a,actions:i}}var C=s(6791),y=s(8722),v=s(8398),S=s(1965),k=s(7880),R=s(9200),M=s(864);const w=t=>{let{runner:e,tst:[s,r,n],cmp:[i,c],out:[l],disabled:o=!1,onLoadTest:d}=t;const{fs:p,setStatus:m}=(0,h.useContext)(b.r),{filePicker:x,tracking:j}=(0,h.useContext)(y.Il),[f,g]=(0,h.useState)("tst"),w=(0,h.useCallback)((t=>{g(t),j.trackEvent("tab","change",t)}),[j]),A=(0,h.useCallback)((async()=>{try{const t=await x.select(),e=await p.readFile(t),s=await p.readFile(t.replace(/\.tst$/,".cmp"));null===d||void 0===d||d(e,s)}catch(t){console.error(t),m("Failed to load test")}}),[x,m,p]);return(0,M.jsx)(v.s,{className:"_test_panel",header:(0,M.jsxs)(M.Fragment,{children:[(0,M.jsx)("div",{className:"flex-0",children:(0,M.jsx)(a.cC,{id:"Test"})}),(0,M.jsx)("div",{className:"flex-1",children:e.current&&(0,M.jsx)(C.D,{runner:e.current})}),(0,M.jsx)("div",{children:(0,M.jsx)("fieldset",{role:"group",children:(0,M.jsx)("button",{onClick:A,children:"\ud83d\udcc2"})})})]}),children:(0,M.jsxs)("div",{role:"tablist",style:{"--tab-count":"3"},children:[(0,M.jsx)("div",{role:"tab",id:"test-tab-tst","aria-controls":"test-tabpanel-tst","aria-selected":"tst"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-tst",value:"tst",checked:"tst"===f,onChange:()=>w("tst")}),"Test Script"]})}),(0,M.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-tst",id:"test-tabpanel-tst",children:(0,M.jsx)(R.M,{value:s,onChange:r,grammar:u.qH.parser,language:"tst",highlight:n,disabled:o})}),(0,M.jsx)("div",{role:"tab",id:"test-tab-cmp","aria-controls":"test-tablpanel-cmp","aria-selected":"cmp"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-cmp",value:"cmp",checked:"cmp"===f,onChange:()=>w("cmp")}),"Compare File"]})}),(0,M.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-cmp",id:"test-tabpanel-cmp",style:{position:"relative"},children:(0,M.jsx)(R.M,{value:i,onChange:c,grammar:k.lA.parser,language:"cmp",disabled:o})}),(0,M.jsx)("div",{role:"tab",id:"test-tab-out","aria-controls":"test-tabpanel-out","aria-selected":"out"===f,children:(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-out",value:"out",checked:"out"===f,onChange:()=>w("out")}),"Output File"]})}),(0,M.jsx)("div",{role:"tabpanel",id:"test-tabpanel-out","aria-labelledby":"test-tab-out",children:(0,M.jsx)(S.M,{cmp:i,out:l})})]})})},A=()=>{const{state:t,actions:e,dispatch:s}=g(),{toolStates:l}=(0,h.useContext)(y.Il),[o,u]=(0,x.i)(t.test.tst),[d,p]=(0,x.i)(t.test.out),[m,b]=(0,x.i)(t.test.cmp),[j,f]=(0,h.useState)(),[S,k]=(0,h.useState)("asm"),[R,A]=(0,h.useState)(!0),[P,T]=(0,h.useState)(0);(0,h.useEffect)((()=>{e.initialize()}),[e]),(0,h.useEffect)((()=>{l.setTool("cpu"),l.cpuState.rom&&(t.sim.ROM.loadBytes(l.cpuState.rom),l.cpuState.name&&(f(l.cpuState.name),l.cpuState.name.endsWith(".hack")&&k("bin")))}),[]),(0,h.useEffect)((()=>{l.setCpuState(j,Array.from(t.sim.ROM.map(((t,e)=>e))))}),[t]);const F=(0,h.useRef)(),O=(0,h.useRef)(),[D,E]=(0,h.useState)(!1);(0,h.useEffect)((()=>(F.current=new class extends r.B{async tick(){return e.tick(),!1}finishFrame(){s.current({action:"update"})}reset(){e.reset()}toggle(){s.current({action:"update"})}},O.current=new class extends r.B{async tick(){return e.testStep()}finishFrame(){s.current({action:"update"})}reset(){e.reset()}toggle(){s.current({action:"update"})}},E(!0),()=>{var t,e;null===(t=F.current)||void 0===t||t.stop(),null===(e=O.current)||void 0===e||e.stop()})),[e,s]);return(0,M.jsxs)("div",{className:"CpuPage grid",children:[(0,M.jsx)(i.ZP,{name:"ROM",displayEnabled:R,memory:t.sim.ROM,highlight:t.sim.PC,format:S,onUpload:t=>{f(t),e.reset()}}),(0,M.jsx)(i.ZP,{name:"RAM",displayEnabled:R,memory:t.sim.RAM,format:"hex",onChange:()=>{T(P+1)}}),(0,M.jsxs)(v.s,{className:"IO",header:(0,M.jsxs)(M.Fragment,{children:[j&&(0,M.jsx)("div",{className:"flex-0",children:j}),(0,M.jsx)("div",{className:"flex-1",children:D&&F.current&&(0,M.jsx)(C.D,{runner:F.current})})]}),children:[(0,M.jsx)(c.l,{memory:t.sim.Screen},P),(0,M.jsx)(n.N,{update:()=>{s.current({action:"update"})},keyboard:t.sim.Keyboard}),(0,M.jsxs)("label",{children:[(0,M.jsx)("input",{type:"checkbox",role:"switch",checked:R,onChange:()=>{A(!R)}}),(0,M.jsx)(a.cC,{id:"{0}",values:{0:R?"Disable display":"Enable display"}})]}),R&&(0,M.jsx)("div",{children:(0,M.jsxs)("dl",{children:[(0,M.jsx)("dt",{children:"PC"}),(0,M.jsx)("dd",{children:t.sim.PC}),(0,M.jsx)("dt",{children:"A"}),(0,M.jsx)("dd",{children:t.sim.A}),(0,M.jsx)("dt",{children:"D"}),(0,M.jsx)("dd",{children:t.sim.D})]})})]}),D&&(0,M.jsx)(w,{runner:O,tst:[o,u,t.test.highlight],out:[d,p],cmp:[m,b],onLoadTest:(t,s)=>{e.compileTest(t,s)}})]})},P=A}}]);
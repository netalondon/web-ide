{"version":3,"file":"static/js/255.946641ac.chunk.js","mappings":"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","sources":["../../simulator/src/testing/mult.ts","../../components/src/stores/cpu.store.ts","shell/test_panel.tsx","pages/cpu.tsx"],"sourcesContent":["export const JACK = `\nwhile (R0 > 0) {\n    R2 = R2 + R1\n    R0 = R0 - 1\n}`;\n\nexport const ASM = `\n@R2\nM=0\n(LOOP)\n  @R0\n  D=M\n  @END\n  D;JEQ\n\n  @R1\n  D=M\n  @R2\n  D=D+M\n  M=D\n\n  @R0\n  M=M-1\n  @LOOP\n  0;JMP\n(END)\n  @END\n  0;JMP\n`;\n\nexport const HACK = new Int16Array([\n  0x0002, // @R2\n  0xda88, // M=0\n  0x0000, // (LOOP) @R0\n  0xfc10, // D=M\n  0x000f, // @END\n  0xd302, // D;JEQ\n  0x0001, // @R1\n  0xfc10, // D=M\n  0x0002, // @R2\n  0xf090, // D=D+M\n  0xd308, // M=D\n  0x0000, // @R0\n  0xfc88, // M=M-1\n  0x0002, // @LOOP\n  0xda87, // 0;JMP\n  0x000f, // (END) @END\n  0xda87, // 0;JMP\n]);\n","import { FileSystem } from \"@davidsouther/jiffies/lib/esm/fs\";\nimport { Ok, isErr } from \"@davidsouther/jiffies/lib/esm/result.js\";\nimport {\n  KeyboardAdapter,\n  MemoryAdapter,\n  MemoryKeyboard,\n  ROM,\n  SubMemory,\n} from \"@nand2tetris/simulator/cpu/memory.js\";\nimport { Span } from \"@nand2tetris/simulator/languages/base.js\";\nimport { TST } from \"@nand2tetris/simulator/languages/tst.js\";\nimport { HACK } from \"@nand2tetris/simulator/testing/mult.js\";\nimport { CPUTest } from \"@nand2tetris/simulator/tst.js\";\nimport { Dispatch, MutableRefObject, useContext, useMemo, useRef } from \"react\";\nimport { compare } from \"../compare.js\";\nimport { useImmerReducer } from \"../react.js\";\nimport { BaseContext } from \"./base.context.js\";\n\nfunction makeTst() {\n  return `repeat {\n  ticktock;\n}`;\n}\n\nexport interface CpuSim {\n  A: number;\n  D: number;\n  PC: number;\n  RAM: MemoryAdapter;\n  ROM: MemoryAdapter;\n  Screen: MemoryAdapter;\n  Keyboard: KeyboardAdapter;\n}\n\nexport interface CPUTestSim {\n  tst: string;\n  cmp: string;\n  out: string;\n  highlight: Span | undefined;\n}\n\nexport interface CpuPageState {\n  sim: CpuSim;\n  test: CPUTestSim;\n}\n\nclass ImmMemory extends SubMemory {\n  constructor(\n    parent: MemoryAdapter,\n    private dispatch: MutableRefObject<CpuStoreDispatch>\n  ) {\n    super(parent, parent.size, 0);\n  }\n\n  override async load(fs: FileSystem, path: string): Promise<void> {\n    await super.load(fs, path);\n    this.dispatch.current({ action: \"update\" });\n  }\n}\n\nfunction reduceCPUTest(\n  cpuTest: CPUTest,\n  dispatch: MutableRefObject<CpuStoreDispatch>\n): CpuSim {\n  const RAM = new ImmMemory(cpuTest.cpu.RAM, dispatch);\n  const ROM = new ImmMemory(cpuTest.cpu.ROM, dispatch);\n  const Screen = new ImmMemory(cpuTest.cpu.Screen, dispatch);\n  const Keyboard = new MemoryKeyboard(new ImmMemory(cpuTest.cpu.RAM, dispatch));\n\n  return {\n    A: cpuTest.cpu.A,\n    D: cpuTest.cpu.D,\n    PC: cpuTest.cpu.PC,\n    RAM,\n    ROM,\n    Screen,\n    Keyboard,\n  };\n}\n\nexport type CpuStoreDispatch = Dispatch<{\n  action: keyof ReturnType<typeof makeCpuStore>[\"reducers\"];\n  payload?: unknown;\n}>;\n\nexport function makeCpuStore(\n  fs: FileSystem,\n  setStatus: (status: string) => void,\n  storage: Record<string, string>,\n  dispatch: MutableRefObject<CpuStoreDispatch>\n) {\n  let test = new CPUTest(new ROM(HACK));\n\n  const reducers = {\n    update(state: CpuPageState) {\n      state.sim = reduceCPUTest(test, dispatch);\n      state.test.highlight = test.currentStep?.span;\n    },\n\n    setTest(state: CpuPageState, { tst, cmp }: { tst?: string; cmp?: string }) {\n      state.test.tst = tst ?? state.test.tst;\n      state.test.cmp = cmp ?? state.test.cmp;\n      state.test.out = \"\";\n    },\n\n    testStep(state: CpuPageState) {\n      state.test.out = test.log();\n      this.update(state);\n    },\n\n    testFinished(state: CpuPageState) {\n      const passed = compare(state.test.cmp.trim(), test.log().trim());\n      setStatus(\n        passed\n          ? `Simulation successful: The output file is identical to the compare file`\n          : `Simulation error: The output file differs from the compare file`\n      );\n    },\n  };\n\n  const actions = {\n    tick() {\n      test.cpu.tick();\n    },\n\n    testStep() {\n      const done = test.step();\n      dispatch.current({ action: \"testStep\" });\n      if (done) {\n        dispatch.current({ action: \"testFinished\" });\n      }\n      return done;\n    },\n\n    resetRAM() {\n      // test.cpu.RAM.set(0, 3);\n      // test.cpu.RAM.set(1, 2);\n      test.cpu.RAM.loadBytes([]);\n      dispatch.current({ action: \"update\" });\n      setStatus(\"Reset RAM\");\n    },\n\n    toggleUseTest() {\n      dispatch.current({ action: \"update\" });\n    },\n\n    resetCPU() {\n      test.reset();\n      dispatch.current({ action: \"setTest\", payload: {} });\n      dispatch.current({ action: \"update\" });\n      setStatus(\"Reset CPU\");\n    },\n\n    reset() {\n      this.resetCPU();\n      setStatus(\"Reset CPU & RAM\");\n    },\n\n    compileTest(file: string, cmp?: string) {\n      dispatch.current({ action: \"setTest\", payload: { tst: file, cmp } });\n      const tst = TST.parse(file);\n\n      if (isErr(tst)) {\n        setStatus(`Failed to parse test`);\n        return false;\n      }\n      setStatus(`Parsed tst`);\n\n      test = CPUTest.from(Ok(tst), test.cpu.ROM);\n      dispatch.current({ action: \"update\" });\n      return true;\n    },\n\n    initialize() {\n      this.compileTest(makeTst());\n    },\n  };\n\n  const initialState = {\n    sim: reduceCPUTest(test, dispatch),\n    test: {\n      highlight: test.currentStep?.span,\n      tst: \"\",\n      cmp: \"\",\n      out: \"\",\n    },\n  };\n\n  return { initialState, reducers, actions };\n}\n\nexport function useCpuPageStore() {\n  const { fs, setStatus, storage } = useContext(BaseContext);\n\n  const dispatch = useRef<CpuStoreDispatch>(() => undefined);\n\n  const { initialState, reducers, actions } = useMemo(\n    () => makeCpuStore(fs, setStatus, storage, dispatch),\n    [fs, setStatus, storage, dispatch]\n  );\n\n  const [state, dispatcher] = useImmerReducer(reducers, initialState);\n  dispatch.current = dispatcher;\n\n  return { state, dispatch, actions };\n}\n","import {\n  CSSProperties,\n  Dispatch,\n  RefObject,\n  useCallback,\n  useContext,\n  useState,\n} from \"react\";\nimport { Trans } from \"@lingui/macro\";\nimport { DiffTable } from \"@nand2tetris/components/difftable.js\";\nimport { Runbar } from \"@nand2tetris/components/runbar.js\";\nimport { CMP } from \"@nand2tetris/simulator/languages/cmp.js\";\nimport { BaseContext } from \"@nand2tetris/components/stores/base.context.js\";\nimport { Timer } from \"@nand2tetris/simulator/timer.js\";\nimport { TST } from \"@nand2tetris/simulator/languages/tst.js\";\nimport { AppContext } from \"../App.context\";\nimport { Editor } from \"./editor\";\nimport { Panel } from \"./panel\";\nimport { Span } from \"@nand2tetris/simulator/languages/base\";\n\nexport const TestPanel = ({\n  runner,\n  tst: [tst, setTst, tstHighlight],\n  cmp: [cmp, setCmp],\n  out: [out],\n  disabled = false,\n  onLoadTest = undefined,\n}: {\n  runner: RefObject<Timer | undefined>;\n  tst: [string, Dispatch<string>, Span | undefined];\n  cmp: [string, Dispatch<string>];\n  out: [string, Dispatch<string>];\n  disabled?: boolean;\n  onLoadTest?: (tst: string, cmp?: string) => void;\n}) => {\n  const { fs, setStatus } = useContext(BaseContext);\n  const { filePicker, tracking } = useContext(AppContext);\n\n  const [selectedTestTab, doSetSelectedTestTab] = useState<\n    \"tst\" | \"cmp\" | \"out\"\n  >(\"tst\");\n\n  const setSelectedTestTab = useCallback(\n    (tab: typeof selectedTestTab) => {\n      doSetSelectedTestTab(tab);\n      tracking.trackEvent(\"tab\", \"change\", tab);\n    },\n    [tracking]\n  );\n\n  const loadTest = useCallback(async () => {\n    try {\n      const path = await filePicker.select();\n      const tst = await fs.readFile(path);\n      const cmp = await fs.readFile(path.replace(/\\.tst$/, \".cmp\"));\n      onLoadTest?.(tst, cmp);\n      // await compile.current({ tst });\n    } catch (e) {\n      console.error(e);\n      setStatus(`Failed to load test`);\n    }\n  }, [filePicker, setStatus, fs]);\n\n  return (\n    <Panel\n      className=\"_test_panel\"\n      header={\n        <>\n          <div className=\"flex-0\">\n            <Trans>Test</Trans>\n          </div>\n          <div className=\"flex-1\">\n            {runner.current && <Runbar runner={runner.current} />}\n          </div>\n          <div>\n            <fieldset role=\"group\">\n              <button onClick={loadTest}>📂</button>\n            </fieldset>\n          </div>\n        </>\n      }\n    >\n      <div role=\"tablist\" style={{ \"--tab-count\": \"3\" } as CSSProperties}>\n        <div\n          role=\"tab\"\n          id=\"test-tab-tst\"\n          aria-controls=\"test-tabpanel-tst\"\n          aria-selected={selectedTestTab === \"tst\"}\n        >\n          <label>\n            <input\n              type=\"radio\"\n              name=\"test-tabs\"\n              aria-controls=\"test-tabpanel-tst\"\n              value=\"tst\"\n              checked={selectedTestTab === \"tst\"}\n              onChange={() => setSelectedTestTab(\"tst\")}\n            />\n            Test Script\n          </label>\n        </div>\n        <div\n          role=\"tabpanel\"\n          aria-labelledby=\"test-tab-tst\"\n          id=\"test-tabpanel-tst\"\n        >\n          <Editor\n            value={tst}\n            onChange={setTst}\n            grammar={TST.parser}\n            language={\"tst\"}\n            highlight={tstHighlight}\n            disabled={disabled}\n          />\n        </div>\n        <div\n          role=\"tab\"\n          id=\"test-tab-cmp\"\n          aria-controls=\"test-tablpanel-cmp\"\n          aria-selected={selectedTestTab === \"cmp\"}\n        >\n          <label>\n            <input\n              type=\"radio\"\n              name=\"test-tabs\"\n              aria-controls=\"test-tabpanel-cmp\"\n              value=\"cmp\"\n              checked={selectedTestTab === \"cmp\"}\n              onChange={() => setSelectedTestTab(\"cmp\")}\n            />\n            Compare File\n          </label>\n        </div>\n        <div\n          role=\"tabpanel\"\n          aria-labelledby=\"test-tab-cmp\"\n          id=\"test-tabpanel-cmp\"\n          style={{ position: \"relative\" }}\n        >\n          <Editor\n            value={cmp}\n            onChange={setCmp}\n            grammar={CMP.parser}\n            language={\"cmp\"}\n            disabled={disabled}\n          />\n        </div>\n        <div\n          role=\"tab\"\n          id=\"test-tab-out\"\n          aria-controls=\"test-tabpanel-out\"\n          aria-selected={selectedTestTab === \"out\"}\n        >\n          <label>\n            <input\n              type=\"radio\"\n              name=\"test-tabs\"\n              aria-controls=\"test-tabpanel-out\"\n              value=\"out\"\n              checked={selectedTestTab === \"out\"}\n              onChange={() => setSelectedTestTab(\"out\")}\n            />\n            Output File\n          </label>\n        </div>\n        <div\n          role=\"tabpanel\"\n          id=\"test-tabpanel-out\"\n          aria-labelledby=\"test-tab-out\"\n        >\n          <DiffTable cmp={cmp} out={out} />\n        </div>\n      </div>\n    </Panel>\n  );\n};\n","import { Timer } from \"@nand2tetris/simulator/timer.js\";\n\nimport { Keyboard } from \"@nand2tetris/components/chips/keyboard\";\nimport MemoryComponent from \"@nand2tetris/components/chips/memory.js\";\nimport { Screen } from \"@nand2tetris/components/chips/screen.js\";\nimport { useCpuPageStore } from \"@nand2tetris/components/stores/cpu.store\";\nimport { useContext, useEffect, useRef, useState } from \"react\";\n\nimport { Trans } from \"@lingui/macro\";\nimport { useStateInitializer } from \"@nand2tetris/components/react\";\nimport { Runbar } from \"@nand2tetris/components/runbar\";\nimport { loadHack } from \"@nand2tetris/simulator/loader.js\";\nimport { AppContext } from \"src/App.context\";\nimport { Panel } from \"src/shell/panel\";\nimport { TestPanel } from \"src/shell/test_panel\";\nimport \"./cpu.scss\";\n\nexport const CPU = () => {\n  const { state, actions, dispatch } = useCpuPageStore();\n  const { cpuProgram, setCpuProgram } = useContext(AppContext);\n\n  const [tst, setTst] = useStateInitializer(state.test.tst);\n  const [out, setOut] = useStateInitializer(state.test.out);\n  const [cmp, setCmp] = useStateInitializer(state.test.cmp);\n  const [fileName, setFileName] = useState<string | null>(null);\n  const [romFormat, setRomFormat] = useState(\"asm\");\n  const [displayEnabled, setDisplayEnabled] = useState(true);\n  const [screenRenderKey, setScreenRenderKey] = useState(0);\n\n  useEffect(() => {\n    actions.initialize();\n  }, [actions]);\n\n  useEffect(() => {\n    if (cpuProgram) {\n      loadHack(cpuProgram).then((bytes) => {\n        state.sim.ROM.loadBytes(bytes);\n        setRomFormat(\"bin\");\n        setCpuProgram(undefined);\n      });\n    }\n  }, [cpuProgram, setCpuProgram]);\n\n  const toggleDisplayEnabled = () => {\n    setDisplayEnabled(!displayEnabled);\n  };\n\n  const cpuRunner = useRef<Timer>();\n  const testRunner = useRef<Timer>();\n  const [runnersAssigned, setRunnersAssigned] = useState(false);\n  useEffect(() => {\n    cpuRunner.current = new (class CPUTimer extends Timer {\n      override tick() {\n        actions.tick();\n        return false;\n      }\n\n      override finishFrame() {\n        dispatch.current({ action: \"update\" });\n      }\n\n      override reset() {\n        actions.reset();\n      }\n\n      override toggle() {\n        dispatch.current({ action: \"update\" });\n      }\n    })();\n\n    testRunner.current = new (class CPUTestTimer extends Timer {\n      override tick() {\n        return actions.testStep();\n      }\n\n      override finishFrame() {\n        dispatch.current({ action: \"update\" });\n      }\n\n      override reset() {\n        actions.reset();\n      }\n\n      override toggle() {\n        dispatch.current({ action: \"update\" });\n      }\n    })();\n    setRunnersAssigned(true);\n\n    return () => {\n      cpuRunner.current?.stop();\n      testRunner.current?.stop();\n    };\n  }, [actions, dispatch]);\n\n  const onUpload = (fileName: string) => {\n    setFileName(fileName);\n    actions.reset();\n  };\n\n  const onLoadTest = (tst: string, cmp?: string) => {\n    actions.compileTest(tst, cmp);\n  };\n\n  const rerenderScreen = () => {\n    setScreenRenderKey(screenRenderKey + 1);\n  };\n\n  const onMemoryChange = () => {\n    rerenderScreen();\n  };\n\n  const onKeyChange = () => {\n    dispatch.current({ action: \"update\" });\n  };\n\n  return (\n    <div className=\"CpuPage grid\">\n      <MemoryComponent\n        name=\"ROM\"\n        displayEnabled={displayEnabled}\n        memory={state.sim.ROM}\n        highlight={state.sim.PC}\n        format={romFormat}\n        onUpload={onUpload}\n      />\n      <MemoryComponent\n        name=\"RAM\"\n        displayEnabled={displayEnabled}\n        memory={state.sim.RAM}\n        format=\"hex\"\n        onChange={onMemoryChange}\n      />\n      <Panel\n        className=\"IO\"\n        header={\n          <>\n            {fileName && <div className=\"flex-0\">{fileName}</div>}\n            <div className=\"flex-1\">\n              {runnersAssigned && cpuRunner.current && (\n                <Runbar runner={cpuRunner.current} />\n              )}\n            </div>\n          </>\n        }\n      >\n        <Screen key={screenRenderKey} memory={state.sim.Screen}></Screen>\n        <Keyboard update={onKeyChange} keyboard={state.sim.Keyboard} />\n        <label>\n          <input\n            type=\"checkbox\"\n            role=\"switch\"\n            checked={displayEnabled}\n            onChange={toggleDisplayEnabled}\n          />\n          <Trans>{displayEnabled ? \"Disable display\" : \"Enable display\"}</Trans>\n        </label>\n        {displayEnabled && (\n          <div>\n            <dl>\n              <dt>PC</dt>\n              <dd>{state.sim.PC}</dd>\n              <dt>A</dt>\n              <dd>{state.sim.A}</dd>\n              <dt>D</dt>\n              <dd>{state.sim.D}</dd>\n            </dl>\n          </div>\n        )}\n      </Panel>\n      {runnersAssigned && (\n        <TestPanel\n          runner={testRunner}\n          tst={[tst, setTst, state.test.highlight]}\n          out={[out, setOut]}\n          cmp={[cmp, setCmp]}\n          onLoadTest={onLoadTest}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default CPU;\n"],"names":["HACK","Int16Array","ImmMemory","SubMemory","dispatch","constructor","parent","super","size","async","fs","path","load","this","current","action","reduceCPUTest","cpuTest","RAM","cpu","ROM","Screen","Keyboard","MemoryKeyboard","A","D","PC","useCpuPageStore","setStatus","storage","useContext","BaseContext","useRef","initialState","reducers","actions","useMemo","test","CPUTest","update","state","sim","highlight","currentStep","span","setTest","tst","cmp","out","testStep","log","testFinished","passed","compare","trim","tick","done","step","resetRAM","loadBytes","toggleUseTest","resetCPU","reset","payload","compileTest","file","TST","isErr","Ok","initialize","makeCpuStore","dispatcher","useImmerReducer","TestPanel","runner","setTst","tstHighlight","setCmp","disabled","onLoadTest","filePicker","tracking","AppContext","selectedTestTab","doSetSelectedTestTab","useState","setSelectedTestTab","useCallback","tab","trackEvent","loadTest","select","readFile","replace","e","console","error","className","header","role","onClick","style","id","type","name","value","checked","onChange","grammar","language","position","CMP","CPU","cpuProgram","setCpuProgram","useStateInitializer","setOut","fileName","setFileName","romFormat","setRomFormat","displayEnabled","setDisplayEnabled","screenRenderKey","setScreenRenderKey","useEffect","loadHack","then","bytes","undefined","cpuRunner","testRunner","runnersAssigned","setRunnersAssigned","Timer","finishFrame","toggle","stop","memory","format","onUpload","keyboard"],"sourceRoot":""}
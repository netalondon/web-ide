"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[654],{8815:(e,t,s)=>{s.r(t),s.d(t,{VMInstructionRow:()=>A,VMStackFrame:()=>M,default:()=>T});var n=s(5072),a=s(3478),i=s(1062),r=s(8963),c=s(6604),l=s(5692),o=s(7054);var d=s(2201),u=s(4430),h=s(8637),m=s(4388),p=s(885),f=s(6845),g=s(4913),x=s(5969);function j(e,t){const s=new x.j(e.vm.RAM,t),n=new x.j(e.vm.Screen,t),a=new d.qT(new x.j(e.vm.RAM,t)),i=e.vm.derivedLine();return{Keyboard:a,RAM:s,Screen:n,Stack:e.vm.vmStack().reverse(),Prog:e.vm.program,highlight:i}}function b(){const{fs:e,setStatus:t,storage:s}=(0,f.useContext)(l.r),n=(0,f.useRef)((()=>{})),{initialState:a,reducers:i,actions:r}=(0,f.useMemo)((()=>function(e,t,s,n){const a=(0,o.Wg)(h.VM.parse("\nfunction Main.fibonacci 0\npush argument 0\npush constant 2\nlt                     // checks if n<2\nif-goto IF_TRUE\ngoto IF_FALSE\nlabel IF_TRUE          // if n<2, return n\npush argument 0        \nreturn\nlabel IF_FALSE         // if n>=2, returns fib(n-2)+fib(n-1)\npush argument 0\npush constant 2\nsub\ncall Main.fibonacci 1  // computes fib(n-2)\npush argument 0\npush constant 1\nsub\ncall Main.fibonacci 1  // computes fib(n-1)\nadd                    // returns fib(n-1) + fib(n-2)\nreturn\n\nfunction Sys.init 0\npush constant 4\ncall Main.fibonacci 1   // computes the 4'th fibonacci element\nlabel WHILE\ngoto WHILE              // loops infinitely\n"));let i=(0,o.Wg)(p.Vm.build(a.instructions)),r=(new m.w).with(i),c=!1,l=!0;const d={setTst(e,t){let{tst:s,cmp:n}=t;e.files.tst=s,e.files.cmp=n??""},update(e){e.vm=j(r,n),e.test.useTest=c,e.test.highlight=r.currentStep?.span},setAnimate(e,t){e.controls.animate=t},testStep(e){e.files.out=r.log()},testFinished(e){const s=(0,g.q)(e.files.cmp.trim(),e.files.out);t(s?"Simulation successful: The output file is identical to the compare file":"Simulation error: The output file differs from the compare file")}};return{initialState:{vm:j(r,n),controls:{error:"",runningTest:!1,animate:!0},test:{useTest:c,highlight:void 0},files:{tst:"",cmp:"",out:""}},reducers:d,actions:{loadVm(e){const s=h.VM.parse(e);if((0,o.dZ)(s))return t(`Error parsing vm file ${s.err}`),!1;const a=p.Vm.build((0,o.Wg)(s).instructions);return(0,o.dZ)(a)?(t(`Error building vm file ${a.err}`),!1):(i=(0,o.Wg)(a),r.vm=i,r.reset(),n.current({action:"update"}),!0)},loadTest(e,s){n.current({action:"setTst",payload:{tst:e,cmp:s}});const a=u.qH.parse(e);return(0,o.dZ)(a)?(t("Failed to parse test"),!1):(t("Parsed tst"),i.reset(),r=m.w.from((0,o.Wg)(a)),r.vm=i,n.current({action:"update"}),!0)},setAnimate(e){l=e,n.current({action:"setAnimate",payload:e})},step(){let e=!1;return c?(e=r.step(),n.current({action:"testStep"}),e&&n.current({action:"testFinished"})):i.step(),l&&n.current({action:"update"}),e},reset(){r.reset(),i.reset(),n.current({action:"update"})},toggleUseTest(){c=!c,n.current({action:"update"})},initialize(){this.loadTest("repeat {\n\tvmstep;\n}",""),n.current({action:"update"})}}}}(0,t,0,n)),[e,t,s,n]),[d,x]=(0,c.C)(i,a);return n.current=x,{state:d,dispatch:n,actions:r}}var v=s(4619),S=s(8722),k=s(8398),y=s(558),w=s(864);const T=()=>{const{state:e,actions:t,dispatch:s}=b(),{toolStates:o}=(0,f.useContext)(S.Il),[d,u]=(0,c.i)(e.files.tst),[h,m]=(0,c.i)(e.files.out),[p,g]=(0,c.i)(e.files.cmp);(0,f.useEffect)((()=>{o.setTool("vm")}),[]),(0,f.useEffect)((()=>{t.initialize()}),[t]);const[x,j]=(0,f.useState)("Stack"),T=(0,f.useRef)(),[F,R]=(0,f.useState)(!1);(0,f.useEffect)((()=>(T.current=new class extends v.B{async tick(){return t.step()}finishFrame(){s.current({action:"update"})}reset(){t.reset()}toggle(){s.current({action:"update"})}},R(!0),()=>{var e;null===(e=T.current)||void 0===e||e.stop()})),[t,s]);const C=(0,f.useRef)(null),{setStatus:E}=(0,f.useContext)(l.r);return(0,w.jsxs)("div",{className:"Page VmPage grid",children:[(0,w.jsx)(k.s,{className:"program",header:(0,w.jsxs)(w.Fragment,{children:[(0,w.jsx)(n.cC,{id:"Program"}),(0,w.jsx)("input",{type:"file",style:{display:"none"},ref:C,onChange:async e=>{var s;if(null===(s=e.target.files)||void 0===s||!s.length)return void E("No file selected");E("Loading");const n=e.target.files[0],a=await n.text();if(!n.name.endsWith(".vm"))return void E("File must be .vm file");t.loadVm(a)&&E("Loaded vm file")}}),(0,w.jsx)("button",{className:"flex-0",onClick:()=>{var e;null===(e=C.current)||void 0===e||e.click()},"data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"})]}),children:(0,w.jsx)("main",{children:(0,w.jsxs)("table",{children:[(0,w.jsx)("thead",{children:(0,w.jsxs)("tr",{children:[(0,w.jsx)("td",{children:"Inst"}),(0,w.jsx)("td",{children:"Target"}),(0,w.jsx)("td",{children:"Val"})]})}),(0,w.jsx)("tbody",{children:e.vm.Prog.map(((t,s)=>A({inst:t,key:s,highlighted:s===e.vm.highlight})))})]})})}),(0,w.jsxs)(k.s,{className:"IO",children:[(0,w.jsx)("div",{children:(0,w.jsxs)("label",{children:[(0,w.jsx)("input",{type:"checkbox",onChange:t.toggleUseTest,checked:e.test.useTest,role:"switch"}),"Use Test Script"]})}),(0,w.jsx)(r.l,{memory:e.vm.Screen}),(0,w.jsx)(a.N,{keyboard:e.vm.Keyboard}),e.controls.animate?(0,w.jsxs)("div",{role:"tablist",style:{"--tab-count":"2"},children:[(0,w.jsx)("div",{role:"tab",id:"mem-tab-stack","aria-controls":"mem-tabpanel","aria-selected":"Stack"===x,children:(0,w.jsxs)("label",{children:[(0,w.jsx)("input",{type:"radio",name:"mem-tabs","aria-controls":"mem-tabpanel",value:"tst",checked:"Stack"===x,onChange:()=>j("Stack")}),"Stack"]})}),(0,w.jsx)("div",{role:"tabpanel","aria-labelledby":"mem-tab-stack",id:"mem-tabpanel",children:e.vm.Stack.map(((e,t)=>(0,w.jsx)(M,{frame:e},t)))}),(0,w.jsx)("div",{role:"tab",id:"mem-tab-ram","aria-controls":"mem-tabpanel","aria-selected":"RAM"===x,children:(0,w.jsxs)("label",{children:[(0,w.jsx)("input",{type:"radio",name:"mem-tabs","aria-controls":"mem-tabpanel",value:"tst",checked:"RAM"===x,onChange:()=>j("RAM")}),"RAM"]})}),(0,w.jsx)("div",{role:"tabpanel","aria-labelledby":"mem-tab-ram",id:"mem-tabpanel",children:(0,w.jsx)(i.ZP,{memory:e.vm.RAM,format:"hex"})})]}):(0,w.jsx)("p",{children:"Hiding display for high speeds"})]}),F&&(0,w.jsx)(y.F,{runner:T,tst:[d,u,e.test.highlight],out:[h,m],cmp:[p,g],onLoadTest:t.loadTest,onSpeedChange:e=>{t.setAnimate(e<=2)}})]})};function M(e){var t,s;let{frame:n}=e;return(0,w.jsxs)("section",{children:[(0,w.jsx)("header",{children:(0,w.jsxs)("h3",{children:["Function",(0,w.jsx)("code",{children:null!==(t=null===(s=n.fn)||void 0===s?void 0:s.name)&&void 0!==t?t:"Unknown Function"})]})}),(0,w.jsxs)("main",{children:[(0,w.jsxs)("p",{children:[(0,w.jsx)("em",{children:"Args:"}),(0,w.jsxs)("code",{children:["[",n.args.values.join(", "),"]"]})]}),(0,w.jsxs)("p",{children:[(0,w.jsx)("em",{children:"Locals:"}),(0,w.jsxs)("code",{children:["[",n.locals.values.join(", "),"]"]})]}),(0,w.jsxs)("p",{children:[(0,w.jsx)("em",{children:"Stack:"}),(0,w.jsxs)("code",{children:["[",n.stack.values.join(", "),"]"]})]})]})]})}function A(e){let{inst:t,key:s,highlighted:n}=e;switch(t.op){case"add":case"and":case"eq":case"gt":case"lt":case"neg":case"not":case"or":case"sub":case"return":return(0,w.jsxs)("tr",{className:n?"highlight":"",children:[(0,w.jsx)("td",{children:t.op}),(0,w.jsx)("td",{colSpan:2})]},s);case"if-goto":case"label":case"goto":return(0,w.jsxs)("tr",{className:n?"highlight":"",children:[(0,w.jsx)("td",{children:t.op}),(0,w.jsx)("td",{colSpan:2,children:t.label})]},s);case"function":case"call":return(0,w.jsxs)("tr",{className:n?"highlight":"",children:[(0,w.jsx)("td",{children:t.op}),(0,w.jsx)("td",{children:t.name}),(0,w.jsx)("td",{children:"call"===t.op?t.nArgs:t.nVars})]},s);case"pop":case"push":return(0,w.jsxs)("tr",{className:n?"highlight":"",children:[(0,w.jsx)("td",{children:t.op}),(0,w.jsx)("td",{children:t.segment}),(0,w.jsx)("td",{children:t.offset})]},s);default:return(0,w.jsx)("tr",{className:n?"highlight":"",children:(0,w.jsx)("td",{colSpan:3,children:"Unknown"})},s)}}},5969:(e,t,s)=>{s.d(t,{j:()=>a});var n=s(2201);class a extends n.kG{dispatch;constructor(e,t){super(e,e.size,0),this.dispatch=t}async load(e,t){await super.load(e,t),this.dispatch.current({action:"update"})}}}}]);
"use strict";(self.webpackChunk_nand2tetris_web=self.webpackChunk_nand2tetris_web||[]).push([[444],{558:(t,e,s)=>{s.d(e,{F:()=>m});var n=s(5072),r=s(4913),i=s(6791),o=s(5692),a=s(7880),c=s(4430),l=s(6845),h=s(8722),u=s(9200),d=s(8398),p=s(864);const m=t=>{var e,s;let{runner:m,tst:[g,f,b],cmp:[y,v],out:[w],disabled:S=!1,onLoadTest:k,onSpeedChange:x}=t;const{fs:A,setStatus:C}=(0,l.useContext)(o.r),{filePicker:M,tracking:L}=(0,l.useContext)(h.Il),[O,P]=(0,l.useState)("tst"),T=(0,l.useCallback)((t=>{P(t),L.trackEvent("tab","change",t)}),[L]),I=(0,l.useCallback)((async()=>{try{const e=await M.select(),s=await A.readFile(e);let n;try{const t=e.replace("VME.tst",".tst").replace(".tst",".cmp");n=await A.readFile(t)}catch(t){}null===k||void 0===k||k(s,n)}catch(t){console.error(t),C("Failed to load test")}}),[M,C,A]),[R,j]=(0,l.useState)();return(0,l.useEffect)((()=>{j((0,r.B)(y,w))}),[w,y]),(0,p.jsx)(d.s,{className:"_test_panel",header:(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{className:"flex-0",children:(0,p.jsx)(n.cC,{id:"Test"})}),(0,p.jsx)("div",{className:"flex-1",children:m.current&&(0,p.jsx)(i.D,{runner:m.current,onSpeedChange:x})}),(0,p.jsx)("div",{children:(0,p.jsx)("fieldset",{role:"group",children:(0,p.jsx)("button",{onClick:I,children:"\ud83d\udcc2"})})})]}),children:(0,p.jsxs)("div",{role:"tablist",style:{"--tab-count":"3"},children:[(0,p.jsx)("div",{role:"tab",id:"test-tab-tst","aria-controls":"test-tabpanel-tst","aria-selected":"tst"===O,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-tst",value:"tst",checked:"tst"===O,onChange:()=>T("tst")}),"Test Script"]})}),(0,p.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-tst",id:"test-tabpanel-tst",children:(0,p.jsx)(u.M,{value:g,onChange:f,grammar:c.qH.parser,language:"tst",highlight:b,disabled:S})}),(0,p.jsx)("div",{role:"tab",id:"test-tab-cmp","aria-controls":"test-tablpanel-cmp","aria-selected":"cmp"===O,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-cmp",value:"cmp",checked:"cmp"===O,onChange:()=>T("cmp")}),"Compare File"]})}),(0,p.jsx)("div",{role:"tabpanel","aria-labelledby":"test-tab-cmp",id:"test-tabpanel-cmp",style:{position:"relative"},children:(0,p.jsx)(u.M,{value:y,onChange:v,grammar:a.lA.parser,language:"cmp",disabled:S,lineNumberTransform:t=>""})}),(0,p.jsx)("div",{role:"tab",id:"test-tab-out","aria-controls":"test-tabpanel-out","aria-selected":"out"===O,children:(0,p.jsxs)("label",{children:[(0,p.jsx)("input",{type:"radio",name:"test-tabs","aria-controls":"test-tabpanel-out",value:"out",checked:"out"===O,onChange:()=>T("out")}),"Output File"]})}),(0,p.jsxs)("div",{role:"tabpanel",id:"test-tabpanel-out","aria-labelledby":"test-tab-out",children:[""==w&&(0,p.jsx)("p",{children:"Execute test script to compare output."}),(null!==(e=null===R||void 0===R?void 0:R.failureNum)&&void 0!==e?e:0)>0&&(0,p.jsxs)("p",{children:[null===R||void 0===R?void 0:R.failureNum," comparison failure",1===(null===R||void 0===R?void 0:R.failureNum)?"":"s",". Scroll down for details"]}),(0,p.jsx)(u.M,{value:null!==(s=null===R||void 0===R?void 0:R.text)&&void 0!==s?s:"",onChange:()=>{},language:"",disabled:!0,lineNumberTransform:t=>"",customDecorations:null===R||void 0===R?void 0:R.correctCellSpans.map((t=>({span:t,cssClass:"green"}))).concat(null===R||void 0===R?void 0:R.incorrectCellSpans.map((t=>({span:t,cssClass:"red"}))))})]})]})})}},3478:(t,e,s)=>{s.d(e,{N:()=>c});var n=s(864),r=s(6845),i=s(2869);const o={Enter:128,Backspace:129,ArrowLeft:130,ArrowUp:131,ArrowRight:132,ArrowDown:133,Home:134,End:135,PageUp:136,PageDown:137,Insert:138,Delete:139,Escape:140,F1:141,F2:142,F3:143,F4:144,F5:145,F6:146,F7:147,F8:148,F9:149,F10:150,F11:151,F12:152},a={ArrowLeft:"L-arrow",ArrowUp:"U-arrow",ArrowRight:"R-arrow",ArrowDown:"D-arrow"};const c=t=>{let{keyboard:e,update:s}=t;const[c,l]=(0,r.useState)(!1),[h,u]=(0,r.useState)(""),[d,p]=(0,r.useState)(e.getKey());let m=0;const g=t=>{if(!c)return;u(function(t){return a[t]??t}(t.key));const e=function(t){const e=o[t.key];if(void 0!==e)return e;if(1===t.key.length){const e=t.key.charCodeAt(0);if(e>=32&&e<=126)return e}return 0}(t);e!==m&&(b(e),s?.())},f=t=>{c&&(m=0,e.clearKey(),s?.(),p(e.getKey()),u(""))},b=t=>{0!==t&&(e.setKey(t),p(e.getKey()),m=t)};return(0,r.useEffect)((()=>(window.addEventListener("keydown",g),window.addEventListener("keyup",f),()=>{window.removeEventListener("keydown",g),window.removeEventListener("keyup",f)}))),(0,n.jsxs)("div",{className:"flex row align-baseline",children:[(0,n.jsx)("div",{className:"flex-2",children:(0,n.jsx)(i.y,{name:"Key",bits:d})}),(0,n.jsxs)("div",{className:"flex-2",children:["Char: ",h]}),(0,n.jsx)("div",{className:"flex-3",children:(0,n.jsx)("button",{onClick:()=>{l(!c)},children:(c?"Disable":"Enable")+" Keyboard"})})]})}},1062:(t,e,s)=>{s.d(e,{zp:()=>S,ZP:()=>k});var n=s(864),r=s(4089),i=s(6845),o=s(2201),a=s(6699),c=s(6871),l=s(5150),h=s(5554),u=s(5251);var d=s(6604);const p=0,m=1,g=t=>{const[e,s]=(0,i.useState)(t.mode??p),[r,o]=(0,d.i)(t.value),a=()=>{return(0,n.jsx)("span",{style:{cursor:"text",...(t="full",e="inline",void 0===t&&void 0!==u.BM[e]&&(t=e),{..."inline"===e?{display:"inline-block"}:{},width:u.BM[t]??"0"})},onClick:()=>{s(m)},children:r});var t,e},c=(0,i.useCallback)((t=>t?.select()),[]),l=(0,i.useCallback)((e=>{s(p),o(e.value??""),t.onChange(e.value??"")}),[t,s,o]),h=()=>(0,n.jsx)("span",{style:{display:"block",position:"relative"},children:(0,n.jsx)("input",{ref:c,style:{zIndex:"10",position:"absolute",left:"0",marginTop:"-0.375rem",color:"var(--text-color)"},onFocus:t.onFocus,onBlur:t=>{let{target:e}=t;return l(e)},onKeyPress:t=>{let{key:e,target:s}=t;"Enter"===e&&l(s)},type:"text",defaultValue:r})});return(()=>{switch(e){case m:return h();case p:return a();default:return(0,n.jsx)("span",{})}})()};var f=s(5692);function b(t,e,s){const{totalHeight:n,toleranceHeight:r,bufferedItems:i,settings:{itemHeight:o,minIndex:a,maxIndex:c}}=e,l=a+Math.floor((t-r)/o),h=function(t,e,s,n,r){const i=Math.max(0,t,s);return[...r(i,Math.min(e,s+n-1)-i)]}(a,c,l,i,s),u=Math.max((l-a)*o,0);return{scrollTop:t,topPaddingHeight:u,bottomPaddingHeight:Math.max(n-(u+h.length*o),0),data:h}}const y=t=>{const e=(0,i.useRef)(null),{settings:s,startState:r,reducer:o}=(0,i.useMemo)((()=>{const e=function(t){const{minIndex:e=0,maxIndex:s=Number.MAX_SAFE_INTEGER,startIndex:n=0,itemHeight:r=20,count:i=Math.max(s-e,1),tolerance:o=i}=t;return{minIndex:e,maxIndex:s,startIndex:n,itemHeight:r,count:i,tolerance:o}}(t.settings??{}),s=function(t,e){const{minIndex:s,maxIndex:n,startIndex:r,itemHeight:i,count:o,tolerance:a}=t,c=o+2*a,l=Math.max(0,r-a-s),h=o*i,u=Math.max(n-s,1)*i,d=a*i,p=l*i,m={scrollTop:0,settings:t,viewportHeight:h,totalHeight:u,toleranceHeight:d,bufferedItems:c,topPaddingHeight:p,bottomPaddingHeight:u-(p+(h+2*d)),data:[]};return{...m,...b(p+d,m,e)}}(e,t.get),n=(r=t.get,(t,e)=>({...t,...b(e,t,r)}));var r;return{settings:e,reducer:n,startState:s}}),[t.settings,t.get]),[a,c]=(0,i.useReducer)(o,r);(0,i.useEffect)((()=>{null!==e.current&&c(e.current.scrollTop)}),[s,t.row]);const l=(0,i.useCallback)((t=>{t&&(t.scrollTop=e.current?e.current.scrollTop:s.startIndex*s.itemHeight),e.current=t}),[e,s.startIndex,s.itemHeight]),h=a.data.map((e=>(0,n.jsx)("div",{style:{height:`${s.itemHeight}px`},children:t.row(e)},t.rowKey(e))));return(0,n.jsxs)("div",{ref:l,style:{height:`${a.viewportHeight}px`,overflowY:"scroll",overflowAnchor:"none"},className:t.className??"",onScroll:t=>c(t.target.scrollTop),children:[(0,n.jsx)("div",{style:{height:`${a.topPaddingHeight}px`}}),h,(0,n.jsx)("div",{style:{height:`${a.bottomPaddingHeight}px`}})]})},v=t=>{let{memory:e,jmp:s={value:0},highlight:r=-1,editable:o=!1,justifyLeft:a=!1,format:c=l.E_,onChange:h=(()=>{}),onFocus:u=(()=>{})}=t;const d=(0,i.useMemo)((()=>({count:Math.min(e.size,25),maxIndex:e.size,itemHeight:34,startIndex:s.value})),[e.size,s]),p=(0,i.useCallback)(((t,s)=>e.range(t,t+s).map(((e,s)=>[s+t,e]))),[e]),m=(0,i.useCallback)((t=>{let[s,i]=t;return(0,n.jsx)(w,{index:s,value:c(i),size:e.size,editable:o,justifyLeft:a,highlight:s===r,onChange:h,onFocus:u})}),[c,o,r,h]);return(0,n.jsx)(y,{settings:d,get:p,row:m,rowKey:t=>{let[e]=t;return e}})},w=t=>{let{index:e,value:s,size:i,highlight:o=!1,editable:a=!1,justifyLeft:c=!1,onChange:h=(()=>{}),onFocus:u=(()=>{})}=t;return(0,n.jsxs)("div",{style:{display:"flex",height:"100%"},children:[(0,n.jsx)("code",{style:{...(0,r.eP)("none"),...o?{background:"var(--mark-background-color)"}:{},whiteSpace:"pre"},children:i?(0,l.E_)(e).padStart(Math.ceil(Math.log10(i))," "):(0,l.E_)(e)}),(0,n.jsx)("code",{style:{flex:"1",textAlign:c?"left":"right",color:"var(--text-color)",...(0,r.eP)("none"),...o?{background:"var(--mark-background-color)"}:{}},children:a?(0,n.jsx)(g,{value:s,highlight:o,onChange:t=>h(e,t,Number(s)),onFocus:()=>u(e)}):(0,n.jsx)("span",{style:{color:"var(--text-color)"},children:s})})]})},S=t=>{let{name:e="Memory",displayEnabled:s=!0,highlight:r=-1,editable:u=!0,memory:p,format:m="dec",onUpload:g,onChange:b}=t;const[y,w]=(0,d.i)(m),[S,k]=(0,i.useState)(""),[x,A]=(0,i.useState)({value:0}),[C,M]=(0,d.i)(r),[L,O]=(0,i.useState)(0),P=()=>{const t=!isNaN(parseInt(S))&&isFinite(parseInt(S))?Number(S):0;M(t),A({value:t})},T=(0,i.useRef)(null),I=(0,i.useCallback)((()=>{b?.(),T.current?.click()}),[T]),{setStatus:R}=(0,i.useContext)(f.r),j=(0,i.useCallback)((async t=>{if(!t.target.files?.length)return void R("No file selected");const e=t.target.files[0];g?.(e.name);const s=await e.text(),n=e.name.endsWith("hack")?a.$W:e.name.endsWith("asm")?a.eC:a.uC,r=await n(s);p.loadBytes(r),t.target.value="",w(e.name.endsWith("hack")?"bin":e.name.endsWith("asm")?"asm":y),P()}),[]),F=()=>{O(L+1)};return(0,h._W)((()=>{k(""),A({value:0})})),(0,n.jsxs)("article",{className:`panel memory ${e}`,children:[(0,n.jsxs)("header",{children:[(0,n.jsx)("div",{children:e}),(0,n.jsxs)("fieldset",{role:"group",children:[(0,n.jsx)("input",{type:"file",style:{display:"none"},ref:T,onChange:j}),(0,n.jsx)("button",{onClick:I,className:"flex-0","data-tooltip":"Load file","data-placement":"bottom",children:"\ud83d\udcc2"}),(0,n.jsx)("button",{onClick:()=>{p.reset(),b?.(),F()},className:"flex-0","data-tooltip":"Clear","data-placement":"bottom",children:"\ud83c\udd91"}),(0,n.jsx)("input",{style:{width:"4em",height:"100%"},placeholder:"Addr",value:S,onKeyDown:t=>{let{key:e}=t;return"Enter"===e&&P()},onChange:t=>{let{target:{value:e}}=t;return k(e)}}),(0,n.jsx)("button",{onClick:P,className:"flex-0","data-tooltip":"Scroll to address","data-placement":"bottom",children:"\u2935\ufe0f"}),(0,n.jsx)("select",{value:y,onChange:t=>w(t.target.value),children:o.I2.map((t=>(0,n.jsx)("option",{children:t},t)))})]})]}),s?(0,n.jsx)(v,{jmp:x,memory:p,highlight:C,editable:u,justifyLeft:"asm"==y,format:t=>function(t,e){switch(t){case"bin":return(0,l.Ly)(e);case"hex":return(0,l.$v)(e);case"asm":return(0,c.a)(e);default:return(0,l.E_)(e)}}(y,t),onChange:(t,e)=>{p.update(t,e,y??"dec"),b?.(),F()},onFocus:t=>M(t)},L):"Memory display is disabled"]})},k=S},2869:(t,e,s)=>{s.d(e,{y:()=>i});var n=s(864),r=s(5150);const i=t=>{let{name:e,bits:s}=t;return(0,n.jsxs)("div",{children:[e,": ",(0,r.E_)(s)]})}},8963:(t,e,s)=>{s.d(e,{l:()=>l});var n=s(864),r=s(7239),i=s(6845),o=s(5554);const a="white";function c(t,e,s,n){const r=4*(512*s+e),i=n===a?255:0;t[r]=i,t[r+1]=i,t[r+2]=i,t[r+3]=255}const l=t=>{let{memory:e}=t;const s=(0,i.useRef)(),l=(0,i.useCallback)((()=>{const t=s.current?.getContext("2d")??void 0;t&&function(t,e){const s=(0,r.kP)(t.getImageData(0,0,512,256),"Failed to create Context2d");for(let r=0;r<512;r++)for(let t=0;t<256;t++){const o=(n=r,i=t,0===(e.get(32*i+(n/16|0))&1<<n%16)?a:"black");c(s.data,r,t,o)}var n,i;t.putImageData(s,0,0)}(t,e)}),[e]),h=(0,i.useCallback)((t=>{s.current=t??void 0,l()}),[s,l]);return(0,o.RC)(l),(0,o._W)((()=>{s.current?.getContext("2d")?.clearRect(0,0,s.current.width,s.current.height)})),(0,n.jsxs)("article",{className:"panel",children:[(0,n.jsx)("header",{children:"Screen"}),(0,n.jsx)("main",{style:{backgroundColor:"var(--code-background-color)"},children:(0,n.jsx)("figure",{style:{width:"100%",maxWidth:"512px",boxSizing:"content-box",marginInline:"auto",margin:"auto",borderTop:"2px solid gray",borderLeft:"2px solid gray",borderBottom:"2px solid lightgray",borderRight:"2px solid lightgray"},children:(0,n.jsx)("canvas",{ref:h,width:512,height:256})})})]})}},5554:(t,e,s)=>{s.d(e,{RC:()=>a,_W:()=>c,uY:()=>h});var n=s(864),r=s(6845),i=s(554),o=s(5424);function a(t){(0,r.useEffect)((()=>{const e=o.S.get().frame$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function c(t){(0,r.useEffect)((()=>{const e=o.S.get().reset$.subscribe((()=>{t()}));return()=>e.unsubscribe()}),[t])}function l(){return(0,i.j)(o.S.get())}const h=()=>{const t=function(){const[t,e]=(0,r.useState)(l());return(0,r.useEffect)((()=>{const t=o.S.get().$.subscribe((()=>{e(l())}));return()=>t.unsubscribe()}),[]),t}();return(0,n.jsx)("span",{style:{whiteSpace:"nowrap"},children:t})}},4913:(t,e,s)=>{s.d(e,{B:()=>a,q:()=>o});var n=s(7054),r=s(7880);function i(t,e){const s=[];for(let n=0;n<Math.min(t.length,e.length);n++){const r=t[n]??[],i=e[n]??[];for(let t=0;t<Math.max(r.length,i.length);t++){const e=r[t]??"",o=i[t]??"";null===e?.trim().match(/^\*+$/)&&o?.trim()!==e?.trim()&&s.push({row:n,col:t,expected:e,given:o})}}return s}function o(t,e){const s=r.lA.parse(t),o=r.lA.parse(e);if((0,n.dZ)(s)||(0,n.dZ)(o))return!1;return 0==i((0,n.Ok)(s),(0,n.Ok)(o)).length}function a(t,e){const s=r.lA.parse(t),o=r.lA.parse(e);if((0,n.dZ)(s)||(0,n.dZ)(o))return{text:"",failureNum:0,correctCellSpans:[],incorrectCellSpans:[]};const a=(0,n.Ok)(s),l=i(a,(0,n.Ok)(o)),h=new Array(a.length);for(const n of l){const t=h[n.row];t?t.push(n):h[n.row]=[n]}const u=e.split("\n"),d=new Array(a.length);for(let n=0;n<h.length;n++)h[n]&&(d[n]=c(u[n],h[n]));const p=[];let m=0;const g=[],f=[];for(let n=0;n<u.length;n++){const t=d[n];t?(p.push(t.expectedLine),g.push(...t.correctCellSpans.map((t=>({start:t.start+m,end:t.end+m,line:t.line})))),m+=t.expectedLine.length+1,p.push(t.givenLine),f.push(...t.correctCellSpans.map((t=>({start:t.start+m,end:t.end+m,line:t.line})))),m+=t.givenLine.length+1):(p.push(u[n]),m+=u[n].length+1)}return{text:p.join("\n"),failureNum:l.length,correctCellSpans:g,incorrectCellSpans:f}}function c(t,e){const s=t.split("|").filter((t=>""!=t)),n=s.map((t=>" ".repeat(t.length))),r=[];let i=0;for(let c=0;c<s.length;c++)r.push(i+1),i+=s[c].length+1;const o=[],a=[];for(const c of e){s[c.col]=c.expected,n[c.col]=c.given;const t={start:r[c.col],end:r[c.col]+c.expected.length,line:0};o.push(t),a.push(t)}return{expectedLine:`|${s.join("|")}|`,givenLine:`|${n.join("|")}|`,correctCellSpans:o,incorrectCellSpans:a}}},554:(t,e,s)=>{s.d(e,{j:()=>n});const n=t=>{if((t=>"function"===typeof t?.toString||"string"===typeof t)(t)){const e=t.toString();return"[object Object]"===e?JSON.stringify(t):e}return JSON.stringify(t)}},2369:(t,e,s)=>{s.d(e,{Ff:()=>v,Jx:()=>b,Z9:()=>w,Zu:()=>i,aL:()=>y});var n=s(137),r=s(2201);function i(){return{A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero}}const o=32768,a=36864,c=36864,l=36864,h=4032,u=32800,d=32784,p=32776,m=32769,g=32770,f=32772;function b(t){function e(e){return(t&e)===e}return{c:e(o),x1:e(a),x2:e(c),am:e(l),op:(t&h)>>6,d1:e(u),d2:e(d),d3:e(p),j1:e(m),j2:e(g),j3:e(f)}}function y(t,e){let{inM:s,instruction:r}=t,{A:i,D:o,PC:a}=e;const c=b(r),l=c.am?s:i,[h,u]=(0,n.Bb)(c.op,o,l);return[{A:i,D:o,PC:a+1,ALU:h,flag:u},c.d3]}function v(t,e){let{inM:s,instruction:r,reset:i}=t,{A:o,D:a,PC:c,ALU:l,flag:h}=e;const u=b(r),d=u.j1&&h===n.vU.Positive,p=u.j2&&h===n.vU.Zero,m=u.j3&&h===n.vU.Negative;c=i?0:d||p||m?o:c,u.d2&&(a=l);const g=o;u.c?u.d1&&(o=l):o=32767&r;const f=u.am?s:o,y=(0,n.Bb)(u.op,a,f);l=y[0],h=y[1];return[{addressM:u.d3?g:o,outM:l,writeM:u.d3},{A:o,D:a,ALU:l,flag:h,PC:c}]}class w{RAM;ROM;Screen;Keyboard;#t=0;#e=0;#s=0;#n={A:0,D:0,PC:0,ALU:0,flag:n.vU.Zero};get state(){return this.#n}get PC(){return this.#t}get A(){return this.#e}get D(){return this.#s}setA(t){this.#e=t}setD(t){this.#s=t}setPC(t){this.#t=t}constructor(t){let{RAM:e=new r.FH,ROM:s}=t;this.RAM=e,this.ROM=s,this.Screen=new r.kG(this.RAM,r.yJ,r.GD),this.Keyboard=new r.qT(this.RAM)}reset(){this.#t=0,this.#e=0,this.#s=0}tick(){const[{addressM:t,outM:e,writeM:s},{A:r,D:i,PC:o}]=function(t,e){const[s,n]=y(t,e);return v(t,s)}({inM:this.RAM.get(this.#e),instruction:this.ROM.get(this.#t),reset:!1},{A:this.#e,D:this.#s,PC:this.#t,ALU:this.#s,flag:n.vU.Zero});this.#e=r,this.#s=i,this.#t=o,s&&this.RAM.set(t,e)}}},7880:(t,e,s)=>{s.d(e,{lA:()=>c});var n=s(9814),r=s(3484);const i="\nCmp <: Base {\n  Root := line*\n  line = bar cell+ newline?\n  cell = cellvalue bar\n  cellvalue = (~(bar|newline) any)*\n}",o=n.Z.grammar(i,r.y1),a=o.extendSemantics(r.rJ);a.addAttribute("cell",{cell:(t,e)=>t.sourceString}),a.addAttribute("line",{line:(t,e,s)=>e.children.map((t=>t.cell))}),a.addAttribute("root",{Root:t=>t.children.map((t=>t.line))});const c={grammar:i,semantics:a,parser:o,parse:(0,r.Pz)(o,a)}},4430:(t,e,s)=>{s.d(e,{qH:()=>c});var n=s(9814),r=s(3484);const i='\nTst <: Base {\n  Root := Tst\n  Tst = (TstStatement | TstRepeat | TstWhile)+\n\n  TstRepeat = Repeat Number? OpenBrace TstStatement+ CloseBrace\n  TstWhile = While Condition OpenBrace TstStatement+ CloseBrace\n  TstStatement = List<TstOperation, ","> (Semi | Bang)\n\n  TstOperation =\n    | TstFileOperation\n    | TstOutputListOperation\n    | TstEvalOperation\n    | TstSetOperation\n    | TstOutputOperation\n    | TstEchoOperation\n    | TstClearEchoOperation\n    | TstLoadROMOperation\n\n  TstLoadROMOperation = ROM32K Load FileName\n  TstFileOperation = FileOperation FileName?\n  TstOutputListOperation = "output-list" OutputFormat+\n  OutputFormat = Name Index? FormatSpec?\n  FormatSpec = percent FormatStyle wholeDec dot wholeDec dot wholeDec\n  TstSetOperation = Set Name Index? Number\n  Index = OpenSquare wholeDec? CloseSquare\n  Condition = Value CompareOp Value\n  TstEvalOperation = Eval | TickTock | Tick | Tock | VmStep\n  TstOutputOperation = Output\n  TstEchoOperation = Echo String\n  TstClearEchoOperation = ClearEcho\n\n  FileName = Name\n  FileOperation = "load" | "output-file" | "compare-to"\n\n  Set = "set"\n  Eval = "eval"\n  Tick = "tick"\n  Tock = "tock"\n  TickTock = "ticktock"\n  VmStep = "vmstep"\n  Echo = "echo"\n  Repeat = "repeat"\n  ClearEcho = "clear-echo"\n  Output = "output"\n  OutputList = "output-list"\n  FormatStyle = "B"|"D"|"S"|"X"\n  ROM32K = "ROM32K"\n  Load = "load"\n  While = "while"\n\n  CompareOp = "<>" | "<=" | ">=" | "=" | "<" | ">"\n}',o=n.Z.grammar(i,r.y1),a=o.extendSemantics(r.rJ);a.extendAttribute("value",{Index:(t,e,s)=>e?.child(0)?.value??-1}),a.extendAttribute("name",{FileName(t){let{name:e}=t;return e}}),a.addAttribute("index",{Index:(t,e,s)=>e.child(0)?.value??0}),a.addAttribute("formatSpec",{FormatSpec(t,e,s,n,r,i,o){let{sourceString:a}=e,{value:c}=s,{value:l}=r,{value:h}=o;return{style:a,width:l,lpad:c,rpad:h}}}),a.addAttribute("format",{OutputFormat(t,e,s){let{name:n}=t;return{id:n,builtin:void 0!==e?.child(0),address:e?.child(0)?.value??-1,format:s?.child(0)?.formatSpec}}}),a.addAttribute("operation",{TstEvalOperation:t=>({op:t.sourceString}),TstOutputOperation:t=>({op:"output"}),TstOutputListOperation:(t,e)=>({op:"output-list",spec:e.children.map((t=>t.format))}),TstSetOperation(t,e,s,n){let{name:r}=e,{value:i}=n;const o={op:"set",id:r,value:i},a=s.child(0)?.child(1)?.child(0);return a&&(o.index=a.value),o},TstEchoOperation:(t,e)=>({op:"echo",message:e.String}),TstClearEchoOperation:t=>({op:"clear-echo"}),TstLoadROMOperation(t,e,s){let{name:n}=s;return{op:"loadRom",file:n}},TstFileOperation:(t,e)=>({op:t.sourceString,file:e?.sourceString})}),a.addAttribute("condition",{Condition(t,e,s){let{value:n}=t,{sourceString:r}=e,{value:i}=s;return{left:n,right:i,op:r}}}),a.addAttribute("statement",{TstWhile(t,e,s,n,i){return{statements:n.children.map((t=>{let{statement:e}=t;return e})),condition:e.condition,span:(0,r.yP)(this.source)}},TstRepeat(t,e,s,n,i){return{statements:n.children.map((t=>{let{statement:e}=t;return e})),count:e.sourceString?Number(e.sourceString):-1,span:(0,r.yP)(this.source)}},TstStatement(t,e){const s={ops:t.asIteration().children.map((t=>t.operation)),span:(0,r.yP)(this.source)};return"!"===e.sourceString&&(s.break=!0),s}}),a.addAttribute("tst",{Tst:t=>({lines:t.children.map((t=>t.statement))})}),a.addAttribute("root",{Root(t){let{tst:e}=t;return e}});const c={grammar:i,semantics:a,parser:o,parse:(0,r.Pz)(o,a)}},8637:(t,e,s)=>{s.d(e,{VM:()=>c});var n=s(9814),r=s(3484);const i='\nVm <: Base {\n  Root := Vm\n\n  Vm = VmInstruction*\n\n  VmInstruction =\n    | StackInstruction\n    | OpInstruction\n    | FunctionInstruction\n    | CallInstruction\n    | ReturnInstruction\n    | GotoInstruction\n    | LabelInstruction\n  \n  StackInstruction = (Push | Pop) MemorySegment Number\n  OpInstruction = Add | Sub | Neg | Lt | Gt | Eq | And | Or | Not\n  FunctionInstruction = Function Name Number \n  CallInstruction =  Call Name Number\n  ReturnInstruction = Return\n  LabelInstruction = Label Name\n  GotoInstruction = (Goto | IfGoto) Name\n\n  MemorySegment = Argument | Local | Static | Constant | This | That | Pointer | Temp\n\n  Push = "push"\n  Pop = "pop"\n  Function = "function"\n  Call = "call"\n  Return = "return"\n  Goto = "goto"\n  IfGoto = "if-goto"\n  Label = "label"\n\n  Argument = "argument"\n  Local = "local"\n  Static = "static"\n  Constant = "constant"\n  This = "this"\n  That = "that"\n  Pointer = "pointer"\n  Temp = "temp"\n\n  Add = "add" \n  Sub = "sub" \n  Neg = "neg" \n  Eq = "eq"\n  Lt = "lt" \n  Gt = "gt" \n  And = "and" \n  Or = "or" \n  Not = "not"\n}',o=n.Z.grammar(i,r.y1),a=o.extendSemantics(r.rJ);a.addAttribute("op",{Push:t=>"push",Pop:t=>"pop",Function:t=>"function",Call:t=>"call",Return:t=>"return",Goto:t=>"goto",IfGoto:t=>"if-goto",Label:t=>"label",Add:t=>"add",Sub:t=>"sub",Neg:t=>"neg",Eq:t=>"eq",Lt:t=>"lt",Gt:t=>"gt",And:t=>"and",Or:t=>"or",Not:t=>"not"}),a.addAttribute("segment",{Argument:t=>"argument",Local:t=>"local",Static:t=>"static",Constant:t=>"constant",This:t=>"this",That:t=>"that",Pointer:t=>"pointer",Temp:t=>"temp"}),a.addAttribute("instruction",{StackInstruction(t,e,s){let{op:n}=t,{segment:r}=e;return{op:n,segment:r,offset:Number(s.sourceString)}},OpInstruction(t){let{op:e}=t;return{op:e}},FunctionInstruction(t,e,s){let{name:n}=e;return{op:"function",name:n,nVars:Number(s.sourceString)}},CallInstruction(t,e,s){let{name:n}=e;return{op:"call",name:n,nArgs:Number(s.sourceString)}},ReturnInstruction:t=>({op:"return"}),LabelInstruction(t,e){let{name:s}=e;return{op:"label",label:s}},GotoInstruction(t,e){let{op:s}=t,{name:n}=e;return{op:s,label:n}}}),a.addAttribute("vm",{Vm:t=>({instructions:t.children.map((t=>t.instruction))})}),a.addAttribute("root",{Root(t){let{vm:e}=t;return e}});const c={grammar:i,semantics:a,parser:o,parse:(0,r.Pz)(o,a)}},6401:(t,e,s)=>{s.d(e,{h:()=>S});var n=s(7239),r=s(2836);class i{variable;value;index;constructor(t,e,s){this.variable=t,this.value=e,this.index=s}do(t){t.setVar(this.variable,this.value,this.index)}*steps(){yield this}}class o{do(t){t.output()}*steps(){yield this}}class a{outputs=[];constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(const e of t)this.addOutput(e)}addOutput(t){this.outputs.push({id:t.id,style:t.format?.style??"B",len:t.format?.width??-1,lpad:t.format?.lpad??1,rpad:t.format?.rpad??1,builtin:t.builtin,address:t.address})}do(t){t.outputList(this.outputs),t.header()}*steps(){yield this}}class c{instructions=[];span;addInstruction(t){this.instructions.push(t)}do(t){for(const e of this.instructions)e.do(t)}*steps(t){yield this}}class l extends c{repeat;constructor(t){super(),this.repeat=t}do(){}*innerSteps(t){for(const e of this.instructions)yield*e.steps(t)}*steps(t){if(-1===this.repeat)for(yield this;;)yield*this.innerSteps(t);else for(let e=0;e<this.repeat;e++)yield this,yield*this.innerSteps(t)}}class h{x;y;op;constructor(t,e,s){this.x=t,this.y=e,this.op=s}check(t){const e=t.hasVar(this.x)?t.getVar(this.x):this.x,s=t.hasVar(this.y)?t.getVar(this.y):this.y;if("string"===typeof e||"string"===typeof s)switch(this.op){case"=":return`${e}`===`${s}`;case"<>":return`${e}`!==`${s}`}else switch(this.op){case"<":return e<s;case"<=":return e<=s;case">":return e>s;case">=":return e>=s;case"=":return e===s;case"<>":return e!==s}return!1}}class u extends c{condition;constructor(t){super(),this.condition=t}*steps(t){for(;this.condition.check(t);){yield this;for(const e of this.instructions)yield*e.steps(t)}}}class d{content;constructor(t){this.content=t}do(t){t.echo(this.content)}*steps(){yield this}}class p{do(t){t.clearEcho()}*steps(){yield this}}class m{file;constructor(t){this.file=t}async do(t){t.fs.pushd("/samples"),await t.load(this.file),t.fs.popd()}*steps(){yield this}}var g=s(4388),f=s(1003);function b(t){return void 0!==t.ops}function y(t){return void 0!==t.condition}function v(t){const e=new c;e.span=t.span;for(const s of t.ops){const t=w(s);void 0!==t&&e.addInstruction(t)}return e}function w(t){const{op:e}=t;switch(e){case"tick":return new r.oK;case"tock":return new r.mL;case"ticktock":return new f.r;case"eval":return new r.Mb;case"vmstep":return new g.R;case"output":return new o;case"set":return new i(t.id,t.value,t.index);case"output-list":return new a(t.spec);case"echo":return new d(t.message);case"clear-echo":return new p;case"loadRom":return new m(t.file);case"load":case"output-file":case"compare-to":return;default:(0,n.qV)(e,`Unknown tst operation ${e}`)}}function S(t,e){for(const s of e.lines)if(b(s))t.addInstruction(v(s));else{const e=y(s)?new u(new h(s.condition.left,s.condition.right,s.condition.op)):new l(s.count);e.span=s.span,t.addInstruction(e);for(const t of s.statements)e.addInstruction(v(t))}return t.reset(),t}},2836:(t,e,s)=>{s.d(e,{Mb:()=>c,l1:()=>a,mL:()=>h,oK:()=>l});var n=s(5524),r=s(5424),i=s(6401),o=s(8186);class a extends o.e{chip=new n.P9;get chipId(){return this.chip.id}clock=r.S.get();static from(t){const e=new a;return(0,i.h)(e,t)}with(t){return this.chip=t,this}hasVar(t){return"time"===t||(t=`${t}`,this.chip.hasIn(t)||this.chip.hasOut(t))}getVar(t,e){if("time"===(t=`${t}`))return this.clock.toString();const s=this.chip.get(t,e);return s?s instanceof n.Gc?s.busVoltage:s.voltage():0}getWidth(t,e){const s=this.chip.get(t,e);return s?s.width:0}setVar(t,e,s){const r=this.chip.get(t,s);r instanceof n.Gc?r.busVoltage=e:r?.pull(0===e?n.yE:n.lj)}eval(){this.chip.eval()}tick(){this.chip.eval(),this.clock.tick()}tock(){this.chip.eval(),this.clock.tock()}async load(t){await this.chip.load(this.fs,t)}async run(){this.clock.reset(),await super.run()}}class c{_chipTestInstruction_=!0;do(t){t.eval()}*steps(){yield this}}class l{_chipTestInstruction_=!0;do(t){t.tick()}*steps(){yield this}}class h{_chipTestInstruction_=!0;do(t){t.tock()}*steps(){yield this}}},1003:(t,e,s)=>{s.d(e,{o:()=>a,r:()=>c});var n=s(2201),r=s(2369),i=s(8186),o=s(6401);class a extends i.e{cpu;ticks=0;static from(t,e){const s=new a(e);return(0,o.h)(s,t)}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new n.eD(new Int16Array);super(),this.cpu=new r.Z9({ROM:t}),this.reset()}reset(){return super.reset(),this.cpu.reset(),this.ticks=0,this}hasVar(t){return"number"!==typeof t&&!("A"!==t&&"D"!==t&&"PC"!==t&&"time"!==t&&!t.startsWith("RAM"))}getVar(t,e){switch(t){case"A":return this.cpu.A;case"D":return this.cpu.D;case"PC":return this.cpu.PC;case"time":return this.ticks;case"RAM":return void 0===e?0:this.cpu.RAM.get(e)}if("number"===typeof t)return 0;if(t.startsWith("RAM")){const e=Number(t.substring(4,t.length-1));return this.cpu.RAM.get(e)}return 0}getWidth(t,e){return 16}setVar(t,e,s){switch(t){case"A":this.cpu.setA(e);break;case"D":this.cpu.setD(e);break;case"PC":this.cpu.setPC(e);break;case"RAM":this.cpu.RAM.set(s??0,e)}}ticktock(){this.ticks+=1,this.cpu.tick()}async load(t){await this.cpu.ROM.load(this.fs,t)}}class c{_cpuTestInstruction_=!0;do(t){t.ticktock()}*steps(){yield this}}},8186:(t,e,s)=>{s.d(e,{e:()=>a});var n=s(7239),r=s(2608),i=s(5150);class o{variable;fmt;lPad;rPad;len;index;builtin;constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"%B1.1.1",s=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0;if(this.variable=t,e.startsWith("%")&&void 0===s&&void 0===r&&void 0===i){const{fmt:t,lPad:s,rPad:n,len:r}=e.match(/^%(?<fmt>[BDXS])(?<lPad>\d+)\.(?<len>\d+)\.(?<rPad>\d+)$/)?.groups;this.fmt=t,this.lPad=parseInt(s),this.rPad=parseInt(n),this.len=parseInt(r),this.builtin=!1,this.index=-1}else(0,n.hu)(["B","X","D","S"].includes(e[0])),this.fmt=e[0],this.len=s??3,this.lPad=r??1,this.rPad=i??1,this.builtin=o??!1,this.index=a??-1}header(t){let e=`${this.variable}`;if(this.builtin){e=`${e}[${this.index>=0?this.index:""}]`}return e.length>this.len+this.lPad+this.rPad?e.substring(0,this.len+this.lPad+this.rPad):this.padCenter(e)}print(t){const e=t.getVar(this.variable,this.index);if("S"===this.fmt)return this.padLeft(e);const s=(0,{B:i.Ly,D:i.E_,X:i.$v}[this.fmt])(e);return"D"===this.fmt?this.padRight(s):this.padCenter(s.slice(s.length-this.len))}padCenter(t){const e=this.lPad+this.len+this.rPad,s=Math.floor((e-t.length)/2),n=e-s-t.length,r=s+t.length,i=r+n;return t=(t=t.padStart(r)).padEnd(i)}padLeft(t){t=t.substring(0,this.len);const e=this.rPad+this.len,s=this.lPad+e;return t=(t=t.padEnd(e)).padStart(s)}padRight(t){t=t.substring(0,this.len);const e=this.lPad+this.len,s=this.rPad+e;return t=(t=t.padStart(e)).padEnd(s)}}class a{instructions=[];_outputList=[];_log="";fs=new r.Wd;setFileSystem(t){return this.fs=t,this}echo(t){}clearEcho(){}async load(t){}async compareTo(t){}outputFile(t){}createOutputs(t){return t.map((t=>{if(-1===t.len)if("time"===t.id)t.len=7,t.style="S";else{const e=this.getWidth(t.id,t.address);"B"===t.style?t.len=e:"D"===t.style?t.len=Math.ceil(Math.log(e)):"X"===t.style&&(t.len=Math.ceil(e/4))}return new o(t.id,t.style,t.len,t.lpad,t.rpad,t.builtin,t.address)}))}outputList(t){this._outputList=this.createOutputs(t)}addInstruction(t){this.instructions.push(t)}reset(){return this._steps=function*(t){for(const e of t.instructions)yield*e.steps(t)}(this),this._step=this._steps.next(),this._log="",this}_steps;_step;get steps(){return void 0===this._steps&&(this.reset(),this._steps=(0,n.kP)(this._steps,"Reset did not initialize steps"),this._step=(0,n.kP)(this._step,"Reset did not find first step")),this._steps}get currentStep(){return this._step?.value}get done(){return this._step?.done??!1}step(){return!!this._step.done||(this._step.value.do(this),this._step=this.steps.next(),!1)}async run(){for(this.reset();!await this.step(););}breakpoints=new Map;addBreakpoint(t,e){this.breakpoints.set(t,e)}clearBreakpoints(){this.breakpoints.clear()}output(){const t=this._outputList.map((t=>t.print(this)));this._log+=`|${t.join("|")}|\n`}header(){const t=this._outputList.map((t=>t.header(this)));this._log+=`|${t.join("|")}|\n`}log(){return this._log}}},4388:(t,e,s)=>{s.d(e,{R:()=>h,w:()=>l});var n=s(7054),r=s(2201),i=s(8637),o=s(5920),a=s(6401),c=s(8186);class l extends c.e{vm=new o.Vm;static from(t){const e=new l;return(0,a.h)(e,t)}using(t){return this.fs=t,this}with(t){return this.vm=t,this}hasVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e&&e>0&&e<r.FH.SIZE||["argument","local","static","constant","this","that","pointer","temp"].includes(t.toLowerCase())}getVar(t,e){return"string"!==typeof t&&(e=t,t="RAM"),"RAM"===t&&void 0!==e?this.vm.RAM.get(e):this.vm.memory.getSegment(t,e??0)}getWidth(t,e){return 16}setVar(t,e,s){if("string"!==typeof t&&(s=t,t="RAM"),"RAM"!==t||void 0===s)if(void 0!==s)this.vm.memory.setSegment(t,s,e);else switch(t.toLowerCase()){case"sp":this.vm.memory.SP=e;break;case"arg":case"argument":this.vm.memory.ARG=e;break;case"lcl":case"local":this.vm.memory.LCL=e;break;case"this":this.vm.memory.THIS=e;break;case"that":this.vm.memory.THAT=e}else this.vm.RAM.set(s,e)}vmstep(){this.vm.step()}async load(t){if(t){const e=await this.fs.readFile(t),{instructions:s}=(0,n.Wg)(i.VM.parse(e));(0,n.Wg)(this.vm.load(s,!0))}else for(const e of await this.fs.scandir("."))e.isFile()&&e.name.endsWith(".vm")&&await this.load(e.name);(0,n.Wg)(this.vm.bootstrap())}}class h{_vmTestInstruction_=!0;do(t){t.vmstep()}*steps(){yield this}}},5920:(t,e,s)=>{s.d(e,{Vm:()=>A});var n=s(7054);function r(t){return t-48}function i(t){return t.toString().split("").map((t=>Number(t)+48))}class o{memory;os;constructor(t,e){this.memory=t,this.os=e}new(t){t<=0&&this.os.sys.error(14);const e=this.os.memory.alloc(t+2);return this.os.sys.halted?0:(this.memory.set(e,t),this.memory.set(e+1,0),e)}dispose(t){this.os.memory.deAlloc(t)}maxLength(t){return this.memory.get(t)}length(t){return this.memory.get(t+1)}setLength(t,e){this.memory.set(t+1,e)}charAt(t,e){return e<0||e>=this.length(t)?(this.os.sys.error(15),0):this.memory.get(t+e+2)}setCharAt(t,e,s){e<0||e>=this.length(t)?this.os.sys.error(16):this.memory.set(t+e+2,s)}appendChar(t,e){const s=this.length(t);return s==this.maxLength(t)?(this.os.sys.error(17),0):(this.setLength(t,s+1),this.setCharAt(t,s,e),t)}eraseLastChar(t){const e=this.length(t);0!=e?this.setLength(t,e-1):this.os.sys.error(18)}intValue(t){const e=[];for(let n=0;n<this.length(t)&&((s=this.charAt(t,n))>=48&&s<=57);n++)e.push(r(this.charAt(t,n)));var s;return e.reduce(((t,e)=>10*t+e),0)}setInt(t,e){const s=i(e);if(s.length>this.maxLength(t))this.os.sys.error(19);else{this.setLength(t,0);for(const e of s)this.appendChar(t,e)}}}function a(t,e){const s=[];for(let n=0;n<e;n++)s.push(t.get(t.SP-e+n));return s}const c={"Math.multiply":{func:(t,e)=>{const[s,n]=a(t,2);return s*n&65535},nArgs:2},"Math.divide":{func:(t,e)=>{const[s,n]=a(t,2);return 0==n?(e.sys.error(3),0):65535&Math.floor(s/n)},nArgs:2},"Math.min":{func:(t,e)=>{const[s,n]=a(t,2);return 65535&Math.min(s,n)},nArgs:2},"Math.max":{func:(t,e)=>{const[s,n]=a(t,2);return 65535&Math.max(s,n)},nArgs:2},"Math.sqrt":{func:(t,e)=>{const[s]=a(t,1);return s<0?(e.sys.error(4),0):65535&Math.floor(Math.sqrt(s))},nArgs:1},"Math.abs":{func:(t,e)=>{const[s]=a(t,1);return 65535&Math.abs(s)},nArgs:1},"Screen.clearScreen":{func:(t,e)=>(e.screen.clear(),0),nArgs:0},"Screen.setColor":{func:(t,e)=>{const[s]=a(t,1);return e.screen.color=0!==s,0},nArgs:1},"Screen.drawPixel":{func:(t,e)=>{const[s,n]=a(t,2);return e.screen.drawPixel(s,n),0},nArgs:2},"Screen.drawLine":{func:(t,e)=>{const[s,n,r,i]=a(t,4);return e.screen.drawLine(s,n,r,i),0},nArgs:4},"Screen.drawRectangle":{func:(t,e)=>{const[s,n,r,i]=a(t,4);return e.screen.drawRect(s,n,r,i),0},nArgs:4},"Screen.drawCircle":{func:(t,e)=>{const[s,n,r]=a(t,3);return e.screen.drawCircle(s,n,r),0},nArgs:3},"Memory.peek":{func:(t,e)=>{const[s]=a(t,1);return t.get(s)},nArgs:1},"Memory.poke":{func:(t,e)=>{const[s,n]=a(t,2);return t.set(s,n),0},nArgs:1},"Memory.alloc":{func:(t,e)=>{const[s]=a(t,1);return e.memory.alloc(s)},nArgs:1},"Memory.deAlloc":{func:(t,e)=>{const[s]=a(t,1);return e.memory.deAlloc(s),0},nArgs:1},"Array.new":{func:(t,e)=>{const[s]=a(t,1);return s<=0?(e.sys.error(2),0):e.memory.alloc(s)},nArgs:1},"Array.dispose":{func:(t,e)=>{const[s]=a(t,1);return e.memory.deAlloc(s),0},nArgs:1},"String.new":{func:(t,e)=>{const[s]=a(t,1);return e.string.new(s)},nArgs:1},"String.dispose":{func:(t,e)=>{const[s]=a(t,1);return e.string.dispose(s),0},nArgs:1},"String.length":{func:(t,e)=>{const[s]=a(t,1);return e.string.length(s)},nArgs:1},"String.charAt":{func:(t,e)=>{const[s,n]=a(t,2);return e.string.charAt(s,n)},nArgs:2},"String.setCharAt":{func:(t,e)=>{const[s,n,r]=a(t,3);return e.string.setCharAt(s,n,r),0},nArgs:3},"String.appendChar":{func:(t,e)=>{const[s,n]=a(t,2);return e.string.appendChar(s,n)},nArgs:2},"String.eraseLastChar":{func:(t,e)=>{const[s]=a(t,1);return e.string.eraseLastChar(s),0},nArgs:1},"String.intValue":{func:(t,e)=>{const[s]=a(t,1);return e.string.intValue(s)},nArgs:1},"String.setInt":{func:(t,e)=>{const[s,n]=a(t,2);return e.string.setInt(s,n),0},nArgs:2},"String.backSpace":{func:(t,e)=>129,nArgs:0},"String.doubleQuote":{func:(t,e)=>34,nArgs:0},"String.newLine":{func:(t,e)=>128,nArgs:0},"Output.moveCursor":{func:(t,e)=>{const[s,n]=a(t,2);return e.output.moveCursor(s,n),0},nArgs:2},"Output.printChar":{func:(t,e)=>{const[s]=a(t,1);return e.output.printChar(s),0},nArgs:1},"Output.printString":{func:(t,e)=>{const[s]=a(t,1);return e.output.printString(s),0},nArgs:1},"Output.printInt":{func:(t,e)=>{const[s]=a(t,1);return e.output.printInt(s),0},nArgs:1},"Output.println":{func:(t,e)=>(e.output.println(),0),nArgs:0},"Output.backSpace":{func:(t,e)=>(e.output.backspace(),0),nArgs:0},"Keyboard.keyPressed":{func:(t,e)=>e.keyboard.keyPressed(),nArgs:0},"Keyboard.readChar":{func:(t,e)=>(e.keyboard.readChar(),0),nArgs:0},"Keyboard.readLine":{func:(t,e)=>{const[s]=a(t,1);return e.keyboard.readLine(s),0},nArgs:1},"Keyboard.readInt":{func:(t,e)=>{const[s]=a(t,1);return e.keyboard.readInt(s),0},nArgs:1},"Sys.halt":{func:(t,e)=>(e.sys.halt(),0),nArgs:0},"Sys.error":{func:(t,e)=>{const[s]=a(t,1);return e.sys.error(s),0},nArgs:1},"Sys.wait":{func:(t,e)=>{const[s]=a(t,1);return e.sys.wait(s),0},nArgs:1}};var l=s(2201);class h extends l.FH{strict=!0;get SP(){return this.get(0)}set SP(t){this.set(0,t)}get LCL(){return this.get(1)}set LCL(t){this.set(1,t)}get ARG(){return this.get(2)}set ARG(t){this.set(2,t)}get THIS(){return this.get(3)}set THIS(t){this.set(3,t)}get THAT(){return this.get(4)}set THAT(t){this.set(4,t)}get statics(){const t=[];for(let e=16;e<256;e++)t.push(this.get(e));return t}constructor(){super(),this.set(0,256)}baseSegment(t,e){if(this.strict&&(e<0||e>32767))return(0,n.UG)(new Error(`Illegal offset value ${e} (must be between 0 and 32767)`));switch(t){case"argument":return(0,n.Ok)(this.ARG+e);case"constant":return(0,n.Ok)(e);case"local":return(0,n.Ok)(this.LCL+e);case"pointer":if(this.strict&&e>1)throw new Error(`pointer out of bounds access (pointer can be 0 for this, 1 for that, but got ${e}`);return(0,n.Ok)(0===e?3:4);case"static":return this.strict&&e>239?(0,n.UG)(new Error(`Cannot access statics beyond 239: ${e}`)):(0,n.Ok)(16+e);case"temp":return this.strict&&e>7?(0,n.UG)(new Error(`Temp out of bounds access (temp can be 0 to 7, but got ${e}`)):(0,n.Ok)(5+e);case"that":return(0,n.Ok)(this.THAT+e);case"this":return(0,n.Ok)(this.THIS+e)}}getSegment(t,e){if("constant"===t){if(this.strict&&(e<0||e>32767))throw new Error(`Illegal offset value ${e} (must be between 0 and 32767)`);return e}const s=this.baseSegment(t,e);if((0,n.dZ)(s))throw(0,n.UG)(s);return this.get((0,n.Ok)(s))}setSegment(t,e,s){const r=this.baseSegment(t,e);if((0,n.dZ)(r))throw(0,n.UG)(r);this.set((0,n.Ok)(r),s)}argument(t){return this.getSegment("argument",t)}local(t){return this.getSegment("local",t)}static(t){return this.getSegment("static",t)}constant(t){return this.getSegment("constant",t)}this(t){return this.getSegment("this",t)}that(t){return this.getSegment("that",t)}pointer(t){return this.getSegment("pointer",t)}temp(t){return this.getSegment("temp",t)}push(t){const e=this.SP;this.set(e,t),this.set(0,e+1)}pop(){if(this.strict&&256===this.SP)throw new Error("Cannot pop the stack below 256 in strict mode");this.set(0,this.SP-1);return this.get(this.SP)}pushFrame(t,e,s){const n=this.SP,r=n-e;this.set(n,t),this.set(n+1,this.LCL),this.set(n+2,this.ARG),this.set(n+3,this.THIS),this.set(n+4,this.THAT),this.set(2,r),this.set(1,n+5);const i=n+5;for(let o=0;o<s;o++)this.set(i+o,0);return this.set(0,i+s),n}popFrame(){const t=this.LCL,e=this.get(t-5),s=this.pop();return this.set(this.ARG,s),this.set(0,this.ARG+1),this.set(4,this.get(t-1)),this.set(3,this.get(t-2)),this.set(2,this.get(t-3)),this.set(1,this.get(t-4)),e}getFrame(t,e,s,n,r,i){const o=t-e,a=t+5,c=a+s,l=i-c;return{args:{base:o,count:e,values:[...this.map(((t,e)=>e),o,o+e)]},locals:{base:a,count:s,values:[...this.map(((t,e)=>e),a,a+s)]},stack:{base:c,count:l,values:[...this.map(((t,e)=>e),c,c+l)]},this:{base:c,count:n,values:[...this.map(((t,e)=>e),this.THIS,this.THIS+n)]},that:{base:c,count:r,values:[...this.map(((t,e)=>e),this.THIS,this.THIS+r)]},frame:{RET:this.get(t),LCL:this.LCL,ARG:this.ARG,THIS:this.THIS,THAT:this.THAT}}}getVmState(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:240;const e=[...this.map(((t,e)=>e),5,13)],s=[...this.map(((t,e)=>e),13,16)],n=[...this.map(((t,e)=>e),16,16+t)];return{"0: SP":this.SP,"1: LCL":this.LCL,"2: ARG":this.ARG,"3: THIS":this.THIS,"4: THAT":this.THAT,temps:e,internal:s,static:n}}binOp(t){const e=65535&t(this.get(this.SP-2),this.get(this.SP-1));this.set(this.SP-2,e),this.set(0,this.SP-1)}unOp(t){const e=65535&t(this.get(this.SP-1));this.set(this.SP-1,e)}comp(t){this.binOp(((e,s)=>t(e,s)?-1:0))}}class u{memory;os;interval;constructor(t,e){this.memory=t,this.os=e}keyPressed(){return this.memory.get(l.eu)}readCharLoop(t){let e=!1,s=0;this.interval=setInterval((()=>{e||0==this.keyPressed()||(e=!0,s=this.keyPressed()),e&&0==this.keyPressed()&&(clearInterval(this.interval),t(s))}),1)}readChar(){this.os.sys.block(),this.os.output.drawCursor(),new Promise((t=>{this.readCharLoop(t)})).then((t=>{this.os.output.printChar(t),this.os.sys.release(t)}))}readLineLoop(t){const e=this.os.string.new(100);this.os.sys.halted&&t(0);let s=!1,n=0;this.interval=setInterval((()=>{s||0==this.keyPressed()||(s=!0,n=this.keyPressed()),s&&0==this.keyPressed()&&(s=!1,129==n?(this.os.string.length(e)>0&&this.os.output.backspace(),this.os.string.eraseLastChar(e)):128==n?(clearInterval(this.interval),t(e)):(this.os.string.appendChar(e,n),this.os.sys.halted&&t(0),this.os.output.printChar(n),this.os.output.drawCursor()))}),1)}readLine(t){this.os.sys.block(),this.os.output.printString(t),this.os.output.drawCursor(),new Promise((t=>{this.readLineLoop(t)})).then((t=>{this.os.sys.halted||(this.os.output.clearChar(),this.os.output.println()),this.os.sys.release(t)}))}readInt(t){this.os.sys.block(),this.os.output.printString(t),this.os.output.drawCursor(),new Promise((t=>{this.readLineLoop(t)})).then((t=>{this.os.sys.halted||(this.os.output.clearChar(),this.os.output.println()),this.os.sys.release(this.os.string.intValue(t))}))}dispose(){this.interval&&clearInterval(this.interval)}}class d{memory;os;freeSegments=[{address:2048,length:14336}];constructor(t,e){this.memory=t,this.os=e}alloc(t){if(t<=0)return this.os.sys.error(5),0;for(let e=0;e<this.freeSegments.length;e++){const s=this.freeSegments[e];if(s.length>=t){const n=s.address;return s.address+=t+1,s.length-=t+1,0===s.length&&this.freeSegments.splice(e,1),this.memory.set(n,t),n+1}}return this.os.sys.error(6),0}deAlloc(t){const e=this.memory.get(t-1);this.freeSegments.push({address:t-1,length:e+1})}}var p=s(5150);const m=function(){const t=new Array(126);return t[32]=g([0,0,0,0,0,0,0,0,0,0,0]),t[33]=g([12,30,30,30,12,12,0,12,12,0,0]),t[34]=g([54,54,20,0,0,0,0,0,0,0,0]),t[35]=g([0,18,18,63,18,18,63,18,18,0,0]),t[36]=g([12,30,51,3,30,48,51,30,12,12,0]),t[37]=g([0,0,35,51,24,12,6,51,49,0,0]),t[38]=g([12,30,30,12,54,27,27,27,54,0,0]),t[39]=g([12,12,6,0,0,0,0,0,0,0,0]),t[40]=g([24,12,6,6,6,6,6,12,24,0,0]),t[41]=g([6,12,24,24,24,24,24,12,6,0,0]),t[42]=g([0,0,0,51,30,63,30,51,0,0,0]),t[43]=g([0,0,0,12,12,63,12,12,0,0,0]),t[44]=g([0,0,0,0,0,0,0,12,12,6,0]),t[45]=g([0,0,0,0,0,63,0,0,0,0,0]),t[46]=g([0,0,0,0,0,0,0,12,12,0,0]),t[47]=g([0,0,32,48,24,12,6,3,1,0,0]),t[48]=g([12,30,51,51,51,51,51,30,12,0,0]),t[49]=g([12,14,15,12,12,12,12,12,63,0,0]),t[50]=g([30,51,48,24,12,6,3,51,63,0,0]),t[51]=g([30,51,48,48,28,48,48,51,30,0,0]),t[52]=g([16,24,28,26,25,63,24,24,60,0,0]),t[53]=g([63,3,3,31,48,48,48,51,30,0,0]),t[54]=g([28,6,3,3,31,51,51,51,30,0,0]),t[55]=g([63,49,48,48,24,12,12,12,12,0,0]),t[56]=g([30,51,51,51,30,51,51,51,30,0,0]),t[57]=g([30,51,51,51,62,48,48,24,14,0,0]),t[58]=g([0,0,12,12,0,0,12,12,0,0,0]),t[59]=g([0,0,12,12,0,0,12,12,6,0,0]),t[60]=g([0,0,24,12,6,3,6,12,24,0,0]),t[61]=g([0,0,0,63,0,0,63,0,0,0,0]),t[62]=g([0,0,3,6,12,24,12,6,3,0,0]),t[64]=g([30,51,51,59,59,59,27,3,30,0,0]),t[63]=g([30,51,51,24,12,12,0,12,12,0,0]),t[65]=g([12,30,51,51,63,51,51,51,51,0,0]),t[66]=g([31,51,51,51,31,51,51,51,31,0,0]),t[67]=g([28,54,35,3,3,3,35,54,28,0,0]),t[68]=g([15,27,51,51,51,51,51,27,15,0,0]),t[69]=g([63,51,35,11,15,11,35,51,63,0,0]),t[70]=g([63,51,35,11,15,11,3,3,3,0,0]),t[71]=g([28,54,35,3,59,51,51,54,44,0,0]),t[72]=g([51,51,51,51,63,51,51,51,51,0,0]),t[73]=g([30,12,12,12,12,12,12,12,30,0,0]),t[74]=g([60,24,24,24,24,24,27,27,14,0,0]),t[75]=g([51,51,51,27,15,27,51,51,51,0,0]),t[76]=g([3,3,3,3,3,3,35,51,63,0,0]),t[77]=g([33,51,63,63,51,51,51,51,51,0,0]),t[78]=g([51,51,55,55,63,59,59,51,51,0,0]),t[79]=g([30,51,51,51,51,51,51,51,30,0,0]),t[80]=g([31,51,51,51,31,3,3,3,3,0,0]),t[81]=g([30,51,51,51,51,51,63,59,30,48,0]),t[82]=g([31,51,51,51,31,27,51,51,51,0,0]),t[83]=g([30,51,51,6,28,48,51,51,30,0,0]),t[84]=g([63,63,45,12,12,12,12,12,30,0,0]),t[85]=g([51,51,51,51,51,51,51,51,30,0,0]),t[86]=g([51,51,51,51,51,30,30,12,12,0,0]),t[87]=g([51,51,51,51,51,63,63,63,18,0,0]),t[88]=g([51,51,30,30,12,30,30,51,51,0,0]),t[89]=g([51,51,51,51,30,12,12,12,30,0,0]),t[90]=g([63,51,49,24,12,6,35,51,63,0,0]),t[91]=g([30,6,6,6,6,6,6,6,30,0,0]),t[92]=g([0,0,1,3,6,12,24,48,32,0,0]),t[93]=g([30,24,24,24,24,24,24,24,30,0,0]),t[94]=g([8,28,54,0,0,0,0,0,0,0,0]),t[95]=g([0,0,0,0,0,0,0,0,0,63,0]),t[96]=g([6,12,24,0,0,0,0,0,0,0,0]),t[97]=g([0,0,0,14,24,30,27,27,54,0,0]),t[98]=g([3,3,3,15,27,51,51,51,30,0,0]),t[99]=g([0,0,0,30,51,3,3,51,30,0,0]),t[100]=g([48,48,48,60,54,51,51,51,30,0,0]),t[101]=g([0,0,0,30,51,63,3,51,30,0,0]),t[102]=g([28,54,38,6,15,6,6,6,15,0,0]),t[103]=g([0,0,30,51,51,51,62,48,51,30,0]),t[104]=g([3,3,3,27,55,51,51,51,51,0,0]),t[105]=g([12,12,0,14,12,12,12,12,30,0,0]),t[106]=g([48,48,0,56,48,48,48,48,51,30,0]),t[107]=g([3,3,3,51,27,15,15,27,51,0,0]),t[108]=g([14,12,12,12,12,12,12,12,30,0,0]),t[109]=g([0,0,0,29,63,43,43,43,43,0,0]),t[110]=g([0,0,0,29,51,51,51,51,51,0,0]),t[111]=g([0,0,0,30,51,51,51,51,30,0,0]),t[112]=g([0,0,0,30,51,51,51,31,3,3,0]),t[113]=g([0,0,0,30,51,51,51,62,48,48,0]),t[114]=g([0,0,0,29,55,51,3,3,7,0,0]),t[115]=g([0,0,0,30,51,6,24,51,30,0,0]),t[116]=g([4,6,6,15,6,6,6,54,28,0,0]),t[117]=g([0,0,0,27,27,27,27,27,54,0,0]),t[118]=g([0,0,0,51,51,51,51,30,12,0,0]),t[119]=g([0,0,0,51,51,51,63,63,18,0,0]),t[120]=g([0,0,0,51,30,12,12,30,51,0,0]),t[121]=g([0,0,0,51,51,51,62,48,24,15,0]),t[122]=g([0,0,0,63,27,12,6,51,63,0,0]),t[123]=g([56,12,12,12,7,12,12,12,56,0,0]),t[124]=g([12,12,12,12,12,12,12,12,12,0,0]),t[125]=g([7,12,12,12,56,12,12,12,7,0,0]),t[126]=g([38,45,25,0,0,0,0,0,0,0,0]),t}();function g(t){return t.map((t=>Array.from((0,p.Ly)(t,8)).reverse().map((t=>"1"==t))))}class f{os;col=0;row=0;lastColor=!1;constructor(t){this.os=t}setColor(t){this.lastColor=this.os.screen.color,this.os.screen.color=t}restoreColor(){this.os.screen.color=this.lastColor}clearChar(){this.setColor(!1),this.os.screen.drawRect(8*this.col,11*this.row,8*(this.col+1),11*(this.row+1)),this.restoreColor()}moveCursor(t,e){t<0||t>22||e<0||e>64?this.os.sys.error(20):(this.row=t,this.col=e,this.drawCursor())}println(){this.row+=1,this.col=0}drawCursor(){this.clearChar(),this.setColor(!0),this.os.screen.drawRect(8*this.col+2,11*this.row+2,8*(this.col+1)-2,11*(this.row+1)-2),this.restoreColor()}printChar(t){const e=m[t];if(e){this.clearChar(),this.setColor(!0);for(let t=0;t<e.length;t++)for(let s=0;s<e[t].length;s++)e[t][s]&&this.os.screen.drawPixel(8*this.col+s,11*this.row+t);this.restoreColor()}this.col+=1,64==this.col&&(this.println(),22==this.row&&(this.row=0))}printString(t){for(let e=0;e<this.os.string.length(t);e++)this.printChar(this.os.string.charAt(t,e))}printJsString(t){for(const e of t)this.printChar(e.charCodeAt(0))}printInt(t){for(const e of i(t))this.printChar(e)}backspace(){this.clearChar(),this.col-=1,this.col<0&&(this.col=0,this.row-=1,this.row<0&&(this.row=0)),this.drawCursor()}}const b=new Array(l.yJ).fill(0);class y{memory;os;color=!0;constructor(t,e){this.memory=t,this.os=e}clear(){this.memory.screen.loadBytes(b)}outOfBounds(t,e){return t<0||t>16*l.ZQ||e<0||e>l.KC}drawPixel(t,e){if(this.outOfBounds(t,e))return void this.os.sys.error(7);const s=32*e+Math.floor(t/16);let n=this.memory.screen.get(s);this.color?n|=1<<t%16:n&=~(1<<t%16),this.memory.screen.set(s,n)}drawLine(t,e,s,n){this.outOfBounds(t,e)||this.outOfBounds(s,n)?this.os.sys.error(8):t==s?this.drawVerticalLine(t,e,n):e==n?this.drawHorizontalLine(e,t,s):this.drawGeneralLine(t,e,s,n)}drawHorizontalLine(t,e,s){for(let n=Math.min(e,s);n<=Math.max(e,s);n++)this.drawPixel(n,t)}drawVerticalLine(t,e,s){for(let n=Math.min(e,s);n<=Math.max(e,s);n++)this.drawPixel(t,n)}drawGeneralLine(t,e,s,n){const r=Math.abs(s-t),i=Math.abs(n-e);let o=0,a=0,c=0;const l=t<s?1:-1,h=e<n?1:-1;for(;o<=r&&a<=i;)this.drawPixel(t+l*o,e+h*a),c<0?(o+=1,c+=i):(a+=1,c-=r)}drawRect(t,e,s,n){if(this.outOfBounds(t,e)||this.outOfBounds(s,n))this.os.sys.error(9);else for(let r=t;r<=s;r++)for(let t=e;t<=n;t++)this.drawPixel(r,t)}drawCircle(t,e,s){if(this.outOfBounds(t,e))this.os.sys.error(12);else if(s>181)this.os.sys.error(13);else for(let n=-s;n<=s;n++)this.drawLine(t-Math.floor(Math.sqrt(s*s-n*n)),e+n,t+Math.floor(Math.sqrt(s*s-n*n)),e+n)}}class v{os;_blocked=!1;_released=!1;_returnValue=0;_halted=!1;_exitCode=0;constructor(t){this.os=t}get blocked(){return this._blocked}get released(){return this._released}get halted(){return this._halted}get exitCode(){return this._exitCode}block(){this._blocked=!0}release(t){this._blocked=!1,this._returnValue=t??0,this._released=!0}readReturnValue(){return this._released=!1,this._returnValue}wait(t){t<=0?this.error(1):(this.block(),setTimeout((()=>{this.release()}),t))}halt(){this._halted=!0,this._exitCode=0}error(t){this.os.output.printJsString(`ERR${t}`),this._halted=!0,this._exitCode=t}}class w{vmMemory;screen;memory;string;output;keyboard;sys;constructor(t){this.vmMemory=t,this.screen=new y(this.vmMemory,this),this.memory=new d(this.vmMemory,this),this.string=new o(this.vmMemory,this),this.output=new f(this),this.keyboard=new u(this.vmMemory,this),this.sys=new v(this)}dispose(){this.keyboard.dispose()}}const S="__implicit",k="__END",x={name:"Sys.init",labels:{},nVars:0,opBase:0,operations:[{op:"function",name:"Sys.init",nVars:0},{op:"call",name:"Main.main",nArgs:0},{op:"call",name:"Sys.halt",nArgs:0}]};class A{memory=new h;os=new w(this.memory);entry="";functionMap={};executionStack=[];functions=[];program=[];staticCount=0;statics={};returnLine=void 0;registerStatic(t,e){const s=t.split(".")[0],n=this.statics[s]??[];this.statics[s]=n;const r=n[e]??this.staticCount++;return n[e]=r,r}registerStatics(){for(const t of Object.values(this.functionMap))for(const e of t.operations)"push"!==e.op&&"pop"!==e.op||"static"!==e?.segment||(e.offset=this.registerStatic(t.name,e.offset))}static validateFile(t){for(const e of t.instructions)if("function"==e.op){const s=e.name.split(".");if(2!=s.length)return(0,n.UG)(new Error(`Illegal subroutine name ${e.name} (Expected <className>.<SubroutineName>)`));if(s[0]!=t.name)return(0,n.UG)(new Error(`File name ${t.name} doesn't match class name ${s[0]} (at ${e.name})`))}return(0,n.Ok)()}static validateFiles(t){const e=new Set;for(const s of t){if(e.has(s.name))return(0,n.UG)(new Error(`File ${s.name} already exists`));const t=this.validateFile(s);if((0,n.dZ)(t))return t;e.add(s.name)}return(0,n.Ok)()}validateStackInstructions(){for(const t of Object.values(this.functionMap))for(const e of t.operations)if("pop"==e.op||"push"==e.op){const t=this.memory.baseSegment(e.segment,e.offset);if((0,n.dZ)(t))return t}return(0,n.Ok)()}static validateFunctions(t){const e=new Set,s=[];for(const r of t){if("function"==r.op){if(r.nVars<0||r.nVars>32767)return(0,n.UG)(new Error(`Illegal number of local variables ${r.nVars} (Expected 0-32767)`));e.add(r.name)}if("call"==r.op){if(r.nArgs<0||r.nArgs>32767)return(0,n.UG)(new Error(`Illegal number of arguments ${r.nArgs} (Expected 0-32767)`));s.push(r)}}for(const r of s)if(!e.has(r.name)){if(!c[r.name])return(0,n.UG)(new Error(`Undefined function ${r}`));if(c[r.name].nArgs!=r.nArgs)return(0,n.UG)(new Error(`OS function ${r.name} expects ${c[r.name].nArgs} arguments, not ${r.nArgs}`))}return(0,n.Ok)()}static buildFromFiles(t){let e=this.validateFiles(t);if((0,n.dZ)(e))return e;const s=t.map((t=>t.instructions)).reduce(((t,e)=>t.concat(e)));if(e=this.validateFunctions(s),(0,n.dZ)(e))return e;const r=new A,i=r.load(s);return(0,n.dZ)(i)?i:r.bootstrap()}static build(t){const e=new A,s=e.load(t);return(0,n.dZ)(s)?s:e.bootstrap()}static buildFunction(t,e){if("function"!==t[e].op)return(0,n.UG)(Error("Only call buildFunction at the initial Function instruction"));const{name:s,nVars:r}=t[e],i={name:s,nVars:r,labels:{},operations:[{op:"function",name:s,nVars:r}],opBase:0};e+=1;t:for(;e<t.length;){switch(t[e].op){case"function":break t;case"add":case"sub":case"neg":case"and":case"or":case"not":case"gt":case"lt":case"eq":i.operations.push({op:t[e].op});break;case"push":case"pop":i.operations.push({op:t[e].op,segment:t[e].segment,offset:t[e].offset});break;case"call":i.operations.push({op:"call",name:t[e].name,nArgs:t[e].nArgs});break;case"goto":case"if-goto":i.operations.push({op:t[e].op,label:t[e].label});break;case"label":{const{label:s}=t[e];if(i.labels[s])throw new Error(`Cannot redeclare label ${s} in function ${i.name} (previously at ${i.labels[s]})`);i.labels[s]=i.operations.length,i.operations.push({op:"label",label:s});break}case"return":i.operations.push({op:"return"})}e+=1}return i.name===S&&(i.labels[k]=i.operations.length,i.operations.push({op:"label",label:k}),i.operations.push({op:"goto",label:k})),(0,n.Ok)([i,e])}get RAM(){return this.memory}get Keyboard(){return this.memory.keyboard}get Screen(){return this.memory.screen}get invocation(){const t=this.executionStack.at(-1);return void 0===t?{frameBase:256,function:S,nArgs:0,opPtr:0}:t}get currentFunction(){const t=this.functionMap[this.invocation.function];if(void 0!==t)return t}get operation(){if(this.currentFunction){if(this.invocation.opPtr>this.currentFunction.operations.length)throw new Error(`Current operation step beyond end of function operations (${this.invocation.opPtr} > ${this.currentFunction.operations.length})`);return this.currentFunction.operations[this.invocation.opPtr]}}load(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e&&(this.functionMap={},this.statics={},this.staticCount=0),"function"!==t[0]?.op&&t.unshift({op:"function",name:S,nVars:0});let s=0;for(;s<t.length;){const e=A.buildFunction(t,s);if((0,n.dZ)(e))return(0,n.UG)(new Error("Failed to build VM",{cause:(0,n.UG)(e)}));const[r,i]=(0,n.Wg)(e);if(this.functionMap[r.name]&&this.memory.strict&&r.name!==S&&r.name!==x.name)return(0,n.UG)(new Error(`VM Already has a function named ${r.name}`));this.functionMap[r.name]=r,s=i}const r=this.validateStackInstructions();return(0,n.dZ)(r)?r:(this.registerStatics(),e&&this.bootstrap(),(0,n.Ok)(this))}bootstrap(){if(!this.functionMap[x.name]&&this.functionMap["Main.main"]&&(this.functionMap[x.name]=x),this.functionMap[x.name])this.entry=x.name;else if(this.functionMap[S])this.entry=S;else{const t=Object.keys(this.functionMap);1===t.length&&(this.entry=t[0])}if(this.functionMap[S]&&this.functionMap[x.name])return(0,n.UG)(new Error("Cannot use both bootstrap and an implicit function"));if(""===this.entry)return(0,n.UG)(Error("Could not determine an entry point for VM"));this.functions=Object.values(this.functionMap),this.functions.sort(((t,e)=>t.name===this.entry?-1:e.name===this.entry?1:0));let t=0;return this.program=this.functions.reduce(((e,s)=>(s.opBase=t,t+=s.operations.length,e.concat(s.operations))),[]),this.reset(),(0,n.Ok)(this)}reset(){this.executionStack=[{function:this.entry,opPtr:1,frameBase:256,nArgs:0}],this.memory.reset(),this.memory.ARG=256,this.memory.LCL=256,this.memory.SP=256+this.functionMap[this.entry].nVars,this.os.dispose(),this.os=new w(this.memory)}validateStackOp(t){if("argument"==t.segment&&t.offset>=this.invocation.nArgs)throw new Error("Argument offset out of bounds");if("local"==t.segment&&t.offset>=this.functionMap[this.invocation.function]?.nVars)throw new Error("Local offset out of bounds")}step(){if(this.os.sys.halted)return this.os.sys.exitCode;if(this.os.sys.blocked)return;if(this.os.sys.released&&"call"==this.operation?.op){const t=this.os.sys.readReturnValue(),e=this.memory.SP-this.operation.nArgs;return this.memory.set(e,t),this.memory.SP=e+1,void(this.invocation.opPtr+=1)}if(!this.operation&&void 0!=this.returnLine)return;const t=this.operation??{op:"return"};switch(t.op){case"push":{this.validateStackOp(t);const e=this.memory.getSegment(t.segment,t.offset);this.memory.push(e);break}case"pop":{this.validateStackOp(t);const e=this.memory.pop();this.memory.setSegment(t.segment,t.offset,e);break}case"add":this.memory.binOp(((t,e)=>t+e));break;case"sub":this.memory.binOp(((t,e)=>t-e));break;case"neg":this.memory.unOp((t=>-t));break;case"and":this.memory.binOp(((t,e)=>t&e));break;case"or":this.memory.binOp(((t,e)=>t|e));break;case"not":this.memory.unOp((t=>~t));break;case"eq":this.memory.comp(((t,e)=>t===e));break;case"lt":this.memory.comp(((t,e)=>t<e));break;case"gt":this.memory.comp(((t,e)=>t>e));break;case"goto":this.goto(t.label);break;case"if-goto":0!=this.memory.pop()&&this.goto(t.label);break;case"call":{const e=t.name;if(this.functionMap[e]){const s=this.memory.pushFrame(this.invocation.opPtr,t.nArgs,this.functionMap[e].nVars);this.executionStack.push({function:e,opPtr:0,nArgs:t.nArgs,frameBase:s})}else if(c[e]){const s=c[e].func(this.memory,this.os);if(this.os.sys.blocked)return;const n=this.memory.SP-t.nArgs;this.memory.set(n,s),this.memory.SP=n+1}break}case"return":{const t=this.derivedLine();this.executionStack.pop();const e=this.memory.popFrame();if(this.invocation.opPtr=e,0===this.executionStack.length)return this.returnLine=t,0;break}}this.invocation.opPtr+=1}goto(t){if(this.currentFunction){if(void 0===this.currentFunction.labels[t])throw new Error(`Attempting GOTO to unknown label ${t} in ${this.currentFunction.name}`);this.invocation.opPtr=this.currentFunction.labels[t]}}write(t){t.map((t=>{let[e,s]=t;this.memory.set(e,s)}))}read(t){return t.map((t=>this.memory.get(t)))}vmStack(){return this.executionStack.map(((t,e)=>{const s=this.executionStack[e+1],n=s?s.frameBase-s.nArgs:this.memory.get(0);return this.makeFrame(t,n)}))}makeFrame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.invocation,e=arguments.length>1?arguments[1]:void 0;const s=this.functionMap[t.function];if(s.name===this.entry){const e=256+s.nVars,n=this.executionStack[1],r=n?n.frameBase-n.nArgs:this.memory.get(0),{ARG:i,LCL:o,THAT:a,THIS:c}=this.memory;return{fn:s,args:{base:i,count:t.nArgs,values:[...this.memory.map(((t,e)=>e),i,i+t.nArgs)]},locals:{base:o,count:s.nVars,values:[...this.memory.map(((t,e)=>e),o,o+s.nVars)]},stack:{base:256,count:r-e,values:[...this.memory.map(((t,e)=>e),e,r)]},this:{base:a,count:0,values:[]},that:{base:c,count:0,values:[]},frame:{ARG:i,LCL:o,RET:65535,THAT:a,THIS:c}}}const n=this.memory.getFrame(t.frameBase,t.nArgs,s.nVars,0,0,e);return n.fn=s,n}derivedLine(){return this.currentFunction?this.currentFunction.opBase+this.invocation.opPtr:this.returnLine??0}writeDebug(){const t=this.derivedLine(),e=Math.max(t-5,0),s=Math.min(t+3,this.program.length),n=this.program.slice(e,s).map(((s,n)=>`${n===t-e?"->":"  "} ${function(t){switch(t.op){case"add":case"and":case"sub":case"eq":case"gt":case"lt":case"neg":case"not":case"or":case"return":return`  ${t.op}`;case"goto":return`  ${t.op}    ${t.label}`;case"if-goto":return`  ${t.op} ${t.label}`;case"label":return`${t.op}     ${t.label}`;case"call":return`  ${t.op}    ${t.name} ${t.nArgs}`;case"function":return`${t.op}  ${t.name} ${t.nVars}`;case"pop":return`  ${t.op}     ${t.segment} ${t.offset}`;case"push":return`  ${t.op}    ${t.segment} ${t.offset}`}}(s)}`)).join("\n"),r=this.vmStack().at(-1);return r?n+"\n\n"+function(t){return[`Frame: ${t.fn?.name??"Unknown Fn"} ARG:${t.frame.ARG} LCL:${t.frame.LCL}`,`Args: ${C(t.args)}`,`Lcls: ${C(t.locals)}`,`Stck: ${C(t.stack)}`].join("\n")}(r):n}}function C(t){return`[${t.base};${t.count}][${t.values.join(", ")}]`}}}]);